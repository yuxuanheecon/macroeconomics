<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Macro Defender 2.0 | Earth Macro</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    /* ====== åŸºç¡€æ ·å¼ ====== */
    body {
      margin: 0; overflow: hidden; background: #050505; color: white; font-family: 'JetBrains Mono', monospace;
      user-select: none;
    }
    
    /* CRT æ‰«æçº¿ç‰¹æ•ˆ */
    .scanlines {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 50;
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
      background-size: 100% 4px;
    }

    /* ====== UI å±‚ ====== */
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
      display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box;
      z-index: 10;
    }

    /* é¡¶éƒ¨ HUD */
    .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .stat-box { text-shadow: 0 0 10px currentColor; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 4px; border: 1px solid #333; }
    .label { font-size: 0.7rem; color: #888; display: block; letter-spacing: 1px; margin-bottom: 2px; }
    .value { font-family: 'Share Tech Mono'; font-size: 1.5rem; font-weight: bold; }
    
    #score-val { color: #00ff9d; }
    #health-val { color: #00f3ff; }
    #cycle-val { color: #ffee00; }

    /* åº•éƒ¨æŠ€èƒ½æ  HUD */
    .hud-bottom { display: flex; justify-content: center; align-items: flex-end; gap: 20px; position: relative; }
    
    .skill-bar { display: flex; gap: 10px; }
    .skill-slot {
      width: 60px; height: 60px; border: 2px solid #444; background: rgba(0,0,0,0.7);
      position: relative; display: flex; justify-content: center; align-items: center;
      font-size: 1.5rem; color: #555; border-radius: 8px; transition: all 0.1s;
    }
    .skill-slot.ready { border-color: var(--color); color: var(--color); box-shadow: 0 0 15px var(--color); }
    .skill-slot.cooldown { border-color: #333; color: #333; }
    
    .skill-key { position: absolute; top: -10px; left: -5px; background: #000; border: 1px solid #555; color: #fff; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
    .cooldown-overlay {
      position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8);
      height: 0%; transition: height 0.1s linear;
    }
    .shop-hint {
      position: absolute; right: 20px; bottom: 20px; 
      color: #ffee00; border: 1px solid #ffee00; padding: 10px; 
      font-size: 0.8rem; animation: pulse 2s infinite;
    }
    @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

    /* ====== æ¨¡æ€çª—å£é€šç”¨æ ·å¼ ====== */
    .modal {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(5,5,10,0.95); display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 100; pointer-events: auto;
    }
    .hidden { display: none !important; }

    h1 { font-family: 'Share Tech Mono'; font-size: 3rem; color: #00f3ff; text-shadow: 0 0 30px #00f3ff; margin: 0 0 20px 0; }
    h2 { font-size: 1.5rem; color: #ccc; margin-bottom: 20px; }
    p { color: #888; margin-bottom: 20px; font-size: 1rem; max-width: 600px; line-height: 1.6; }

    .btn {
      background: transparent; border: 2px solid #00ff9d; color: #00ff9d;
      padding: 12px 30px; font-size: 1.2rem; font-family: 'Share Tech Mono';
      cursor: pointer; box-shadow: 0 0 20px rgba(0,255,157,0.2); transition: all 0.2s;
      margin: 10px;
    }
    .btn:hover { background: #00ff9d; color: black; box-shadow: 0 0 50px rgba(0,255,157,0.6); transform: scale(1.05); }
    .btn-red { border-color: #ff0055; color: #ff0055; box-shadow: 0 0 20px rgba(255,0,85,0.2); }
    .btn-red:hover { background: #ff0055; color: white; box-shadow: 0 0 50px rgba(255,0,85,0.6); }

    /* é€‰äººç•Œé¢ */
    .char-container { display: flex; gap: 20px; margin-bottom: 30px; }
    .char-card {
      border: 1px solid #444; padding: 20px; width: 220px; background: rgba(255,255,255,0.05);
      cursor: pointer; transition: all 0.3s; text-align: left;
    }
    .char-card:hover, .char-card.selected { border-color: #ffee00; background: rgba(255,238,0,0.1); box-shadow: 0 0 30px rgba(255,238,0,0.2); transform: translateY(-5px); }
    .char-name { font-size: 1.2rem; color: #fff; margin-bottom: 10px; font-weight: bold; }
    .char-title { color: #888; font-size: 0.8rem; margin-bottom: 15px; font-style: italic; }
    .char-stats { font-size: 0.8rem; color: #aaa; line-height: 1.8; }
    .stat-bar { height: 4px; background: #333; margin-top: 5px; width: 100%; position: relative; }
    .stat-fill { height: 100%; background: #00f3ff; }

    /* éš¾åº¦é€‰æ‹© */
    .diff-select { display: flex; gap: 10px; margin-bottom: 30px; }
    .diff-btn { padding: 8px 20px; border: 1px solid #555; color: #555; cursor: pointer; }
    .diff-btn.active { border-color: #00f3ff; color: #00f3ff; box-shadow: 0 0 10px #00f3ff; background: rgba(0, 243, 255, 0.1); }

    /* å•†åº—ç•Œé¢ */
    #shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 600px; width: 100%; }
    .shop-item { border: 1px solid #333; padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5); }
    .shop-info b { display: block; color: #00f3ff; margin-bottom: 5px; }
    .shop-info span { font-size: 0.8rem; color: #888; }
    .shop-btn { font-size: 0.9rem; padding: 5px 15px; }

  </style>
</head>
<body>

  <canvas id="gameCanvas"></canvas>
  <div class="scanlines"></div>

  <!-- HUD -->
  <div id="ui-layer">
    <div class="hud-top">
      <div class="stat-box">
        <span class="label">GDP (MONEY)</span>
        <div class="value" id="score-val">0</div>
      </div>
      <div class="stat-box">
        <span class="label">MACRO CYCLE</span>
        <div class="value" id="cycle-val">LOADING...</div>
      </div>
      <div class="stat-box">
        <span class="label">LIQUIDITY (HP)</span>
        <div class="value" id="health-val">100%</div>
      </div>
    </div>

    <div class="hud-bottom">
      <div class="skill-bar">
        <div class="skill-slot" id="skill-q" style="--color: #00f3ff">
          <span class="skill-key">Q</span>
          <span class="icon">ğŸ”«</span>
          <div class="cooldown-overlay"></div>
        </div>
        <div class="skill-slot" id="skill-w" style="--color: #00ff9d">
          <span class="skill-key">W</span>
          <span class="icon">ğŸ›¡ï¸</span>
          <div class="cooldown-overlay"></div>
        </div>
        <div class="skill-slot" id="skill-e" style="--color: #ffee00">
          <span class="skill-key">E</span>
          <span class="icon">âš¡</span>
          <div class="cooldown-overlay"></div>
        </div>
        <div class="skill-slot" id="skill-r" style="--color: #ff0055">
          <span class="skill-key">R</span>
          <span class="icon">â˜¢ï¸</span>
          <div class="cooldown-overlay"></div>
        </div>
      </div>
      <div class="shop-hint">PRESS [B] FOR SUPPLY</div>
    </div>
  </div>

  <!-- 1. å¼€å§‹/é€‰äººç•Œé¢ -->
  <div id="start-screen" class="modal">
    <h1>MACRO DEFENDER 2.0</h1>
    <p style="text-align:center">
      <strong>æ“ä½œæŒ‡å—ï¼š</strong><br>
      ç§»åŠ¨: [â†‘ â†“ â† â†’] | æŠ€èƒ½: [Q W E R]<br>
      å•†åº—: [B] | æš‚åœ: [P] / [ESC]
    </p>

    <div class="diff-select">
      <div class="diff-btn active" onclick="setDifficulty(1, this)">EASY (æ–°æ‰‹)</div>
      <div class="diff-btn" onclick="setDifficulty(2, this)">NORMAL (æ™®é€š)</div>
      <div class="diff-btn" onclick="setDifficulty(3, this)">HARD (å¤®è¡Œè¡Œé•¿)</div>
    </div>

    <div class="char-container">
      <!-- Character 1 -->
      <div class="char-card selected" onclick="selectChar('powell', this)">
        <div class="char-name">é²å¨å°” (Powell)</div>
        <div class="char-title">"Inflation is Transitory"</div>
        <div class="char-stats">
          <div>HP (æµåŠ¨æ€§): <div class="stat-bar"><div class="stat-fill" style="width:90%"></div></div></div>
          <div>DMG (åŠ æ¯): <div class="stat-bar"><div class="stat-fill" style="width:60%"></div></div></div>
          <div>SPD (ååº”): <div class="stat-bar"><div class="stat-fill" style="width:50%"></div></div></div>
          <div style="margin-top:10px; color:#00f3ff">ç‰¹æŠ€: æ— é™å°é’ (Qå°„é€Ÿæå¿«)</div>
        </div>
      </div>
      <!-- Character 2 -->
      <div class="char-card" onclick="selectChar('trump', this)">
        <div class="char-name">ç‰¹æœ—æ™® (Trump)</div>
        <div class="char-title">"Make Market Great Again"</div>
        <div class="char-stats">
          <div>HP (æµåŠ¨æ€§): <div class="stat-bar"><div class="stat-fill" style="width:40%"></div></div></div>
          <div>DMG (å…³ç¨): <div class="stat-bar"><div class="stat-fill" style="width:100%"></div></div></div>
          <div>SPD (æ¨ç‰¹): <div class="stat-bar"><div class="stat-fill" style="width:90%"></div></div></div>
          <div style="margin-top:10px; color:#ff0055">ç‰¹æŠ€: è´¸æ˜“å£å’ (WæŠ¤ç›¾åä¼¤)</div>
        </div>
      </div>
      <!-- Character 3 -->
      <div class="char-card" onclick="selectChar('xi', this)">
        <div class="char-name">å®è§‚æŒèˆµäºº (Big Boss)</div>
        <div class="char-title">"Common Prosperity"</div>
        <div class="char-stats">
          <div>HP (å®šåŠ›): <div class="stat-bar"><div class="stat-fill" style="width:100%"></div></div></div>
          <div>DMG (è°ƒæ§): <div class="stat-bar"><div class="stat-fill" style="width:70%"></div></div></div>
          <div>SPD (ç¨³å¥): <div class="stat-bar"><div class="stat-fill" style="width:40%"></div></div></div>
          <div style="margin-top:10px; color:#ffee00">ç‰¹æŠ€: é€†å‘¨æœŸè°ƒèŠ‚ (å…¨èƒ½å‡è¡¡)</div>
        </div>
      </div>
    </div>
    
    <button class="btn" onclick="gameInit()">START DEFENSE</button>
  </div>

  <!-- 2. æš‚åœèœå• -->
  <div id="pause-menu" class="modal hidden">
    <h1>SYSTEM PAUSED</h1>
    <button class="btn" onclick="togglePause()">RESUME GAME</button>
    <button class="btn btn-red" onclick="location.reload()">ABORT MISSION</button>
  </div>

  <!-- 3. å•†åº—ç•Œé¢ -->
  <div id="shop-menu" class="modal hidden">
    <h1>GDP STORE</h1>
    <p>Current GDP: <span id="shop-gdp" style="color:#00ff9d">$0</span></p>
    
    <div id="shop-grid">
      <div class="shop-item">
        <div class="shop-info"><b>Rate Hike (DMG)</b><span>æå‡åŸºç¡€ä¼¤å®³</span></div>
        <button class="btn shop-btn" onclick="buyUpgrade('damage')">$1000</button>
      </div>
      <div class="shop-item">
        <div class="shop-info"><b>Velocity (SPD)</b><span>æå‡ç§»åŠ¨é€Ÿåº¦</span></div>
        <button class="btn shop-btn" onclick="buyUpgrade('speed')">$800</button>
      </div>
      <div class="shop-item">
        <div class="shop-info"><b>Printing (RATE)</b><span>æå‡å°„å‡»é¢‘ç‡</span></div>
        <button class="btn shop-btn" onclick="buyUpgrade('rate')">$1500</button>
      </div>
      <div class="shop-item">
        <div class="shop-info"><b>Reserves (HP)</b><span>å›å¤ 30% æµåŠ¨æ€§</span></div>
        <button class="btn shop-btn" onclick="buyUpgrade('heal')">$500</button>
      </div>
    </div>

    <button class="btn" style="margin-top:30px" onclick="toggleShop()">CLOSE SHOP [B]</button>
  </div>

  <!-- 4. æ¸¸æˆç»“æŸ -->
  <div id="game-over" class="modal hidden">
    <h1 style="color:#ff0055">MARKET CRASH</h1>
    <p>Liquidity Dried Up. Final GDP: <span id="final-score" style="color:white; font-weight:bold;">0</span></p>
    <button class="btn" onclick="location.reload()">REBOOT SYSTEM</button>
  </div>

  <script>
    /* ====== æ ¸å¿ƒå¼•æ“ ====== */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    
    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // æ¸¸æˆçŠ¶æ€
    const STATE = {
      menu: 0, playing: 1, paused: 2, shop: 3, over: 4
    };
    let currentState = STATE.menu;
    
    // ç©å®¶é…ç½®
    let difficultyMultiplier = 1; // 1, 1.5, 2
    let selectedChar = 'powell';
    let score = 0; // GDP
    let frame = 0;
    
    // è§’è‰²å±æ€§æ¨¡æ¿
    const CHAR_STATS = {
      'powell': { hp: 150, speed: 5, dmg: 1, rate: 5, color: '#00f3ff', qColor: '#00f3ff', rName: 'QE Flood' },
      'trump':  { hp: 80, speed: 8, dmg: 2, rate: 8, color: '#ff0055', qColor: '#ffaa00', rName: 'Trade War' },
      'xi':     { hp: 200, speed: 4, dmg: 1.2, rate: 6, color: '#ffee00', qColor: '#ff0000', rName: 'Reform' }
    };

    // å®ä½“æ± 
    let player = { x:0, y:0, r:15, hp:100, maxHp:100, speed:5, dmg:1, rate:5, vx:0, vy:0, cd:{q:0, w:0, e:0, r:0} };
    let bullets = [];
    let enemies = [];
    let particles = [];
    let texts = []; // æµ®åŠ¨æ–‡å­—

    // å®è§‚å‘¨æœŸ
    const CYCLES = ['RECOVERY', 'OVERHEAT', 'STAGFLATION', 'RECESSION'];
    let cycleIdx = 0;
    let cycleTimer = 0;

    /* ====== è¾“å…¥å¤„ç† (WASD -> Arrow Keys) ====== */
    let keys = {};
    window.addEventListener('keydown', e => {
      keys[e.key] = true;
      if (currentState === STATE.playing) {
        if(e.key.toLowerCase() === 'q') useSkill('q');
        if(e.key.toLowerCase() === 'w') useSkill('w');
        if(e.key.toLowerCase() === 'e') useSkill('e');
        if(e.key.toLowerCase() === 'r') useSkill('r');
        if(e.key.toLowerCase() === 'b') toggleShop();
        if(e.key === 'Escape' || e.key.toLowerCase() === 'p') togglePause();
      } else if (currentState === STATE.shop && e.key.toLowerCase() === 'b') {
        toggleShop();
      } else if (currentState === STATE.paused && (e.key === 'Escape' || e.key.toLowerCase() === 'p')) {
        togglePause();
      }
    });
    window.addEventListener('keyup', e => keys[e.key] = false);

    /* ====== ç•Œé¢é€»è¾‘ ====== */
    function setDifficulty(val, el) {
      difficultyMultiplier = val;
      document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
      el.classList.add('active');
    }

    function selectChar(char, el) {
      selectedChar = char;
      document.querySelectorAll('.char-card').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
    }

    function gameInit() {
      // åº”ç”¨è§’è‰²å±æ€§
      const template = CHAR_STATS[selectedChar];
      player.maxHp = template.hp;
      player.hp = template.hp;
      player.speed = template.speed;
      player.dmg = template.dmg;
      player.rate = template.rate;
      player.color = template.color;
      player.x = width/2;
      player.y = height/2;
      
      score = 1000; // åˆå§‹èµ„é‡‘æ–¹ä¾¿æµ‹è¯•å•†åº—

      document.getElementById('start-screen').classList.add('hidden');
      currentState = STATE.playing;
      loop();
    }

    function togglePause() {
      if(currentState === STATE.playing) {
        currentState = STATE.paused;
        document.getElementById('pause-menu').classList.remove('hidden');
      } else if(currentState === STATE.paused) {
        currentState = STATE.playing;
        document.getElementById('pause-menu').classList.add('hidden');
        loop();
      }
    }

    function toggleShop() {
      if(currentState === STATE.playing) {
        currentState = STATE.shop;
        document.getElementById('shop-gdp').innerText = '$' + Math.floor(score);
        document.getElementById('shop-menu').classList.remove('hidden');
      } else if(currentState === STATE.shop) {
        currentState = STATE.playing;
        document.getElementById('shop-menu').classList.add('hidden');
        loop();
      }
    }

    function buyUpgrade(type) {
      let cost = 0;
      if(type === 'damage') { cost = 1000; if(score >= cost) { score-=cost; player.dmg *= 1.2; showMsg("DMG UP!"); } }
      if(type === 'speed') { cost = 800; if(score >= cost) { score-=cost; player.speed *= 1.1; showMsg("SPD UP!"); } }
      if(type === 'rate') { cost = 1500; if(score >= cost) { score-=cost; player.rate = Math.max(2, player.rate-1); showMsg("RATE UP!"); } } // å°„é€Ÿè¶Šå°è¶Šå¿«
      if(type === 'heal') { cost = 500; if(score >= cost) { score-=cost; player.hp = Math.min(player.maxHp, player.hp + player.maxHp*0.3); showMsg("HEALED!"); } }
      
      document.getElementById('shop-gdp').innerText = '$' + Math.floor(score);
      document.getElementById('score-val').innerText = Math.floor(score);
    }

    function showMsg(text) {
       // ç®€å•åœ¨æ§åˆ¶å°æˆ– alerts ä¸­åé¦ˆï¼Œæˆ–è€…åšä¸€ä¸ªæµ®åŠ¨æ–‡å­—
       // è¿™é‡Œæˆ‘ä»¬åªæ˜¯ä¸ºäº†é€»è¾‘å®Œæ•´
    }

    /* ====== æ¸¸æˆä¸»å¾ªç¯ ====== */
    function loop() {
      if(currentState !== STATE.playing) return;
      requestAnimationFrame(loop);

      update();
      render();
      frame++;
    }

    function update() {
      // 1. å‘¨æœŸè½®åŠ¨
      cycleTimer++;
      if(cycleTimer > 600) {
        cycleTimer = 0;
        cycleIdx = (cycleIdx + 1) % CYCLES.length;
        document.getElementById('cycle-val').innerText = CYCLES[cycleIdx];
      }

      // 2. ç©å®¶ç§»åŠ¨ (Arrow Keys)
      let ax = 0, ay = 0;
      if(keys['ArrowUp']) ay = -1;
      if(keys['ArrowDown']) ay = 1;
      if(keys['ArrowLeft']) ax = -1;
      if(keys['ArrowRight']) ax = 1;
      
      // ç®€å•çš„æƒ¯æ€§ç‰©ç†
      player.vx += ax * 0.8;
      player.vy += ay * 0.8;
      player.vx *= 0.9;
      player.vy *= 0.9;
      player.x += player.vx * player.speed * 0.3; // ç³»æ•°è°ƒæ•´æ‰‹æ„Ÿ
      player.y += player.vy * player.speed * 0.3;
      
      // è¾¹ç•Œæ£€æŸ¥
      if(player.x < 0) player.x = 0; if(player.x > width) player.x = width;
      if(player.y < 0) player.y = 0; if(player.y > height) player.y = height;

      // 3. æŠ€èƒ½å†·å´
      for(let k in player.cd) { if(player.cd[k] > 0) player.cd[k]--; }
      updateSkillUI();

      // 4. è‡ªåŠ¨æ™®æ”» (Q skill logic integrated here or manual? User asked for skills qwer)
      // è®¾å®š Q ä¸ºæ™®æ”»ï¼Œä½†ä¹Ÿå¯ä»¥é•¿æŒ‰ã€‚
      // å¦‚æœ Q å†·å´å¥½äº†å¹¶ä¸”æŒ‰ä¸‹ Q
      if(keys['q'] && player.cd.q <= 0) useSkill('q');

      // 5. å­å¼¹é€»è¾‘
      for(let i=bullets.length-1; i>=0; i--) {
        let b = bullets[i];
        b.x += b.vx; b.y += b.vy;
        b.life--;
        if(b.life <= 0) bullets.splice(i, 1);
      }

      // 6. æ•Œäººç”Ÿæˆ (åŸºäºéš¾åº¦å’Œå‘¨æœŸ)
      let spawnRate = 60 / difficultyMultiplier;
      if(CYCLES[cycleIdx] === 'OVERHEAT') spawnRate /= 1.5;
      if(frame % Math.floor(spawnRate) === 0) spawnEnemy();

      // 7. ç¢°æ’æ£€æµ‹
      for(let i=enemies.length-1; i>=0; i--) {
        let e = enemies[i];
        // è¿½è¸ªç©å®¶
        let angle = Math.atan2(player.y - e.y, player.x - e.x);
        e.x += Math.cos(angle) * e.speed;
        e.y += Math.sin(angle) * e.speed;
        
        // æ’ç©å®¶
        let dist = Math.hypot(player.x - e.x, player.y - e.y);
        if(dist < player.r + e.r) {
          player.hp -= 10; // å—ä¼¤
          enemies.splice(i, 1);
          createParticles(e.x, e.y, '#ff0000');
          checkGameOver();
          continue;
        }

        // è¢«å­å¼¹æ‰“
        for(let j=bullets.length-1; j>=0; j--) {
          let b = bullets[j];
          let bDist = Math.hypot(b.x - e.x, b.y - e.y);
          if(bDist < e.r + 5) {
            e.hp -= b.dmg;
            bullets.splice(j, 1); // å­å¼¹æ¶ˆå¤±
            createParticles(e.x, e.y, '#fff', 2);
            if(e.hp <= 0) {
              score += e.value;
              enemies.splice(i, 1);
              createParticles(e.x, e.y, e.color, 10);
              spawnFloatingText(e.x, e.y, "+$"+e.value);
              break;
            }
          }
        }
      }

      // 8. ç²’å­æ›´æ–°
      updateParticles();
      
      // æ›´æ–° HUD
      document.getElementById('score-val').innerText = Math.floor(score);
      document.getElementById('health-val').innerText = Math.floor(player.hp) + "/" + player.maxHp;
    }

    /* ====== æŠ€èƒ½ç³»ç»Ÿ ====== */
    function useSkill(key) {
      if(player.cd[key] > 0) return;

      if(key === 'q') { // æ™®æ”»
        // å‘æœ€è¿‘çš„æ•Œäººæˆ–è€…å‰æ–¹å‘å°„
        // ç®€å•å¤„ç†ï¼šå‘æ­£ä¸Šæ–¹å‘å°„ï¼Œæˆ–è€…å¦‚æœæœ‰ç§»åŠ¨å‘ç§»åŠ¨æ–¹å‘
        let angle = -Math.PI/2; // é»˜è®¤å‘ä¸Š
        if(Math.abs(player.vx) > 0.1 || Math.abs(player.vy) > 0.1) {
          angle = Math.atan2(player.vy, player.vx);
        }
        
        // ç‰¹æœ—æ™®æ˜¯éœ°å¼¹ï¼Œå…¶ä»–äººå•å‘
        if(selectedChar === 'trump') {
           for(let i=-1; i<=1; i++) {
             bullets.push({ x:player.x, y:player.y, vx:Math.cos(angle+i*0.2)*15, vy:Math.sin(angle+i*0.2)*15, life:50, color:CHAR_STATS[selectedChar].qColor, dmg:player.dmg });
           }
        } else {
           bullets.push({ x:player.x, y:player.y, vx:Math.cos(angle)*15, vy:Math.sin(angle)*15, life:60, color:CHAR_STATS[selectedChar].qColor, dmg:player.dmg });
        }
        player.cd.q = player.rate; // å°„é€Ÿæ§åˆ¶
      }

      if(key === 'w') { // é˜²å¾¡/åŠŸèƒ½
        player.cd.w = 300; // 5ç§’å†·å´
        // ä¸´æ—¶æŠ¤ç›¾æ•ˆæœï¼šåŠ è¡€æˆ–è€…å‡»é€€æ•Œäºº
        enemies.forEach(e => {
           let dist = Math.hypot(player.x - e.x, player.y - e.y);
           if(dist < 200) {
             e.x -= (player.x - e.x) * 2; // å‡»é€€
             e.y -= (player.y - e.y) * 2;
           }
        });
        createShockwave(player.x, player.y, '#00ff9d');
      }

      if(key === 'e') { // ä½ç§»
        player.cd.e = 180; // 3ç§’
        let angle = Math.atan2(player.vy, player.vx) || -Math.PI/2;
        player.x += Math.cos(angle) * 150;
        player.y += Math.sin(angle) * 150;
        createParticles(player.x, player.y, '#ffee00', 5);
      }

      if(key === 'r') { // å¤§æ‹›
        if(score < 500) return; // å‡è®¾å¤§æ‹›æ¶ˆè€—é’±ï¼Ÿæˆ–è€…å•çº¯é•¿CD
        player.cd.r = 1200; // 20ç§’
        
        // æ¸…å±
        enemies.forEach(e => {
          e.hp = 0; // ä¼¤å®³æé«˜
          createParticles(e.x, e.y, e.color, 5);
        });
        enemies = [];
        createShockwave(width/2, height/2, '#ff0055', 100);
        spawnFloatingText(width/2, height/2, "STIMULUS!!!", "#ff0055");
      }
    }

    function updateSkillUI() {
      ['q','w','e','r'].forEach(k => {
        const slot = document.getElementById(`skill-${k}`);
        const cd = player.cd[k];
        const overlay = slot.querySelector('.cooldown-overlay');
        
        if(cd > 0) {
          slot.classList.remove('ready');
          slot.classList.add('cooldown');
          let max = (k==='q'?player.rate : (k==='w'?300 : (k==='e'?180 : 1200)));
          let pct = (cd / max) * 100;
          overlay.style.height = pct + '%';
        } else {
          slot.classList.add('ready');
          slot.classList.remove('cooldown');
          overlay.style.height = '0%';
        }
      });
    }

    /* ====== è¾…åŠ©ç³»ç»Ÿ ====== */
    function spawnEnemy() {
      // å±å¹•è¾¹ç¼˜ç”Ÿæˆ
      let edge = Math.floor(Math.random()*4); // 0:top, 1:right, 2:bottom, 3:left
      let x, y;
      if(edge===0) { x=Math.random()*width; y=-50; }
      if(edge===1) { x=width+50; y=Math.random()*height; }
      if(edge===2) { x=Math.random()*width; y=height+50; }
      if(edge===3) { x=-50; y=Math.random()*height; }

      let type = Math.random();
      let enemy = { x, y, r:15, hp:3, speed:2, color:'#ff0055', value:50 }; // Inflation
      
      if(type > 0.7) { // Bubble
        enemy.r = 25; enemy.hp = 8; enemy.speed = 1; enemy.color = '#00ff9d'; enemy.value = 150;
      } else if(type > 0.9) { // Bear
        enemy.r = 30; enemy.hp = 20; enemy.speed = 0.5; enemy.color = '#bd34fe'; enemy.value = 500;
      }
      
      enemies.push(enemy);
    }

    function createParticles(x, y, color, count=5) {
      for(let i=0; i<count; i++) {
        particles.push({
          x, y, color, 
          vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
          life: 30
        });
      }
    }

    function createShockwave(x, y, color, size=50) {
      // Visual only
      ctx.strokeStyle = color;
      ctx.lineWidth = 5;
      ctx.beginPath();
      ctx.arc(x, y, size, 0, Math.PI*2);
      ctx.stroke();
    }
    
    function spawnFloatingText(x, y, text, color='#fff') {
      texts.push({ x, y, text, color, life:60 });
    }

    function updateParticles() {
      for(let i=particles.length-1; i>=0; i--) {
        let p = particles[i];
        p.x += p.vx; p.y += p.vy; p.life--;
        if(p.life <= 0) particles.splice(i,1);
      }
      for(let i=texts.length-1; i>=0; i--) {
        let t = texts[i];
        t.y -= 1; t.life--;
        if(t.life <= 0) texts.splice(i,1);
      }
    }

    function render() {
      // Clear
      ctx.fillStyle = 'rgba(5, 5, 10, 0.3)'; // Trail
      ctx.fillRect(0, 0, width, height);

      // Player
      ctx.save();
      ctx.translate(player.x, player.y);
      // ç®€å•ç”»ä¸ªä¸‰è§’å½¢ä»£è¡¨ç©å®¶
      ctx.fillStyle = player.color;
      ctx.shadowBlur = 20; ctx.shadowColor = player.color;
      ctx.beginPath();
      ctx.moveTo(0, -20); ctx.lineTo(15, 15); ctx.lineTo(-15, 15);
      ctx.fill();
      ctx.restore();

      // Enemies
      enemies.forEach(e => {
        ctx.fillStyle = e.color;
        ctx.shadowBlur = 10; ctx.shadowColor = e.color;
        ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.fill();
      });

      // Bullets
      bullets.forEach(b => {
        ctx.fillStyle = b.color;
        ctx.shadowBlur = 5; ctx.shadowColor = b.color;
        ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill();
      });

      // Particles
      particles.forEach(p => {
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life/30;
        ctx.fillRect(p.x, p.y, 3, 3);
      });
      ctx.globalAlpha = 1;

      // Texts
      ctx.font = "bold 20px 'Share Tech Mono'";
      texts.forEach(t => {
        ctx.fillStyle = t.color;
        ctx.fillText(t.text, t.x, t.y);
      });
    }

    function checkGameOver() {
      if(player.hp <= 0) {
        currentState = STATE.over;
        document.getElementById('final-score').innerText = '$' + Math.floor(score);
        document.getElementById('game-over').classList.remove('hidden');
      }
    }

  </script>
</body>
</html>
