<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Macro Defender 4.8 | Earth Macro</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    /* ====== åŸºç¡€æ ·å¼ ====== */
    body {
      margin: 0; overflow: hidden; background: #050505; color: white; font-family: 'JetBrains Mono', monospace;
      user-select: none; cursor: crosshair;
    }
    
    .scanlines {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 50;
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
      background-size: 100% 4px;
    }

    /* ====== UI å±‚ ====== */
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
      display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box;
      z-index: 10;
    }

    /* é¡¶éƒ¨ HUD */
    .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .hud-left { display: flex; gap: 15px; }
    .hud-right { display: flex; gap: 10px; pointer-events: auto; }

    .stat-box { text-shadow: 0 0 10px currentColor; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 4px; border: 1px solid #333; }
    .label { font-size: 0.7rem; color: #888; display: block; letter-spacing: 1px; margin-bottom: 2px; }
    .value { font-family: 'Share Tech Mono'; font-size: 1.5rem; font-weight: bold; }
    #score-val { color: #00ff9d; }
    #health-val { color: #00f3ff; }
    #cycle-val { color: #ffee00; }

    .hud-btn {
      background: rgba(0,0,0,0.6); border: 1px solid #555; color: #aaa;
      padding: 8px 15px; cursor: pointer; font-family: 'JetBrains Mono'; font-size: 0.8rem;
      transition: all 0.2s; border-radius: 4px;
    }
    .hud-btn:hover { border-color: #fff; color: #fff; background: rgba(255,255,255,0.1); }

    /* åº•éƒ¨ HUD */
    .hud-bottom { display: flex; justify-content: center; align-items: flex-end; width: 100%; pointer-events: auto; position: relative; }
    
    .skill-panel { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    .skill-slot {
      width: 60px; height: 60px; border: 2px solid #444; background: rgba(0,0,0,0.7);
      position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center;
      border-radius: 8px; transition: all 0.1s; overflow: hidden; cursor: help;
    }
    .skill-slot.ready { border-color: var(--color); box-shadow: 0 0 10px var(--color); }
    .skill-slot.cooldown { border-color: #333; opacity: 0.6; filter: grayscale(1); }
    .skill-key { position: absolute; top: 2px; left: 2px; background: #000; border: 1px solid #555; color: #fff; font-size: 0.6rem; padding: 1px 4px; border-radius: 2px; }
    .skill-icon { font-size: 1.5rem; }
    .cooldown-overlay {
      position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8);
      height: 0%; transition: height 0.1s linear; display: flex; justify-content: center; align-items: center;
    }
    .cooldown-text { color: white; font-weight: bold; font-size: 1rem; font-family: 'Share Tech Mono'; }

    /* è£…å¤‡æ  */
    .inventory-panel { display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 5px; border: 1px solid #333; border-radius: 6px; margin-left: 20px; margin-bottom: 10px; }
    .item-slot {
      width: 40px; height: 40px; border: 1px solid #444; background: rgba(0,0,0,0.8);
      display: flex; justify-content: center; align-items: center; font-size: 1.2rem; position: relative;
      cursor: help;
    }
    .item-slot.empty { color: #222; font-size: 0.8rem; }

    .shop-hint { position: absolute; right: 20px; bottom: 20px; color: #ffee00; border: 1px solid #ffee00; padding: 8px; font-size: 0.8rem; animation: pulse 2s infinite; cursor: pointer; }
    @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

    /* Tooltip */
    #global-tooltip {
      position: absolute; top: 0; left: 0;
      background: rgba(10, 16, 24, 0.98); border: 1px solid var(--neon-blue);
      padding: 15px; border-radius: 8px; width: 280px; pointer-events: none;
      display: none; text-align: left; box-shadow: 0 0 30px rgba(0,0,0,0.8); z-index: 9999;
    }
    #tt-header { border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    #tt-title { color: #00f3ff; font-size: 0.9rem; font-family: 'Share Tech Mono'; margin: 0; font-weight: bold; }
    #tt-desc { color: #ccc; font-size: 0.8rem; line-height: 1.5; margin-bottom: 8px; }
    #tt-info { color: #888; font-size: 0.75rem; display: grid; grid-template-columns: 1fr; gap: 3px; }
    #tt-info span { color: #aaa; }
    #tt-info b { color: #fff; }

    /* ====== æ¨¡æ€çª—å£ ====== */
    .modal {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(5,5,8,0.98); display: flex; flex-direction: column;
      z-index: 100; pointer-events: auto; overflow-y: auto;
    }
    .modal.hidden { display: none !important; }
    
    .modal-content { width: 100%; max-width: 1200px; margin: 0 auto; padding: 30px; display: flex; flex-direction: column; height: 100%; align-items: center; }

    h1 { font-family: 'Share Tech Mono'; font-size: 2.5rem; color: #00f3ff; text-shadow: 0 0 20px #00f3ff; margin: 10px 0; }
    p.subtitle { color: #888; margin-bottom: 20px; font-size: 0.9rem; text-align: center; }

    .btn {
      background: transparent; border: 2px solid #00ff9d; color: #00ff9d;
      padding: 10px 25px; font-size: 1rem; font-family: 'Share Tech Mono';
      cursor: pointer; box-shadow: 0 0 15px rgba(0,255,157,0.2); transition: all 0.2s;
      margin: 5px;
    }
    .btn:hover { background: #00ff9d; color: black; box-shadow: 0 0 30px rgba(0,255,157,0.4); transform: scale(1.05); }
    .btn-red { border-color: #ff0055; color: #ff0055; }
    .btn-red:hover { background: #ff0055; color: white; }

    /* é€‰äººç•Œé¢ */
    .category-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; width: 100%; }
    .tab-btn {
      padding: 8px 20px; background: rgba(255,255,255,0.05); border: 1px solid #444; color: #888;
      cursor: pointer; font-family: 'JetBrains Mono'; font-size: 0.9rem; transition: all 0.2s;
      border-radius: 4px;
    }
    .tab-btn:hover { border-color: #fff; color: #fff; }
    .tab-btn.active { background: rgba(0, 243, 255, 0.15); border-color: #00f3ff; color: #00f3ff; font-weight: bold; }

    .char-selection-area { display: flex; gap: 20px; flex: 1; width: 100%; overflow: hidden; min-height: 400px; }
    .char-list { 
      flex: 2; display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 
      grid-auto-rows: 160px; gap: 10px; overflow-y: auto; align-content: start; padding-right: 5px;
      border: 1px solid #333; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;
    }
    .char-detail-panel { flex: 1; background: rgba(10,15,20,0.95); border: 1px solid #00f3ff; padding: 20px; overflow-y: auto; min-width: 320px; display:flex; flex-direction:column; align-items:center; border-radius: 12px; }
    
    .char-mini-card { background: rgba(255,255,255,0.05); border: 1px solid #444; padding: 10px; cursor: pointer; text-align: center; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; }
    .char-mini-card:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .char-mini-card.selected { border-color: #ffee00; background: rgba(255,238,0,0.15); box-shadow: inset 0 0 10px rgba(255,238,0,0.2); }
    .mini-avatar { width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px; background: #000; object-fit: cover; border: 2px solid #333; }
    .mini-name { font-size: 0.7rem; font-weight: bold; color: #eee; line-height: 1.2; }

    .stat-bar { height: 4px; background: #333; width: 100%; margin-top: 3px; border-radius: 2px; }
    .stat-fill { height: 100%; background: #00f3ff; border-radius: 2px; }
    
    .skill-list { width: 100%; text-align: left; font-size: 0.85rem; margin-top: 10px; flex: 1; }
    .skill-item { 
      margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 8px; 
      cursor: help; position: relative; transition: background 0.2s; padding: 5px; border-radius: 4px;
      display: flex; flex-direction: column;
    }
    .skill-item:hover { background: rgba(255,255,255,0.05); border-color: #00f3ff; }
    .skill-header { display: flex; align-items: center; gap: 8px; margin-bottom: 2px; }
    .skill-name-txt { color: #fff; font-weight: bold; font-size: 0.9rem; }
    .skill-desc-txt { font-size: 0.7rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .key-badge { display: inline-block; background: #333; color: #00f3ff; padding: 1px 4px; border-radius: 2px; font-size: 0.7rem; margin-right: 5px; font-weight: bold; font-family: monospace; border:1px solid #555; }

    /* å•†åº— */
    #shop-menu h1 { border-bottom: 2px solid #333; width: 100%; text-align: center; padding-bottom: 10px; }
    .shop-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; width: 100%; max-height: 60vh; overflow-y: auto; }
    .shop-item-card { background: rgba(255,255,255,0.05); border: 1px solid #444; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center; transition: 0.2s; cursor: pointer; position: relative; }
    .shop-item-card:hover { border-color: #00f3ff; transform: translateY(-3px); background: rgba(255,255,255,0.08); }
    .shop-item-type { position: absolute; top: 5px; right: 5px; font-size: 0.6rem; color: #666; text-transform: uppercase; }
    
    .floating-text { position: absolute; font-weight: bold; pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 20; text-shadow: 1px 1px 2px black; font-size: 0.9rem; }
    @keyframes floatUp { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-30px); opacity: 0; } }
    
    /* ä¿®å¤è§„åˆ™é¡µ */
    .rules-box { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; width: 100%; margin-bottom: 20px; line-height: 1.6; }
    .key-tag { background: #333; padding: 2px 5px; border-radius: 3px; color: #fff; font-family: monospace; }
    .diff-select { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
    .diff-btn { padding: 8px 20px; border: 1px solid #555; cursor: pointer; color: #888; }
    .diff-btn.active { border-color: #00f3ff; color: #00f3ff; font-weight: bold; }

    @media (max-width: 900px) {
      .char-selection-area { flex-direction: column; }
    }
  </style>
</head>
<body>

  <canvas id="gameCanvas"></canvas>
  <div class="scanlines"></div>

  <!-- å…¨å±€ Tooltip (Z-Index 9999) -->
  <div id="global-tooltip">
    <div id="tt-header">
      <div id="tt-title">Title</div>
      <div id="tt-cost"></div>
    </div>
    <div id="tt-desc">Description</div>
    <div id="tt-info"></div>
  </div>

  <!-- æ¸¸æˆå†… HUD (Start hidden) -->
  <div id="ui-layer" class="hidden">
    <div class="hud-top">
      <div class="hud-left">
        <div class="stat-box"><span class="label">GDP (GOLD)</span><div class="value" id="score-val">0</div></div>
        <div class="stat-box"><span class="label">CYCLE</span><div class="value" id="cycle-val">-</div></div>
        <div class="stat-box"><span class="label">LIQUIDITY (HP)</span><div class="value" id="health-val">100%</div></div>
      </div>
      <div class="hud-right">
        <div class="hud-btn" onclick="togglePause()">â¸ï¸ PAUSE</div>
        <div class="hud-btn" onclick="location.reload()">ğŸ”„ ABORT</div>
      </div>
    </div>

    <div class="hud-bottom">
      <div style="display:flex; align-items:flex-end; gap:20px; justify-content:center;">
        <div class="skill-panel">
          <div class="skill-slot" style="--color:#fff; border-color:#fff;">
            <span class="skill-key">A</span><span class="skill-icon">ğŸ”«</span>
          </div>
          <!-- Skills with Tooltips -->
          <div class="skill-slot" id="skill-q" style="--color:#00f3ff" onmouseenter="showGameTooltip(this, 'q')" onmouseleave="hideTooltip()">
            <span class="skill-key">Q</span><span class="skill-icon">ğŸ’ </span>
            <div class="cooldown-overlay"><span class="cooldown-text"></span></div>
          </div>
          <div class="skill-slot" id="skill-w" style="--color:#00ff9d" onmouseenter="showGameTooltip(this, 'w')" onmouseleave="hideTooltip()">
            <span class="skill-key">W</span><span class="skill-icon">ğŸ›¡ï¸</span>
            <div class="cooldown-overlay"><span class="cooldown-text"></span></div>
          </div>
          <div class="skill-slot" id="skill-e" style="--color:#ffee00" onmouseenter="showGameTooltip(this, 'e')" onmouseleave="hideTooltip()">
            <span class="skill-key">E</span><span class="skill-icon">âš¡</span>
            <div class="cooldown-overlay"><span class="cooldown-text"></span></div>
          </div>
          <div class="skill-slot" id="skill-r" style="--color:#ff0055" onmouseenter="showGameTooltip(this, 'r')" onmouseleave="hideTooltip()">
            <span class="skill-key">R</span><span class="skill-icon">â˜¢ï¸</span>
            <div class="cooldown-overlay"><span class="cooldown-text"></span></div>
          </div>
        </div>
        
        <!-- è£…å¤‡æ  (Interactive) -->
        <div class="inventory-panel" id="inventory-display">
          <div class="item-slot empty" data-idx="0"></div>
          <div class="item-slot empty" data-idx="1"></div>
          <div class="item-slot empty" data-idx="2"></div>
          <div class="item-slot empty" data-idx="3"></div>
          <div class="item-slot empty" data-idx="4"></div>
          <div class="item-slot empty" data-idx="5"></div>
        </div>
        
        <div class="shop-hint" onclick="toggleShop()">SHOP [B]</div>
      </div>
    </div>
  </div>

  <!-- 1. è§„åˆ™/éš¾åº¦ -->
  <div id="screen-rules" class="modal">
    <div class="modal-content" style="justify-content:center;">
      <h1>MACRO DEFENDER 4.8</h1>
      <p class="subtitle">Global Economy Defense Initiative</p>
      <div class="rules-box">
        <h3>ğŸ”° ä»»åŠ¡ç®€æŠ¥ (Briefing)</h3>
        <p>
          1. <strong>é€‰æ‹©é¢†è¢–</strong>ï¼šæ‰®æ¼”çœŸå®ä¸–ç•Œçš„å¤®è¡Œè¡Œé•¿æˆ–æ”¿è¦ï¼Œæ¯äººæ‹¥æœ‰ç‹¬ç‰¹æŠ€èƒ½ã€‚<br>
          2. <strong>æ“ä½œ</strong>ï¼š<span class="key-tag">å³é”®</span>ç§»åŠ¨ï¼Œ<span class="key-tag">A</span>é”®å°„å‡»ï¼Œ<span class="key-tag">QWER</span>é‡Šæ”¾æŠ€èƒ½ã€‚<br>
          3. <strong>é˜²å¾¡</strong>ï¼šå‡»é€€é€šèƒ€æ¶é­”ä¸èµ„äº§æ³¡æ²«ï¼Œä¿æŠ¤æµåŠ¨æ€§(HP)ä¸å½’é›¶ã€‚<br>
          4. <strong>æˆé•¿</strong>ï¼šå‡»æ€è· GDPï¼ŒæŒ‰ <span class="key-tag">B</span> é”®è´­ä¹°è£…å¤‡å¢å¼ºå±æ€§ã€‚
        </p>
      </div>
      <p>SELECT DIFFICULTY</p>
      <div class="diff-select">
        <div class="diff-btn" onclick="setDifficulty(0.8, this)">EASY (ç®€å•)</div>
        <div class="diff-btn active" onclick="setDifficulty(1, this)">NORMAL (æ™®é€š)</div>
        <div class="diff-btn" onclick="setDifficulty(1.5, this)">HARD (å›°éš¾)</div>
      </div>
      <button class="btn" style="width:300px;" onclick="goToCharSelect()">NEXT: SELECT HERO</button>
    </div>
  </div>

  <!-- 2. é€‰äººç•Œé¢ -->
  <div id="screen-char" class="modal hidden">
    <div class="modal-content">
      <h1>SELECT HERO</h1>
      <div class="category-tabs">
        <div class="tab-btn active" onclick="filterChars('banker')">ğŸ›ï¸ å¤®è¡Œ</div>
        <div class="tab-btn" onclick="filterChars('politician')">ğŸ¦… æ”¿è¦</div>
        <div class="tab-btn" onclick="filterChars('investor')">ğŸ’¼ èµ„æœ¬</div>
        <div class="tab-btn" onclick="filterChars('tech')">ğŸš€ ç§‘æŠ€</div>
        <div class="tab-btn" onclick="filterChars('org')">ğŸŒ ç»„ç»‡</div>
      </div>
      <div class="char-selection-area">
        <div class="char-list" id="char-list-container"></div>
        <div class="char-detail-panel">
          <img id="detail-avatar" class="detail-avatar" src="" alt="Avatar">
          <div id="detail-name" class="detail-name">Name</div>
          <div id="detail-title" class="detail-title">Title</div>
          
          <div class="stats-grid" style="width:100%; font-size:0.8rem;">
            <div class="stat-row"><span class="stat-label">HP</span><div class="stat-track"><div class="stat-bar" id="bar-hp" style="width:0%"></div></div></div>
            <div class="stat-row"><span class="stat-label">ATK</span><div class="stat-track"><div class="stat-bar" id="bar-atk" style="width:0%"></div></div></div>
            <div class="stat-row"><span class="stat-label">SPD</span><div class="stat-track"><div class="stat-bar" id="bar-spd" style="width:0%"></div></div></div>
            <div class="stat-row"><span class="stat-label">RATE</span><div class="stat-track"><div class="stat-bar" id="bar-rate" style="width:0%"></div></div></div>
          </div>

          <div class="skill-list">
            <!-- Skills with tooltip triggers -->
            <div class="skill-item" onmouseenter="showSelectTooltip(this, 'q')" onmouseleave="hideTooltip()">
              <div class="skill-header"><span class="key-badge">Q</span> <span id="skill-q-name" class="skill-name-txt">-</span></div>
              <div id="skill-q-desc" class="skill-desc-txt">-</div>
            </div>
            <div class="skill-item" onmouseenter="showSelectTooltip(this, 'w')" onmouseleave="hideTooltip()">
              <div class="skill-header"><span class="key-badge">W</span> <span id="skill-w-name" class="skill-name-txt">-</span></div>
              <div id="skill-w-desc" class="skill-desc-txt">-</div>
            </div>
            <div class="skill-item" onmouseenter="showSelectTooltip(this, 'e')" onmouseleave="hideTooltip()">
              <div class="skill-header"><span class="key-badge">E</span> <span id="skill-e-name" class="skill-name-txt">-</span></div>
              <div id="skill-e-desc" class="skill-desc-txt">-</div>
            </div>
            <div class="skill-item" onmouseenter="showSelectTooltip(this, 'r')" onmouseleave="hideTooltip()">
              <div class="skill-header"><span class="key-badge">R</span> <span id="skill-r-name" class="skill-name-txt">-</span></div>
              <div id="skill-r-desc" class="skill-desc-txt">-</div>
            </div>
          </div>

          <button class="start-btn" style="margin-top:auto" onclick="startGame()">DEPLOY</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 3. æš‚åœèœå• -->
  <div id="pause-menu" class="modal hidden">
    <h1>SYSTEM PAUSED</h1>
    <button class="btn" onclick="togglePause()">RESUME</button>
    <button class="btn btn-red" onclick="location.reload()">ABORT MISSION</button>
  </div>

  <!-- 4. å•†åº— -->
  <div id="shop-menu" class="modal hidden">
    <div class="modal-content">
      <h1>GDP STORE</h1>
      <p>Current GDP: <span id="shop-current-gdp" style="color:#00ff9d">$0</span></p>
      <div class="shop-container" id="shop-items-container">
        <!-- Items generated by JS -->
      </div>
      <button class="btn btn-red" style="margin-top:20px" onclick="toggleShop()">CLOSE [B]</button>
    </div>
  </div>

  <!-- 5. æ¸¸æˆç»“æŸ -->
  <div id="game-over" class="modal hidden">
    <h1 style="color:#ff0055">MARKET CRASH</h1>
    <p>Final GDP: <span id="final-score">0</span></p>
    <button class="btn" onclick="location.reload()">REBOOT</button>
  </div>

  <script>
    /* ====== æ•°æ®ä¸­å¿ƒ (53 Chars - Fixed & Complete) ====== */
    const CHARACTERS = {
      // 1. Bankers
      'powell': { cat: 'banker', name: 'Jerome Powell (é²å¨å°”)', title: 'Fed Chair', hp: 7, atk: 4, spd: 5, rate: 8, color: '#00f3ff', q:'Hawk Shot', w:'Rate Shield', e:'Pivot Dash', r:'Infinite QE', qDesc:'é¹°æ´¾ä¸‰è¿å°„', wDesc:'åŠ æ¯æŠ¤ç›¾', eDesc:'æ”¿ç­–è½¬å‘', rDesc:'æ— é™å°é’', qInfo:'Dmg: Med | CD: 3s', wInfo:'Shield | CD: 8s', eInfo:'Dash | CD: 4s', rInfo:'Full Screen | CD: 30s' },
      'yellen': { cat: 'banker', name: 'Janet Yellen (è€¶ä¼¦)', title: 'Treasury Sec', hp: 6, atk: 5, spd: 5, rate: 7, color: '#0099ff', q:'Soft Landing', w:'Debt Ceiling', e:'Treasury Run', r:'Bailout', qDesc:'è½¯ç€é™†å¼¹å¹•', wDesc:'å€ºåŠ¡ä¸Šé™é˜²å¾¡å¡”', eDesc:'å›½å€ºç–¾è·‘', rDesc:'å…¨å‘˜å›è¡€', qInfo:'Slow | CD: 4s', wInfo:'Block | CD: 10s', eInfo:'Speed | CD: 5s', rInfo:'Heal | CD: 40s' },
      'bernanke': { cat: 'banker', name: 'Ben Bernanke (ä¼¯å—å…‹)', title: 'Ex-Fed Chair', hp: 6, atk: 3, spd: 4, rate: 9, color: '#00cc99', q:'Helicopter', w:'Stress Test', e:'QE Dash', r:'QE1', qDesc:'ç›´å‡æœºæ’’é’±æ•£å°„', wDesc:'å‹åŠ›æµ‹è¯•æŠ¤ç›¾', eDesc:'é‡åŒ–å†²åˆº', rDesc:'é‡åŒ–å®½æ¾è½°ç‚¸', qInfo:'AoE | CD: 5s', wInfo:'Def | CD: 12s', eInfo:'Dash | CD: 6s', rInfo:'Dmg | CD: 35s' },
      'pan': { cat: 'banker', name: 'Pan Gongsheng (æ½˜åŠŸèƒœ)', title: 'PBOC Gov', hp: 8, atk: 5, spd: 5, rate: 8, color: '#ff3333', q:'RRR Cut', w:'Swap Line', e:'Cross-Border', r:'Flood', qDesc:'é™å‡†å†²å‡»æ³¢', wDesc:'äº’æ¢é€šæŠ¤ç›¾', eDesc:'è·¨å¢ƒç©¿æ¢­', rDesc:'æµåŠ¨æ€§æ´ªæµ', qInfo:'AoE | CD: 5s', wInfo:'Reflect | CD: 12s', eInfo:'Teleport | CD: 6s', rInfo:'High Dmg | CD: 35s' },
      'yi': { cat: 'banker', name: 'Yi Gang (æ˜“çº²)', title: 'Ex-PBOC Gov', hp: 7, atk: 5, spd: 5, rate: 7, color: '#cc0000', q:'Prudent Policy', w:'FX Reserve', e:'Reform', r:'Structural', qDesc:'ç¨³å¥æ”¿ç­–', wDesc:'å¤–æ±‡å‚¨å¤‡ç›¾', eDesc:'æ”¹é©æ­¥ä¼', rDesc:'ç»“æ„æ€§å·¥å…·', qInfo:'Dmg | CD: 3s', wInfo:'Block | CD: 10s', eInfo:'Move | CD: 5s', rInfo:'Buff | CD: 40s' },
      'greenspan': { cat: 'banker', name: 'Alan Greenspan (æ ¼æ—æ–¯æ½˜)', title: 'Maestro', hp: 5, atk: 6, spd: 3, rate: 6, color: '#aaaaaa', q:'Fed Put', w:'Exuberance', e:'Bubble Ride', r:'Moderation', qDesc:'çœ‹è·ŒæœŸæƒæŠ¤ç›¾', wDesc:'éç†æ€§ç¹è£', eDesc:'æ³¡æ²«æ¼‚ç§»', rDesc:'å¤§ç¼“å’Œå®šèº«', qInfo:'Shield | CD: 8s', wInfo:'Buff | CD: 15s', eInfo:'Move | CD: 5s', rInfo:'Stun | CD: 40s' },
      'lagarde': { cat: 'banker', name: 'Christine Lagarde (æ‹‰åŠ å¾·)', title: 'ECB President', hp: 6, atk: 5, spd: 5, rate: 6, color: '#3366cc', q:'Euro Bond', w:'Fragment', e:'Unity Dash', r:'Whatever it takes', qDesc:'æ¬§å…ƒå›æ—‹é•–', wDesc:'ååˆ†è£‚ç«‹åœº', eDesc:'ç»Ÿä¸€å†²åˆº', rDesc:'å¼ºåŠ›å…¨å±éœ‡è¡', qInfo:'Return | CD: 4s', wInfo:'AoE Push | CD: 10s', eInfo:'Dash | CD: 5s', rInfo:'Massive Dmg | CD: 45s' },
      'draghi': { cat: 'banker', name: 'Mario Draghi (å¾·æ‹‰å‰)', title: 'Super Mario', hp: 7, atk: 6, spd: 6, rate: 7, color: '#0055a4', q:'Bazooka', w:'Euro Shield', e:'Techocrate', r:'Save the Euro', qDesc:'ç«ç®­ç­’é‡å‡»', wDesc:'æ¬§å…ƒç›¾', eDesc:'æŠ€æœ¯å®˜åƒšä½ç§»', rDesc:'æ‹¯æ•‘æ¬§å…ƒå…¨å±æ¸…åœº', qInfo:'Explode | CD: 5s', wInfo:'Shield | CD: 12s', eInfo:'Dash | CD: 4s', rInfo:'Wipe | CD: 50s' },
      'kuroda': { cat: 'banker', name: 'Haruhiko Kuroda (é»‘ç”°ä¸œå½¦)', title: 'Ex-BOJ Gov', hp: 5, atk: 3, spd: 7, rate: 10, color: '#ff6600', q:'YCC Control', w:'Negative Rate', e:'Yen Slide', r:'Super Ease', qDesc:'YCCå®šèº«', wDesc:'è´Ÿåˆ©ç‡åŠ›åœº', eDesc:'æ—¥å…ƒæ»‘å¡', rDesc:'è¶…çº§å®½æ¾å¼¹å¹•é›¨', qInfo:'Stun | CD: 6s', wInfo:'AoE Slow | CD: 12s', eInfo:'Speed | CD: 5s', rInfo:'Barrage | CD: 30s' },
      'ueda': { cat: 'banker', name: 'Kazuo Ueda (æ¤ç”°å’Œç”·)', title: 'BOJ Gov', hp: 6, atk: 4, spd: 6, rate: 8, color: '#ff9933', q:'Rate Hike', w:'YCC End', e:'Normal Path', r:'Exit', qDesc:'åŠ æ¯å•ç‚¹', wDesc:'YCCç»ˆç»“', eDesc:'æ­£å¸¸åŒ–è·¯å¾„', rDesc:'é€€å‡ºå®½æ¾', qInfo:'Dmg | CD: 2s', wInfo:'Slow | CD: 10s', eInfo:'Dash | CD: 5s', rInfo:'Burst | CD: 40s' },
      'carney': { cat: 'banker', name: 'Mark Carney (å¡å°¼)', title: 'Ex-BOE Gov', hp: 6, atk: 5, spd: 5, rate: 7, color: '#6600cc', q:'Forward Guidance', w:'Climate Risk', e:'Net Zero', r:'Horizon', qDesc:'å‰ç»æŒ‡å¼•', wDesc:'æ°”å€™é£é™©è¿·é›¾', eDesc:'å‡€é›¶æ’æ”¾', rDesc:'åœ°å¹³çº¿å†²å‡»', qInfo:'Buff | CD: 8s', wInfo:'Blind | CD: 12s', eInfo:'Dash | CD: 6s', rInfo:'Wave | CD: 45s' },
      'bailey': { cat: 'banker', name: 'Andrew Bailey (è´åˆ©)', title: 'BOE Gov', hp: 6, atk: 5, spd: 4, rate: 7, color: '#9933ff', q:'Gilt Market', w:'Intervention', e:'Pivot', r:'Stability', qDesc:'å›½å€ºå†²å‡»', wDesc:'å¹²é¢„æŠ¤ç›¾', eDesc:'æ”¿ç­–è½¬å‘', rDesc:'é‡‘èç¨³å®š', qInfo:'Dmg | CD: 4s', wInfo:'Shield | CD: 15s', eInfo:'Dash | CD: 5s', rInfo:'Heal | CD: 50s' },

      // 2. Politicians
      'trump': { cat: 'politician', name: 'Donald Trump (ç‰¹æœ—æ™®)', title: 'Former Pres', hp: 8, atk: 9, spd: 5, rate: 6, color: '#ff0000', q:'Twitter Storm', w:'Tariff Wall', e:'Golf Cart', r:'Trade War', qDesc:'æ¨ç‰¹å£°æ³¢', wDesc:'å…³ç¨å¢™', eDesc:'é«˜å°”å¤«å†²åˆº', rDesc:'è´¸æ˜“æˆ˜æ ¸å¼¹', qInfo:'Cone Dmg | CD: 2s', wInfo:'Wall | CD: 15s', eInfo:'Stun Dash | CD: 8s', rInfo:'Screen Wipe | CD: 60s' },
      'xi': { cat: 'politician', name: 'Xi Jinping (ä¹ è¿‘å¹³)', title: 'President', hp: 10, atk: 7, spd: 4, rate: 6, color: '#ffcc00', q:'Dual Circle', w:'Prosperity', e:'Steady Step', r:'Belt & Road', qDesc:'åŒå¾ªç¯ç¯ç»•', wDesc:'å…±åŒå¯Œè£•', eDesc:'ç¨³å¥æ­¥ä¼', rDesc:'ä¸€å¸¦ä¸€è·¯', qInfo:'Spin Dmg | CD: 6s', wInfo:'Heal | CD: 15s', eInfo:'Armor Dash | CD: 10s', rInfo:'Charge | CD: 45s' },
      'macron': { cat: 'politician', name: 'Emmanuel Macron (é©¬å…‹é¾™)', title: 'French Pres.', hp: 7, atk: 6, spd: 6, rate: 7, color: '#0055a4', q:'Reform Strike', w:'Autonomy', e:'Diplomacy', r:'Euro Army', qDesc:'æ”¹é©ç©¿é€å¼¹', wDesc:'æˆ˜ç•¥è‡ªä¸»ç›¾', eDesc:'å¤–äº¤æ–¡æ—‹ä½ç§»', rDesc:'æ¬§æ´²å†›å›¢å¬å”¤', qInfo:'Pierce | CD: 3s', wInfo:'Absorb | CD: 10s', eInfo:'Invuln | CD: 5s', rInfo:'Summon | CD: 40s' },
      'biden': { cat: 'politician', name: 'Joe Biden (æ‹œç™»)', title: 'US President', hp: 9, atk: 6, spd: 3, rate: 5, color: '#0000cc', q:'Inflation Act', w:'Alliance', e:'Air Force 1', r:'Chips Ban', qDesc:'é€šèƒ€æ³•æ¡ˆé‡å‡»', wDesc:'ç›Ÿå‹å¬å”¤', eDesc:'ç©ºå†›ä¸€å·', rDesc:'èŠ¯ç‰‡ç¦ä»¤å…¨å±å‡é€Ÿ', qInfo:'Heavy Dmg | CD: 4s', wInfo:'Summon | CD: 20s', eInfo:'Fly | CD: 8s', rInfo:'Slow All | CD: 50s' },
      'obama': { cat: 'politician', name: 'Barack Obama (å¥¥å·´é©¬)', title: 'Former President', hp: 8, atk: 5, spd: 6, rate: 7, color: '#0066cc', q:'Stimulus', w:'Obamacare', e:'Yes We Can', r:'Hope', qDesc:'åˆºæ¿€è®¡åˆ’', wDesc:'åŒ»ä¿å›è¡€', eDesc:'ç«é€‰å†²åˆº', rDesc:'å¸Œæœ›ä¹‹å…‰', qInfo:'Buff | CD: 10s', wInfo:'Heal | CD: 15s', eInfo:'Dash | CD: 5s', rInfo:'Light | CD: 40s' },
      'liqiang': { cat: 'politician', name: 'Li Qiang (æå¼º)', title: 'Premier', hp: 8, atk: 6, spd: 6, rate: 7, color: '#ff9900', q:'Open Up', w:'Service', e:'Efficiency', r:'High Quality', qDesc:'å¼€æ”¾é—¨æˆ·', wDesc:'æœåŠ¡å‹é˜²å¾¡', eDesc:'æ•ˆç‡å†²åˆº', rDesc:'é«˜è´¨é‡å‘å±•', qInfo:'Portal | CD: 8s', wInfo:'Shield | CD: 12s', eInfo:'Speed | CD: 5s', rInfo:'Buff | CD: 40s' },
      'putin': { cat: 'politician', name: 'Vladimir Putin (æ™®äº¬)', title: 'Russian Pres', hp: 9, atk: 9, spd: 2, rate: 4, color: '#fff', q:'Energy Cut', w:'Iron Curtain', e:'KGB Dash', r:'Special Op', qDesc:'èƒ½æºåˆ‡æ–­', wDesc:'é“å¹•é˜²å¾¡', eDesc:'ç‰¹å·¥çªè¢­', rDesc:'ç‰¹ç§è¡ŒåŠ¨', qInfo:'Freeze | CD: 5s', wInfo:'Block All | CD: 15s', eInfo:'Stealth | CD: 8s', rInfo:'Explosion | CD: 50s' },
      'scholz': { cat: 'politician', name: 'Olaf Scholz (æœ”å°”èŒ¨)', title: 'German Chancellor', hp: 8, atk: 5, spd: 4, rate: 6, color: '#000000', q:'Zeitenwende', w:'Industry', e:'Hesitate', r:'Budget', qDesc:'æ—¶ä»£è½¬æŠ˜', wDesc:'å·¥ä¸šæŠ¤ç›¾', eDesc:'å®¡æ…ç§»åŠ¨', rDesc:'é¢„ç®—å¤§ç‚®', qInfo:'Turn | CD: 10s', wInfo:'Def | CD: 12s', eInfo:'Slow Dash | CD: 6s', rInfo:'Blast | CD: 45s' },
      'modi': { cat: 'politician', name: 'Narendra Modi (è«è¿ª)', title: 'Indian PM', hp: 8, atk: 6, spd: 5, rate: 7, color: '#ff9933', q:'Made in India', w:'Yoga', e:'Tech Hub', r:'Digital India', qDesc:'å°åº¦åˆ¶é€ ', wDesc:'ç‘œä¼½å›è¡€', eDesc:'ç§‘æŠ€ç¬ç§»', rDesc:'æ•°å­—å°åº¦æ¿€å…‰', qInfo:'Build | CD: 5s', wInfo:'Heal | CD: 15s', eInfo:'Teleport | CD: 8s', rInfo:'Laser | CD: 40s' },
      'kishida': { cat: 'politician', name: 'Fumio Kishida (å²¸ç”°æ–‡é›„)', title: 'Japanese PM', hp: 6, atk: 5, spd: 5, rate: 7, color: '#cc0033', q:'New Capitalism', w:'Defense', e:'Step Up', r:'Invest', qDesc:'æ–°èµ„æœ¬ä¸»ä¹‰', wDesc:'é˜²å«å¢ç¨', eDesc:'é˜¶æ¢¯æ­¥', rDesc:'æŠ•èµ„æœªæ¥', qInfo:'Coin | CD: 3s', wInfo:'Tax Shield | CD: 10s', eInfo:'Dash | CD: 5s', rInfo:'Gold Rain | CD: 40s' },
      'trudeau': { cat: 'politician', name: 'Justin Trudeau (ç‰¹é²å¤š)', title: 'Canadian PM', hp: 7, atk: 5, spd: 6, rate: 7, color: '#ff0000', q:'Carbon Tax', w:'Multicultural', e:'Ski', r:'Emergency', qDesc:'ç¢³ç¨æ‰“å‡»', wDesc:'å¤šå…ƒæ–‡åŒ–', eDesc:'æ»‘é›ªå†²åˆº', rDesc:'ç´§æ€¥çŠ¶æ€', qInfo:'DoT | CD: 4s', wInfo:'Absorb | CD: 12s', eInfo:'Fast | CD: 6s', rInfo:'Lockdown | CD: 50s' },
      'sunak': { cat: 'politician', name: 'Rishi Sunak (è‹çº³å…‹)', title: 'UK Ex-PM', hp: 6, atk: 6, spd: 6, rate: 7, color: '#0000ff', q:'Math', w:'Finance', e:'Tech Bro', r:'Windsor', qDesc:'æ•°å­¦è®¡ç®—', wDesc:'é‡‘èåŸæŠ¤ç›¾', eDesc:'ç§‘æŠ€æ­¥ä¼', rDesc:'æ¸©èæ¡†æ¶', qInfo:'Calc | CD: 3s', wInfo:'Shield | CD: 10s', eInfo:'Dash | CD: 5s', rInfo:'Agreement | CD: 40s' },

      // 3. Investors
      'buffett': { cat: 'investor', name: 'Warren Buffett (å·´è²ç‰¹)', title: 'Oracle', hp: 6, atk: 10, spd: 2, rate: 4, color: '#339933', q:'Value Sniper', w:'Moat', e:'Compound', r:'Snowball', qDesc:'ä»·å€¼ç‹™å‡»', wDesc:'æŠ¤åŸæ²³', eDesc:'å¤åˆ©ä½ç§»', rDesc:'æ»šé›ªçƒ', qInfo:'Crit | CD: 5s', wInfo:'Invuln | CD: 20s', eInfo:'CD: 1s', rInfo:'Grow Dmg | CD: 50s' },
      'musk': { cat: 'tech', name: 'Elon Musk (é©¬æ–¯å…‹)', title: 'Technoking', hp: 6, atk: 8, spd: 9, rate: 9, color: '#999', q:'Doge Rocket', w:'Starshield', e:'Hyperloop', r:'Mars Colony', qDesc:'ç‹—ç‹—å¸æ”»å‡»', wDesc:'æ˜Ÿèˆ°æŠ¤ç›¾', eDesc:'çœŸç©ºç®¡é“ç¬ç§»', rDesc:'ç«æ˜Ÿæ®–æ°‘è½°ç‚¸', qInfo:'Random | CD: 1s', wInfo:'Reflect | CD: 8s', eInfo:'Range: Max | CD: 4s', rInfo:'AoE: Huge | CD: 30s' },
      'dalio': { cat: 'investor', name: 'Ray Dalio (è¾¾åˆ©æ¬§)', title: 'Bridgewater', hp: 7, atk: 6, spd: 5, rate: 8, color: '#6600cc', q:'All Weather', w:'Deleverage', e:'Cycle Surf', r:'Big Cycle', qDesc:'å…¨å¤©å€™æ•£å°„', wDesc:'å»æ æ†', eDesc:'å‘¨æœŸå†²æµª', rDesc:'å¤§å‘¨æœŸé‡ç½®', qInfo:'Spread | CD: 3s', wInfo:'Push | CD: 8s', eInfo:'Speed | CD: 5s', rInfo:'Reset | CD: 60s' },
      'munger': { cat: 'investor', name: 'Charlie Munger (èŠ’æ ¼)', title: 'Architect', hp: 5, atk: 10, spd: 1, rate: 3, color: '#555555', q:'Wisdom', w:'Patience', e:'Sit', r:'Lollapalooza', qDesc:'æ™ºæ…§ç®´è¨€', wDesc:'è€å¿ƒç­‰å¾…', eDesc:'åçœ‹äº‘èµ·', rDesc:'æ•ˆåº”å åŠ ', qInfo:'Stun | CD: 8s', wInfo:'Def Up | CD: 10s', eInfo:'Regen | CD: 0s', rInfo:'Combo | CD: 60s' },
      'marks': { cat: 'investor', name: 'Howard Marks (é©¬å…‹æ–¯)', title: 'Oaktree', hp: 6, atk: 7, spd: 4, rate: 6, color: '#996633', q:'Memo', w:'Risk Control', e:'Pendulum', r:'Distressed', qDesc:'æŠ•èµ„å¤‡å¿˜å½•', wDesc:'é£é™©æ§åˆ¶', eDesc:'é’Ÿæ‘†æ‘†åŠ¨', rDesc:'å›°å¢ƒåè½¬', qInfo:'Buff | CD: 10s', wInfo:'Shield | CD: 12s', eInfo:'Swing | CD: 4s', rInfo:'Revive | CD: 60s' },
      'tepper': { cat: 'investor', name: 'David Tepper (æ³°ç€)', title: 'Appaloosa', hp: 6, atk: 9, spd: 6, rate: 7, color: '#003366', q:'Bullish', w:'Fed Put', e:'Jump', r:'Buy Everything', qDesc:'ç‰›å¸‚å†²å‡»', wDesc:'è”å‚¨çœ‹è·Œ', eDesc:'æŠ„åº•è·³è·ƒ', rDesc:'ä¹°å…¥ä¸€åˆ‡', qInfo:'Charge | CD: 5s', wInfo:'Shield | CD: 15s', eInfo:'Jump | CD: 6s', rInfo:'Magnet | CD: 45s' },
      'griffin': { cat: 'investor', name: 'Ken Griffin (æ ¼é‡ŒèŠ¬)', title: 'Citadel', hp: 8, atk: 8, spd: 8, rate: 9, color: '#000099', q:'HFT', w:'Market Maker', e:'Algo Dash', r:'Dominance', qDesc:'é«˜é¢‘äº¤æ˜“', wDesc:'åšå¸‚å•†', eDesc:'ç®—æ³•å†²åˆº', rDesc:'ç®—æ³•ç»Ÿæ²»', qInfo:'Rapid | CD: 1s', wInfo:'Wall | CD: 8s', eInfo:'Dash | CD: 3s', rInfo:'Auto Aim | CD: 40s' },
      'ackman': { cat: 'investor', name: 'Bill Ackman (é˜¿å…‹æ›¼)', title: 'Pershing Sq', hp: 6, atk: 8, spd: 7, rate: 7, color: '#999999', q:'Activist', w:'Hedge', e:'Media', r:'Big Short', qDesc:'æ¿€è¿›æŠ•èµ„', wDesc:'å¯¹å†²ä¿æŠ¤', eDesc:'åª’ä½“æ›å…‰', rDesc:'ä¸–çºªç©ºå¤´', qInfo:'Crit | CD: 4s', wInfo:'Shield | CD: 10s', eInfo:'Teleport | CD: 8s', rInfo:'Crash | CD: 50s' },
      'soros': { cat: 'investor', name: 'George Soros (ç´¢ç½—æ–¯)', title: 'Quantum', hp: 5, atk: 9, spd: 6, rate: 6, color: '#333', q:'Short Sell', w:'Reflexivity', e:'Attack Run', r:'Crash', qDesc:'åšç©ºæš´å‡»', wDesc:'åèº«æ€§', eDesc:'çªè¢­', rDesc:'åˆ¶é€ å´©ç›˜', qInfo:'High Dmg | CD: 4s', wInfo:'Dodge | CD: 10s', eInfo:'Dash | CD: 4s', rInfo:'Life Steal | CD: 45s' },
      'druckenmiller': { cat: 'investor', name: 'Stanley Druckenmiller', title: 'Duquesne', hp: 6, atk: 9, spd: 7, rate: 7, color: '#000000', q:'Macro Bet', w:'Flexibility', e:'Shift', r:'Top Down', qDesc:'å®è§‚æŠ¼æ³¨', wDesc:'çµæ´»é…ç½®', eDesc:'ä»“ä½è½¬æ¢', rDesc:'è‡ªä¸Šè€Œä¸‹', qInfo:'Snipe | CD: 5s', wInfo:'Dodge | CD: 8s', eInfo:'Swap | CD: 3s', rInfo:'Global | CD: 40s' },
      'schwarzman': { cat: 'investor', name: 'Steve Schwarzman', title: 'Blackstone', hp: 8, atk: 7, spd: 5, rate: 6, color: '#000000', q:'Private Eq', w:'Real Estate', e:'Network', r:'Capital', qDesc:'ç§å‹Ÿè‚¡æƒ', wDesc:'ä¸åŠ¨äº§ç›¾', eDesc:'äººè„‰ç½‘ç»œ', rDesc:'èµ„æœ¬æ´ªæµ', qInfo:'Lock | CD: 6s', wInfo:'Block | CD: 12s', eInfo:'Dash | CD: 5s', rInfo:'Flood | CD: 45s' },
      'kravis': { cat: 'investor', name: 'Henry Kravis (å…‹æ‹‰ç»´æ–¯)', title: 'KKR', hp: 7, atk: 8, spd: 5, rate: 6, color: '#cc0000', q:'LBO', w:'Management', e:'Takeover', r:'Buyout', qDesc:'æ æ†æ”¶è´­', wDesc:'ç®¡ç†ä¼˜åŒ–', eDesc:'æ¥ç®¡ä½ç§»', rDesc:'æ”¶è´­å…¨åœº', qInfo:'Drain | CD: 5s', wInfo:'Heal | CD: 15s', eInfo:'Dash | CD: 6s', rInfo:'Convert | CD: 50s' },
      'simons': { cat: 'investor', name: 'Jim Simons (è¥¿è’™æ–¯)', title: 'Renaissance', hp: 6, atk: 8, spd: 9, rate: 10, color: '#006600', q:'Algo Beam', w:'Black Box', e:'Data Jump', r:'Medallion', qDesc:'ç®—æ³•å…‰æŸ', wDesc:'é»‘ç®±é˜²å¾¡', eDesc:'æ•°æ®è·³è·ƒ', rDesc:'å¤§å¥–ç« æ”¶ç›Š', qInfo:'Beam | CD: 2s', wInfo:'Shield | CD: 12s', eInfo:'Teleport | CD: 3s', rInfo:'Gold Rain | CD: 40s' },

      // 4. Tech (More)
      'huang': { cat: 'tech', name: 'Jensen Huang (é»„ä»å‹‹)', title: 'NVIDIA', hp: 5, atk: 10, spd: 8, rate: 10, color: '#76b900', q:'CUDA Core', w:'Ray Tracing', e:'Tensor Flow', r:'Singularity', qDesc:'ç®—åŠ›å¼¹å¹•', wDesc:'å…‰è¿½åå°„', eDesc:'å¼ é‡æµåŠ é€Ÿ', rDesc:'å¥‡ç‚¹çˆ†å‘', qInfo:'Split | CD: 2s', wInfo:'Mirror | CD: 12s', eInfo:'Spd | CD: 6s', rInfo:'Black Hole | CD: 45s' },
      'bezos': { cat: 'tech', name: 'Jeff Bezos (è´ç´¢æ–¯)', title: 'Amazon', hp: 7, atk: 7, spd: 6, rate: 8, color: '#ff9900', q:'Prime', w:'Cloud', e:'Blue Origin', r:'Logistic', qDesc:'Primeé£å¼¹', wDesc:'äº‘ç›¾', eDesc:'è“è‰²èµ·æº', rDesc:'ç‰©æµç½‘ç»œ', qInfo:'Homing | CD: 3s', wInfo:'Block | CD: 10s', eInfo:'Fly | CD: 6s', rInfo:'Drone Swarm | CD: 40s' },
      'cook': { cat: 'tech', name: 'Tim Cook (åº“å…‹)', title: 'Apple', hp: 8, atk: 6, spd: 5, rate: 7, color: '#aaaaaa', q:'Supply Chain', w:'Privacy', e:'One More Thing', r:'Ecosystem', qDesc:'ä¾›åº”é“¾æ‰“å‡»', wDesc:'éšç§ç›¾', eDesc:'æƒŠå–œå‘å¸ƒ', rDesc:'ç”Ÿæ€å›´å¢™', qInfo:'Link | CD: 5s', wInfo:'Stealth | CD: 12s', eInfo:'Dash | CD: 8s', rInfo:'Trap | CD: 45s' },
      'zuckerberg': { cat: 'tech', name: 'Mark Zuckerberg (æ‰å…‹ä¼¯æ ¼)', title: 'Meta', hp: 6, atk: 7, spd: 7, rate: 8, color: '#0066ff', q:'Metaverse', w:'Connect', e:'VR Step', r:'Virtual World', qDesc:'å…ƒå®‡å®™æ³¢', wDesc:'è¿æ¥', eDesc:'VRæ­¥', rDesc:'è™šæ‹Ÿä¸–ç•Œ', qInfo:'Wave | CD: 3s', wInfo:'Link | CD: 10s', eInfo:'Teleport | CD: 5s', rInfo:'Confuse | CD: 40s' },
      'nadella': { cat: 'tech', name: 'Satya Nadella (çº³å¾·æ‹‰)', title: 'Microsoft', hp: 8, atk: 7, spd: 6, rate: 8, color: '#00a1f1', q:'Copilot', w:'Enterprise', e:'Azure', r:'Cloud AI', qDesc:'å‰¯é©¾é©¶å°„å‡»', wDesc:'ä¼ä¸šçº§æŠ¤ç›¾', eDesc:'äº‘ç«¯ä¼ è¾“', rDesc:'äº‘ç«¯AIé™ä¸´', qInfo:'Assist | CD: 2s', wInfo:'Shield | CD: 12s', eInfo:'Teleport | CD: 6s', rInfo:'Global Dmg | CD: 45s' },
      'ponyma': { cat: 'tech', name: 'Pony Ma (é©¬åŒ–è…¾)', title: 'Tencent', hp: 7, atk: 7, spd: 6, rate: 9, color: '#33ccff', q:'WeChat', w:'Social', e:'Link', r:'Game Empire', qDesc:'å¾®ä¿¡è¿æ¥', wDesc:'ç¤¾äº¤ç½‘ç»œ', eDesc:'é“¾æ¥è·³è½¬', rDesc:'æ¸¸æˆå¸å›½', qInfo:'Beam | CD: 3s', wInfo:'Web | CD: 10s', eInfo:'Dash | CD: 5s', rInfo:'Summon | CD: 40s' },
      'jackma': { cat: 'tech', name: 'Jack Ma (é©¬äº‘)', title: 'Alibaba', hp: 6, atk: 8, spd: 7, rate: 8, color: '#ff6600', q:'E-Commerce', w:'Payment', e:'Logistics', r:'Data Cloud', qDesc:'ç”µå•†æ´ªæµ', wDesc:'æ”¯ä»˜ç›¾', eDesc:'ç‰©æµé€Ÿé€’', rDesc:'æ•°æ®äº‘çˆ†ç ´', qInfo:'Rapid | CD: 2s', wInfo:'Shield | CD: 12s', eInfo:'Speed | CD: 4s', rInfo:'AoE | CD: 40s' },
      'robinli': { cat: 'tech', name: 'Robin Li (æå½¦å®)', title: 'Baidu', hp: 6, atk: 6, spd: 6, rate: 7, color: '#0033cc', q:'Search', w:'Auto', e:'Map', r:'Ernie Bot', qDesc:'æœç´¢ç´¢å¼•', wDesc:'è‡ªåŠ¨é©¾é©¶', eDesc:'åœ°å›¾å¯¼èˆª', rDesc:'æ–‡å¿ƒä¸€è¨€', qInfo:'Lock | CD: 4s', wInfo:'Dodge | CD: 10s', eInfo:'Teleport | CD: 6s', rInfo:'Smart Bomb | CD: 45s' },

      // 5. Org
      'georgieva': { cat: 'org', name: 'Kristalina Georgieva (æ ¼å¥¥å°”åŸºè€¶å¨ƒ)', title: 'IMF', hp: 8, atk: 4, spd: 5, rate: 6, color: '#003399', q:'SDR', w:'Austerity', e:'Rescue', r:'Global Fund', qDesc:'SDRæ”¯æ´', wDesc:'ç´§ç¼©ç«‹åœº', eDesc:'æ•‘æ´ä½ç§»', rDesc:'å…¨çƒåŸºé‡‘å›è¡€', qInfo:'Support | CD: 4s', wInfo:'Slow Area | CD: 10s', eInfo:'Heal Self | CD: 15s', rInfo:'Full Heal | CD: 60s' },
      'banga': { cat: 'org', name: 'Ajay Banga (å½­å®‰æ°)', title: 'World Bank', hp: 8, atk: 4, spd: 5, rate: 6, color: '#0099cc', q:'Development', w:'Poverty', e:'Project', r:'Infrastructure', qDesc:'å‘å±•æ´åŠ©', wDesc:'æ¶ˆé™¤è´«å›°', eDesc:'é¡¹ç›®è½åœ°', rDesc:'åŸºå»ºç‹‚é­”', qInfo:'Build | CD: 5s', wInfo:'Heal | CD: 12s', eInfo:'Dash | CD: 6s', rInfo:'Fortress | CD: 50s' },
      'okonjo': { cat: 'org', name: 'Ngozi Okonjo-Iweala (ä¼Šç»´æ‹‰)', title: 'WTO', hp: 7, atk: 4, spd: 5, rate: 6, color: '#00cc00', q:'Trade Flow', w:'Dispute', e:'Customs', r:'Global Market', qDesc:'è´¸æ˜“æµ', wDesc:'äº‰ç«¯è§£å†³', eDesc:'å¿«é€Ÿé€šå…³', rDesc:'å…¨çƒå¸‚åœº', qInfo:'Flow | CD: 3s', wInfo:'Block | CD: 10s', eInfo:'Pass | CD: 5s', rInfo:'Open | CD: 45s' },
      'guterres': { cat: 'org', name: 'AntÃ³nio Guterres (å¤ç‰¹é›·æ–¯)', title: 'UN SG', hp: 9, atk: 2, spd: 4, rate: 5, color: '#3399ff', q:'Resolution', w:'Peace', e:'Mission', r:'Humanity', qDesc:'å†³è®®', wDesc:'ç»´å’Œéƒ¨é˜Ÿ', eDesc:'å¤–äº¤å‡ºè®¿', rDesc:'äººç±»å‘½è¿', qInfo:'Stun | CD: 8s', wInfo:'Peace | CD: 20s', eInfo:'Move | CD: 10s', rInfo:'Stop War | CD: 60s' },
      'stoltenberg': { cat: 'org', name: 'Jens Stoltenberg (æ–¯æ‰˜å°”æ»•è´æ ¼)', title: 'NATO SG', hp: 7, atk: 8, spd: 6, rate: 6, color: '#003366', q:'Article 5', w:'Defense', e:'Deploy', r:'Alliance', qDesc:'ç¬¬äº”æ¡æ¬¾', wDesc:'å…±åŒé˜²å¾¡', eDesc:'å¿«é€Ÿéƒ¨ç½²', rDesc:'å†›äº‹è”ç›Ÿ', qInfo:'Call | CD: 10s', wInfo:'Armor | CD: 15s', eInfo:'Drop | CD: 5s', rInfo:'Strike | CD: 50s' }
    };

    // è£…å¤‡æ•°æ®åº“
    const ITEMS = {
      'inf_sword': { type: 'attack', name: 'Infinity Ledger', cost: 1500, icon: 'âš”ï¸', stats: { dmg: 2, rate: 0.8 }, desc: 'æ”»å‡»åŠ›å¤§å¹…æå‡ï¼Œå°„é€ŸåŠ å¿«', passive: 'Multi-Shot' },
      'hft_chip': { type: 'attack', name: 'HFT Chip', cost: 1200, icon: 'ğŸ’¾', stats: { rate: 0.6 }, desc: 'é«˜é¢‘äº¤æ˜“èŠ¯ç‰‡ï¼Œå°„é€Ÿç¿»å€', passive: 'Rapid Fire' },
      'bull_horn': { type: 'attack', name: 'Bull Horn', cost: 2000, icon: 'ğŸ‚', stats: { dmg: 3 }, desc: 'ç‰›å¸‚ä¹‹è§’ï¼Œä¼¤å®³æé«˜', passive: 'Knockback' },
      'invisible_hand': { type: 'attack', name: 'Invisible Hand', cost: 2500, icon: 'ğŸ–ï¸', stats: { dmg: 1 }, desc: 'ã€è¢«åŠ¨ã€‘å­å¼¹è‡ªåŠ¨è¿½è¸ªæ•Œäºº', passive: 'homing' },
      'gold_armor': { type: 'defense', name: 'Gold Reserve', cost: 1000, icon: 'ğŸ¥‡', stats: { maxHp: 50 }, desc: 'å¢åŠ  50 ç‚¹ç”Ÿå‘½ä¸Šé™', passive: 'Armor' },
      'fed_put': { type: 'defense', name: 'Fed Put', cost: 1800, icon: 'ğŸ“‰', stats: { hpRegen: 0.2 }, desc: 'ç¾è”å‚¨çœ‹è·ŒæœŸæƒï¼Œæ¯ç§’å›è¡€', passive: 'hpRegen' },
      'bretton_shield': { type: 'defense', name: 'Bretton Shield', cost: 2200, icon: 'ğŸ›¡ï¸', stats: { maxHp: 30 }, desc: 'ã€è¢«åŠ¨ã€‘æ¯10ç§’ç”Ÿæˆä¸€ä¸ªæŠµæŒ¡ä¼¤å®³çš„æŠ¤ç›¾', passive: 'shield' },
      'rocket_boots': { type: 'utility', name: 'Liquidity Boots', cost: 800, icon: 'ğŸ‘¢', stats: { spd: 2 }, desc: 'å¢åŠ ç§»åŠ¨é€Ÿåº¦', passive: 'Speed' },
      'comp_interest': { type: 'utility', name: 'Compound Int.', cost: 1500, icon: 'ğŸ“ˆ', stats: {}, desc: 'ã€è¢«åŠ¨ã€‘æ¯ç§’è·å¾— 5 GDP', passive: 'income' },
      'helicopter': { type: 'utility', name: 'Helicopter', cost: 3000, icon: 'ğŸš', stats: { spd: 3 }, desc: 'ã€è¢«åŠ¨ã€‘ç§»åŠ¨æ—¶ç•™ä¸‹ä¼¤å®³è·¯å¾„', passive: 'trail' }
    };

    /* ====== æ ¸å¿ƒå˜é‡ ====== */
    let state = {
      screen: 'menu', 
      score: 1000, 
      frame: 0,
      player: null,
      bullets: [],
      enemies: [],
      particles: [],
      texts: [],
      inventory: [], 
      selectedChar: 'powell',
      difficulty: 1
    };
    const input = { mouse: {x:0,y:0}, mouseDown: false };
    let canvas, ctx, width, height;

    /* ====== å¼•æ“åˆå§‹åŒ– ====== */
    window.onload = () => {
      canvas = document.getElementById('gameCanvas');
      ctx = canvas.getContext('2d');
      resize();
      window.addEventListener('resize', resize);
      
      // åŠ¨æ€èƒŒæ™¯å¾ªç¯ (Menu BG)
      bgLoop();
      
      // é»˜è®¤é€‰ä¸­
      filterChars('banker');
      updateDetailPanel('powell');
    };

    function resize() { 
      width = canvas.width = window.innerWidth; 
      height = canvas.height = window.innerHeight; 
    }

    // èƒŒæ™¯å¾ªç¯
    let bgFrame = 0;
    function bgLoop() {
      requestAnimationFrame(bgLoop);
      if (state.screen !== 'playing') {
        drawCyberBackground();
      } else {
        gameLoop(); 
      }
      bgFrame++;
    }
    
    // æ¸¸æˆå¾ªç¯
    function gameLoop() {
      update();
      render();
      state.frame++;
    }

    function drawCyberBackground() {
      ctx.fillStyle = '#050505';
      ctx.fillRect(0,0,width,height);
      const pY = (bgFrame * 2) % 100;
      ctx.strokeStyle = 'rgba(0, 243, 255, 0.2)'; ctx.lineWidth = 1; ctx.beginPath();
      let horizonY = height * 0.3;
      for(let i = -width; i < width*2; i+=100) { ctx.moveTo(i, height); ctx.lineTo(width/2 + (i-width/2)*0.1, horizonY); }
      for(let i = 0; i < height; i+=40) { let y = i + pY; if(y > horizonY && y < height) { ctx.moveTo(0, y); ctx.lineTo(width, y); } }
      ctx.stroke();
    }

    /* ====== é€‰äººé€»è¾‘ ====== */
    function goToCharSelect() {
      document.getElementById('screen-rules').classList.add('hidden');
      document.getElementById('screen-char').classList.remove('hidden');
    }

    function filterChars(cat) {
      const tabs = document.querySelectorAll('.tab-btn');
      tabs.forEach(t => t.classList.remove('active'));
      if(event && event.target) event.target.classList.add('active');

      const container = document.getElementById('char-list-container');
      container.innerHTML = '';
      
      for (const [id, data] of Object.entries(CHARACTERS)) {
        if (data.cat === cat) {
          const div = document.createElement('div');
          div.className = `char-mini-card ${id === state.selectedChar ? 'selected' : ''}`;
          div.id = `card-${id}`; 
          div.onclick = () => selectChar(id);
          
          div.innerHTML = `
            <img src="https://api.dicebear.com/9.x/avataaars/svg?seed=${data.name.replace(/ /g,'')}&backgroundColor=b6e3f4,c0aede,d1d4f9" class="mini-avatar">
            <div class="mini-name">${data.name.split(' ')[0]}</div>
          `;
          container.appendChild(div);
        }
      }
    }

    function selectChar(id) {
      state.selectedChar = id;
      document.querySelectorAll('.char-mini-card').forEach(c => c.classList.remove('selected'));
      const card = document.getElementById(`card-${id}`);
      if(card) card.classList.add('selected');
      updateDetailPanel(id);
    }

    function updateDetailPanel(id) {
      const d = CHARACTERS[id];
      if(!d) return;

      document.getElementById('detail-name').innerText = d.name;
      document.getElementById('detail-title').innerText = d.title;
      document.getElementById('detail-avatar').src = `https://api.dicebear.com/9.x/avataaars/svg?seed=${d.name.replace(/ /g,'')}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
      
      document.getElementById('bar-hp').style.width = (d.hp * 10) + '%';
      document.getElementById('bar-atk').style.width = (d.atk * 10) + '%';
      document.getElementById('bar-spd').style.width = (d.spd * 10) + '%';
      document.getElementById('bar-rate').style.width = (d.rate * 8) + '%';
      
      const updateSkill = (key) => {
        const nameEl = document.getElementById(`skill-${key}-name`);
        const descEl = document.getElementById(`skill-${key}-desc`);
        if(nameEl) nameEl.innerText = d[key] || 'Tactical';
        if(descEl) descEl.innerText = d[key+'Desc'] || 'Special Ability';
      };
      
      updateSkill('q'); updateSkill('w'); updateSkill('e'); updateSkill('r');
    }

    function startGame() {
      const d = CHARACTERS[state.selectedChar];
      
      state.player = {
        x: width/2, y: height/2,
        baseHp: d.hp * 20, hp: d.hp * 20, maxHp: d.hp * 20,
        baseSpd: d.spd * 0.8 + 2,
        baseDmg: d.atk * 0.8 + 1,
        baseRate: Math.max(4, 40 - (d.rate * 3)),
        color: d.color, r: 20, moving: false, targetX: 0, targetY: 0,
        cd: {q:0, w:0, e:0, r:0},
        img: new Image()
      };
      state.player.img.src = `https://api.dicebear.com/9.x/avataaars/svg?seed=${d.name.replace(/ /g,'')}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
      
      state.bullets = []; state.enemies = []; state.particles = []; state.texts = [];
      state.score = 1000;
      state.inventory = [];
      
      document.getElementById('screen-char').classList.add('hidden');
      document.getElementById('ui-layer').classList.remove('hidden');
      
      // Init Shop
      const shopContainer = document.getElementById('shop-items-container');
      shopContainer.innerHTML = '';
      for(const [id, item] of Object.entries(ITEMS)) {
        shopContainer.innerHTML += `
          <div class="shop-item-card" onclick="buyItem('${id}')">
            <div style="font-size:2rem">${item.icon}</div>
            <div class="shop-item-name">${item.name}</div>
            <div class="shop-item-cost">$${item.cost}</div>
            <div class="shop-item-desc">${item.desc}</div>
            <span class="shop-item-type">${item.type}</span>
          </div>
        `;
      }

      state.screen = 'playing';
      // Force focus to allow key inputs immediately
      window.focus();
      if(document.activeElement) document.activeElement.blur();
    }

    /* ====== æ¸¸æˆé€»è¾‘ ====== */
    function update() {
      const p = state.player;
      if (!p || p.hp <= 0) return;

      // Stats Recalc
      let spdMod = 0, dmgMod = 0, hpMod = 0, rateMod = 1;
      let passives = [];
      state.inventory.forEach(itemId => {
        const item = ITEMS[itemId];
        if(item.stats.spd) spdMod += item.stats.spd;
        if(item.stats.dmg) dmgMod += item.stats.dmg;
        if(item.stats.maxHp) hpMod += item.stats.maxHp;
        if(item.stats.rate) rateMod *= item.stats.rate;
        if(item.passive) passives.push(item.passive);
      });
      
      p.maxHp = p.baseHp + hpMod; 
      const currentSpd = p.baseSpd + spdMod;
      const currentDmg = p.baseDmg + dmgMod;
      const currentRate = p.baseRate * rateMod;

      // Passives
      if(state.frame % 60 === 0 && passives.includes('income')) { state.score += 5; spawnFloatingText(p.x, p.y-20, "+5 GDP", "#ffee00"); }
      if(state.frame % 60 === 0 && passives.includes('hpRegen')) p.hp = Math.min(p.hp+0.5, p.maxHp);
      if(state.frame % 600 === 0 && passives.includes('shield')) { p.shield = true; spawnFloatingText(p.x, p.y, "SHIELD", "#00ff9d"); }

      // Movement
      if (p.moving) {
        let dx = p.targetX - p.x, dy = p.targetY - p.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < currentSpd) { p.x = p.targetX; p.y = p.targetY; p.moving = false; }
        else { p.x += (dx/dist)*currentSpd; p.y += (dy/dist)*currentSpd; }
        
        if(passives.includes('trail') && state.frame % 10 === 0) createParticles(p.x, p.y, '#ff9900', 2);
      }
      p.x = Math.max(20, Math.min(width-20, p.x));
      p.y = Math.max(20, Math.min(height-20, p.y));

      // Aim
      p.angle = Math.atan2(input.mouse.y - p.y, input.mouse.x - p.x);

      // Cooldowns & HUD
      for(let k in p.cd) if(p.cd[k]>0) p.cd[k]--;
      updateHUD();

      // Attack
      if(input.mouseDown && state.frame % Math.ceil(currentRate) === 0) {
        shootBullet(p, currentDmg, passives.includes('homing'));
      }

      // Bullets
      for(let i=state.bullets.length-1; i>=0; i--) {
        let b = state.bullets[i];
        if(b.homing && state.enemies.length>0) {
           let nearest = state.enemies[0];
           let minD = 9999;
           state.enemies.forEach(e => {
             let d = Math.hypot(e.x - b.x, e.y - b.y);
             if(d < minD) { minD = d; nearest = e; }
           });
           let angle = Math.atan2(nearest.y - b.y, nearest.x - b.x);
           b.vx = b.vx*0.9 + Math.cos(angle)*2; b.vy = b.vy*0.9 + Math.sin(angle)*2;
        }
        b.x += b.vx; b.y += b.vy; b.life--;
        if(b.life<=0) state.bullets.splice(i,1);
      }

      // Enemies
      let difficultyMultiplier = state.difficulty || 1;
      if(state.frame % Math.floor(60/difficultyMultiplier) === 0) spawnEnemy();
      
      for(let i=state.enemies.length-1; i>=0; i--) {
        let e = state.enemies[i];
        let angle = Math.atan2(p.y - e.y, p.x - e.x);
        e.x += Math.cos(angle)*e.speed; e.y += Math.sin(angle)*e.speed;

        // Hit Player
        if(Math.hypot(p.x-e.x, p.y-e.y) < p.r+e.r) {
          if(p.shield) { 
             p.shield = false; spawnFloatingText(p.x, p.y, "BLOCKED", "#fff"); 
             e.x -= Math.cos(angle)*50; e.y -= Math.sin(angle)*50; 
          } else { 
             p.hp -= 10; createParticles(p.x, p.y, '#ff0000', 10); 
             if(p.hp <= 0) gameOver(); 
          }
          state.enemies.splice(i,1); continue;
        }

        // Bullet Hit
        for(let j=state.bullets.length-1; j>=0; j--) {
          let b = state.bullets[j];
          if(Math.hypot(b.x-e.x, b.y-e.y) < e.r+5) {
             e.hp -= b.dmg; state.bullets.splice(j,1);
             if(e.hp<=0) {
               state.score += e.val; spawnFloatingText(e.x, e.y, `+$${e.val}`, "#00ff9d");
               state.enemies.splice(i,1); createParticles(e.x, e.y, e.color, 8); break;
             }
          }
        }
      }
      updateParticles();
    }

    function render() {
      // Background (Cyber Grid in game)
      ctx.fillStyle = '#050505'; ctx.fillRect(0,0,width,height);
      const pY = (state.frame * 2) % 100;
      ctx.strokeStyle = 'rgba(0, 243, 255, 0.1)'; ctx.lineWidth = 1; ctx.beginPath();
      let horizonY = height * 0.3;
      for(let i=0; i<width; i+=100) { ctx.moveTo(i,0); ctx.lineTo(i,height); } 
      for(let i=0; i<height; i+=40) { let y = (i + pY) % height; ctx.moveTo(0,y); ctx.lineTo(width,y); } 
      ctx.stroke();

      const p = state.player;
      if(!p) return;

      if(p.moving) {
        ctx.strokeStyle='#00ff00'; ctx.beginPath(); 
        ctx.moveTo(p.targetX-5, p.targetY-5); ctx.lineTo(p.targetX+5, p.targetY+5);
        ctx.moveTo(p.targetX+5, p.targetY-5); ctx.lineTo(p.targetX-5, p.targetY+5);
        ctx.stroke();
      }

      ctx.save(); ctx.translate(p.x, p.y);
      if(p.shield) { ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0,25,0,Math.PI*2); ctx.stroke(); }
      if(p.img && p.img.complete) {
        ctx.save(); ctx.beginPath(); ctx.arc(0,0,20,0,Math.PI*2); ctx.clip();
        ctx.drawImage(p.img, -20, -20, 40, 40); ctx.restore();
        ctx.strokeStyle=p.color; ctx.lineWidth=2; ctx.stroke();
      } else {
        ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(0,0,20,0,Math.PI*2); ctx.fill();
      }
      // HP Bar
      ctx.fillStyle="red"; ctx.fillRect(-20, 25, 40, 4);
      ctx.fillStyle="#00ff00"; ctx.fillRect(-20, 25, 40*(Math.max(0,p.hp)/p.maxHp), 4);
      ctx.restore();

      state.enemies.forEach(e=>{ ctx.fillStyle=e.color; ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill(); });
      state.bullets.forEach(b=>{ ctx.fillStyle=b.color; ctx.beginPath(); ctx.arc(b.x,b.y,4,0,Math.PI*2); ctx.fill(); });
      state.particles.forEach(pt=>{ ctx.fillStyle=pt.color; ctx.globalAlpha=pt.life/30; ctx.beginPath(); ctx.arc(pt.x,pt.y,pt.size,0,Math.PI*2); ctx.fill(); });
      ctx.globalAlpha=1;
      ctx.fillStyle="#fff"; ctx.font="bold 14px monospace";
      state.texts.forEach(t=>ctx.fillText(t.text, t.x, t.y));
    }

    /* ====== Helpers ====== */
    window.addEventListener('keydown', e => {
      if(e.key.toLowerCase() === 'a') input.mouseDown = true;
      if(state.screen === 'playing') {
         if('qwer'.includes(e.key.toLowerCase())) useSkill(e.key.toLowerCase());
         if(e.key.toLowerCase() === 'b') toggleShop();
         if(e.key === 'Escape') togglePause();
      } else if(state.screen === 'shop' && e.key.toLowerCase() === 'b') toggleShop();
    });
    window.addEventListener('keyup', e => { if(e.key.toLowerCase() === 'a') input.mouseDown = false; });
    window.addEventListener('mousemove', e => { input.mouse.x = e.clientX; input.mouse.y = e.clientY; });
    window.addEventListener('mousedown', e => { if(e.button===0) input.mouseDown = true; if(e.button===2 && state.player) {
      state.player.moving = true; state.player.targetX = e.clientX; state.player.targetY = e.clientY;
    }});
    window.addEventListener('mouseup', () => input.mouseDown = false);
    window.addEventListener('contextmenu', e => e.preventDefault());

    function setDifficulty(val, el) {
      state.difficulty = val;
      document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
      el.classList.add('active');
    }
    function togglePause() {
      if(state.screen === 'playing') { state.screen = 'paused'; document.getElementById('pause-menu').classList.remove('hidden'); }
      else if(state.screen === 'paused') { state.screen = 'playing'; document.getElementById('pause-menu').classList.add('hidden'); }
    }
    function toggleShop() {
      if(state.screen === 'playing') { 
          state.screen = 'shop'; 
          document.getElementById('shop-menu').classList.remove('hidden'); 
          // Fix: Update GDP display immediately when opening shop
          document.getElementById('shop-current-gdp').innerText = '$' + Math.floor(state.score);
      }
      else if(state.screen === 'shop') { 
          state.screen = 'playing'; 
          document.getElementById('shop-menu').classList.add('hidden'); 
      }
    }
    function gameOver() {
      state.screen = 'over';
      document.getElementById('game-over').classList.remove('hidden');
      document.getElementById('final-score').innerText = state.score;
    }
    
    /* ====== Skill & Inventory ====== */
    function spawnEnemy() {
      let angle = Math.random() * Math.PI * 2;
      let r = Math.max(width, height) / 2 + 50;
      state.enemies.push({
        x: width/2 + Math.cos(angle)*r, y: height/2 + Math.sin(angle)*r,
        hp: 10 * (state.difficulty || 1), speed: 2, r: 15, color: '#ff0055', val: 50
      });
    }
    function shootBullet(p, dmg, homing) {
      state.bullets.push({
        x: p.x, y: p.y,
        vx: Math.cos(p.angle) * 15, vy: Math.sin(p.angle) * 15,
        life: 60, color: p.color, dmg: dmg, homing: homing
      });
    }
    function useSkill(key) {
      const p = state.player;
      if(p.cd[key]>0) return;
      p.cd[key] = key==='q'?120 : key==='w'?300 : key==='e'?180 : 900;
      
      if(key === 'e') { // Dash
        p.x += Math.cos(p.angle)*200; p.y += Math.sin(p.angle)*200; p.targetX = p.x;
        createParticles(p.x, p.y, '#fff', 10);
      } else if(key === 'q') { // Burst
        for(let i=-0.5; i<=0.5; i+=0.2) shootBullet({...p, angle: p.angle+i}, p.baseDmg*1.5, false);
      } else if(key === 'w') { // Shield/AoE
        state.enemies.forEach(e => { if(Math.hypot(p.x-e.x, p.y-e.y)<200) { e.x -= Math.cos(Math.atan2(p.y-e.y, p.x-e.x))*150; } });
        createParticles(p.x, p.y, '#00f3ff', 20);
      } else if(key === 'r') { // Ult
        state.enemies = [];
        spawnFloatingText(width/2, height/2, "ULTIMATE!", "#ffee00");
      }
    }
    function buyItem(id) {
      const item = ITEMS[id];
      if(state.score >= item.cost) {
        if(state.inventory.length < 6) {
          state.score -= item.cost;
          state.inventory.push(id);
          document.getElementById('shop-current-gdp').innerText = '$' + Math.floor(state.score);
          spawnFloatingText(width/2, height/2, "PURCHASED!", "#00ff9d");
        } else { alert("Inventory Full!"); }
      } else { alert("Not enough GDP!"); }
    }
    
    function updateHUD() {
      const p = state.player;
      if(!p) return;
      document.getElementById('score-val').innerText = Math.floor(state.score);
      document.getElementById('health-val').innerText = Math.floor(p.hp);
      ['q','w','e','r'].forEach(k => {
         let cd = p.cd[k];
         let el = document.querySelector(`#skill-${k} .cooldown-overlay`);
         if(cd > 0) { el.style.height = "100%"; el.querySelector('span').innerText = Math.ceil(cd/60); }
         else { el.style.height = "0%"; el.querySelector('span').innerText = ""; }
      });
      const slots = document.querySelectorAll('.item-slot');
      state.inventory.forEach((id, i) => {
        if(slots[i].classList.contains('empty')) {
           const item = ITEMS[id];
           slots[i].innerHTML = item.icon;
           slots[i].classList.remove('empty');
        }
      });
    }

    /* ====== Tooltip Logic (Unified) ====== */
    function showSelectTooltip(el, key) {
      const d = CHARACTERS[state.selectedChar];
      showTooltipBase(el, d[key]||key, d[key+'Desc'], d[key+'Info']);
    }
    function showGameTooltip(el, key) {
      const d = CHARACTERS[state.selectedChar];
      showTooltipBase(el, d[key], d[key+'Desc'], d[key+'Info']);
    }
    function showTooltipBase(el, title, desc, info) {
      const tt = document.getElementById('global-tooltip');
      document.getElementById('tt-title').innerText = title;
      document.getElementById('tt-desc').innerText = desc;
      document.getElementById('tt-info').innerHTML = `<span>${info||''}</span>`;
      const r = el.getBoundingClientRect();
      tt.style.left = (r.left+20)+'px'; tt.style.top = (r.top-120)+'px';
      tt.style.display = 'block';
    }
    function hideTooltip() { document.getElementById('global-tooltip').style.display = 'none'; }

    function createParticles(x,y,c,n) { for(let i=0;i<n;i++) state.particles.push({x,y,vx:(Math.random()-.5)*10,vy:(Math.random()-.5)*10,life:30,color:c,size:Math.random()*3}); }
    function spawnFloatingText(x,y,t,c='#fff') { state.texts.push({x,y,text:t,color:c,life:60}); }
    function updateParticles() { 
      for(let i=state.particles.length-1;i>=0;i--){ let p=state.particles[i]; p.x+=p.vx; p.y+=p.vy; p.life--; if(p.life<=0) state.particles.splice(i,1); }
      for(let i=state.texts.length-1;i>=0;i--){ let t=state.texts[i]; t.y--; t.life--; if(t.life<=0) state.texts.splice(i,1); }
    }
  </script>
</body>
</html>
