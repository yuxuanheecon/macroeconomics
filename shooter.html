<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Macro Defender 4.1 | Earth Macro</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    /* ====== åŸºç¡€æ ·å¼ ====== */
    body {
      margin: 0; overflow: hidden; background: #050505; color: white; font-family: 'JetBrains Mono', monospace;
      user-select: none; cursor: crosshair;
    }
    
    .scanlines {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 50;
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
      background-size: 100% 4px;
    }

    /* ====== UI å±‚ ====== */
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
      display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box;
      z-index: 10;
    }

    /* é¡¶éƒ¨ HUD */
    .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .hud-left { display: flex; gap: 15px; }
    .hud-right { display: flex; gap: 10px; pointer-events: auto; } /* å…è®¸ç‚¹å‡»æŒ‰é’® */

    .stat-box { text-shadow: 0 0 10px currentColor; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 4px; border: 1px solid #333; }
    .label { font-size: 0.7rem; color: #888; display: block; letter-spacing: 1px; margin-bottom: 2px; }
    .value { font-family: 'Share Tech Mono'; font-size: 1.5rem; font-weight: bold; }
    #score-val { color: #00ff9d; }
    #health-val { color: #00f3ff; }
    #cycle-val { color: #ffee00; }

    .hud-btn {
      background: rgba(0,0,0,0.6); border: 1px solid #555; color: #aaa;
      padding: 8px 15px; cursor: pointer; font-family: 'JetBrains Mono'; font-size: 0.8rem;
      transition: all 0.2s; border-radius: 4px;
    }
    .hud-btn:hover { border-color: #fff; color: #fff; background: rgba(255,255,255,0.1); }

    /* åº•éƒ¨ HUD (æŠ€èƒ½ + è£…å¤‡) */
    .hud-bottom { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; pointer-events: auto; }
    
    .skill-panel { display: flex; gap: 10px; align-items: center; }
    .skill-slot {
      width: 60px; height: 60px; border: 2px solid #444; background: rgba(0,0,0,0.7);
      position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center;
      border-radius: 8px; transition: all 0.1s; overflow: hidden; cursor: help;
    }
    .skill-slot.ready { border-color: var(--color); box-shadow: 0 0 10px var(--color); }
    .skill-slot.cooldown { border-color: #333; opacity: 0.6; filter: grayscale(1); }
    .skill-key { position: absolute; top: 2px; left: 2px; background: #000; border: 1px solid #555; color: #fff; font-size: 0.6rem; padding: 1px 4px; border-radius: 2px; }
    .skill-icon { font-size: 1.5rem; }
    .cooldown-overlay {
      position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8);
      height: 0%; transition: height 0.1s linear; display: flex; justify-content: center; align-items: center;
    }
    .cooldown-text { color: white; font-weight: bold; font-size: 1rem; font-family: 'Share Tech Mono'; }

    /* è£…å¤‡æ  */
    .inventory-panel { display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 5px; border: 1px solid #333; border-radius: 6px; }
    .item-slot {
      width: 40px; height: 40px; border: 1px solid #444; background: rgba(0,0,0,0.8);
      display: flex; justify-content: center; align-items: center; font-size: 1.2rem; position: relative;
      cursor: help;
    }
    .item-slot img { width: 100%; height: 100%; object-fit: cover; }
    .item-slot.empty { color: #222; font-size: 0.8rem; }

    .shop-hint { margin-left: 15px; color: #ffee00; border: 1px solid #ffee00; padding: 8px; font-size: 0.8rem; animation: pulse 2s infinite; cursor: pointer; }
    @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

    /* Tooltip */
    .tooltip {
      position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%);
      background: rgba(12, 18, 24, 0.98); border: 1px solid var(--neon-blue);
      padding: 15px; border-radius: 8px; width: 320px; pointer-events: none;
      display: none; text-align: left; box-shadow: 0 0 30px rgba(0,0,0,0.8); z-index: 100;
    }
    .tooltip h4 { margin: 0 0 8px 0; color: #00f3ff; font-size: 1rem; font-family: 'Share Tech Mono'; border-bottom: 1px solid #333; padding-bottom: 5px; }
    .tooltip p { margin: 0 0 8px 0; color: #ccc; font-size: 0.8rem; line-height: 1.4; }
    .tooltip .stats { color: #888; font-size: 0.75rem; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    .tooltip .stats span { color: #fff; }
    .tooltip .passive { color: #ffee00; font-size: 0.75rem; margin-top: 8px; font-style: italic; }

    /* ====== æ¨¡æ€çª—å£ ====== */
    .modal {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(5,5,8,0.98); display: flex; flex-direction: column;
      z-index: 100; pointer-events: auto; overflow-y: auto;
    }
    .hidden { display: none !important; }
    .modal-content { width: 100%; max-width: 1200px; margin: 0 auto; padding: 30px; display: flex; flex-direction: column; height: 100%; align-items: center; }

    h1 { font-family: 'Share Tech Mono'; font-size: 2.5rem; color: #00f3ff; text-shadow: 0 0 20px #00f3ff; margin: 10px 0; }
    
    /* é€šç”¨æŒ‰é’® */
    .btn {
      background: transparent; border: 2px solid #00ff9d; color: #00ff9d;
      padding: 10px 25px; font-size: 1rem; font-family: 'Share Tech Mono';
      cursor: pointer; box-shadow: 0 0 15px rgba(0,255,157,0.2); transition: all 0.2s;
      margin: 5px;
    }
    .btn:hover { background: #00ff9d; color: black; box-shadow: 0 0 30px rgba(0,255,157,0.4); transform: scale(1.05); }
    .btn-red { border-color: #ff0055; color: #ff0055; }
    .btn-red:hover { background: #ff0055; color: white; }

    /* è§„åˆ™é¡µ */
    .rules-box {
      background: rgba(255,255,255,0.05); padding: 30px; border-radius: 8px; border: 1px solid #333;
      max-width: 800px; width: 100%; margin-bottom: 30px; text-align: left; line-height: 1.8;
    }
    .rules-box h3 { color: #ffee00; margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; }
    .key-tag { background: #333; border: 1px solid #666; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; color: #fff; font-family: monospace; margin: 0 3px; }
    
    .diff-select { display: flex; gap: 10px; margin-bottom: 30px; justify-content: center; width: 100%; }
    .diff-btn { padding: 10px 30px; border: 1px solid #555; color: #555; cursor: pointer; font-family: 'JetBrains Mono'; border-radius: 4px; }
    .diff-btn:hover { border-color: #fff; color: #fff; }
    .diff-btn.active { border-color: #00f3ff; color: #00f3ff; box-shadow: 0 0 10px #00f3ff; background: rgba(0, 243, 255, 0.1); font-weight: bold; }

    /* é€‰äººé¡µ */
    .category-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; width: 100%; }
    .tab-btn {
      padding: 8px 20px; background: rgba(255,255,255,0.05); border: 1px solid #444; color: #888;
      cursor: pointer; font-family: 'JetBrains Mono'; font-size: 0.9rem; transition: all 0.2s;
      border-radius: 4px;
    }
    .tab-btn:hover { border-color: #fff; color: #fff; }
    .tab-btn.active { background: rgba(0, 243, 255, 0.15); border-color: #00f3ff; color: #00f3ff; font-weight: bold; box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }

    .char-selection-area { display: flex; gap: 20px; flex: 1; width: 100%; overflow: hidden; }
    .char-list { 
      flex: 2; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
      gap: 10px; overflow-y: auto; align-content: start; padding-right: 5px;
      border: 1px solid #333; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;
    }
    .char-detail-panel { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #444; padding: 20px; overflow-y: auto; min-width: 300px; display:flex; flex-direction:column; align-items:center; }
    
    .char-mini-card { background: rgba(255,255,255,0.05); border: 1px solid #444; padding: 10px; cursor: pointer; text-align: center; border-radius: 8px; }
    .char-mini-card:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .char-mini-card.selected { border-color: #ffee00; background: rgba(255,238,0,0.15); box-shadow: inset 0 0 10px rgba(255,238,0,0.2); }
    .mini-avatar { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 5px; background: #000; object-fit: cover; }
    .mini-name { font-size: 0.7rem; font-weight: bold; color: #eee; line-height: 1.2; }

    .stat-bar { height: 4px; background: #333; width: 100%; margin-top: 3px; }
    .stat-fill { height: 100%; background: #00f3ff; }
    
    .skill-list { width: 100%; text-align: left; font-size: 0.85rem; margin-top: 20px; }
    .skill-item { margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 8px; }
    .skill-item strong { color: #fff; font-size: 0.9rem; display: block; margin-bottom: 2px; }
    .skill-item span { font-size: 0.75rem; color: #888; }
    .key-badge { display: inline-block; background: #333; color: #fff; padding: 1px 4px; border-radius: 2px; font-size: 0.7rem; margin-right: 5px; }

    /* å•†åº—ç•Œé¢ */
    #shop-menu h1 { border-bottom: 2px solid #333; width: 100%; text-align: center; padding-bottom: 10px; }
    .shop-container { display: flex; width: 100%; height: 100%; gap: 20px; overflow: hidden; }
    .shop-tabs { display: flex; flex-direction: column; gap: 10px; width: 150px; }
    .shop-tab { padding: 15px; background: #111; color: #666; cursor: pointer; border-left: 3px solid transparent; transition: 0.2s; font-family: 'JetBrains Mono'; }
    .shop-tab:hover { color: #fff; background: #222; }
    .shop-tab.active { border-left-color: #00f3ff; color: #00f3ff; background: #1a1a2a; font-weight: bold; }
    .shop-items { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; overflow-y: auto; align-content: start; padding: 10px; }
    .shop-item-card { background: rgba(255,255,255,0.05); border: 1px solid #444; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center; transition: 0.2s; position: relative; cursor: pointer; }
    .shop-item-card:hover { border-color: #00f3ff; transform: translateY(-3px); background: rgba(255,255,255,0.08); }
    .shop-item-icon { font-size: 2rem; margin-bottom: 10px; }
    .shop-item-name { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; color: #fff; }
    .shop-item-cost { color: #ffee00; font-size: 0.9rem; font-family: 'Share Tech Mono'; margin-bottom: 10px; }
    .shop-item-desc { font-size: 0.7rem; color: #888; line-height: 1.3; height: 40px; overflow: hidden; }
    .shop-buy-btn { margin-top: 10px; width: 100%; padding: 5px; font-size: 0.8rem; }
    .shop-inventory { width: 100%; border-top: 1px solid #333; padding-top: 15px; display: flex; justify-content: space-between; align-items: center; }

    .floating-text { position: absolute; font-weight: bold; pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 20; text-shadow: 1px 1px 2px black; font-size: 0.9rem; }
    @keyframes floatUp { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-30px); opacity: 0; } }
  </style>
</head>
<body>

  <canvas id="gameCanvas"></canvas>
  <div class="scanlines"></div>

  <!-- æ¸¸æˆå†… HUD (Start hidden) -->
  <div id="ui-layer" class="hidden">
    <div class="hud-top">
      <div class="hud-left">
        <div class="stat-box"><span class="label">GDP (GOLD)</span><div class="value" id="score-val">0</div></div>
        <div class="stat-box"><span class="label">CYCLE</span><div class="value" id="cycle-val">-</div></div>
        <div class="stat-box"><span class="label">LIQUIDITY (HP)</span><div class="value" id="health-val">100%</div></div>
      </div>
      <div class="hud-right">
        <div class="hud-btn" onclick="togglePause()">â¸ï¸ PAUSE</div>
        <div class="hud-btn" onclick="location.reload()">ğŸ”„ RESTART</div>
      </div>
    </div>

    <div class="hud-bottom">
      <!-- æŠ€èƒ½æç¤ºæ¡† (Tooltip) -->
      <div id="tooltip" class="tooltip">
        <h4 id="tt-title">Skill Name</h4>
        <p id="tt-desc">Description</p>
        <div class="stats" id="tt-stats"></div>
        <div class="passive" id="tt-passive"></div>
      </div>

      <div style="display:flex; align-items:flex-end; gap:20px; width:100%; justify-content:center;">
        <div class="skill-panel">
          <div class="skill-slot" style="--color:#fff; border-color:#fff;">
            <span class="skill-key">A</span><span class="skill-icon">ğŸ”«</span>
          </div>
          <div class="skill-slot" id="skill-q" style="--color:#00f3ff" onmouseenter="showSkillTooltip('q')" onmouseleave="hideTooltip()">
            <span class="skill-key">Q</span><span class="skill-icon">ğŸ’ </span>
            <div class="cooldown-overlay"><span class="cooldown-text"></span></div>
          </div>
          <div class="skill-slot" id="skill-w" style="--color:#00ff9d" onmouseenter="showSkillTooltip('w')" onmouseleave="hideTooltip()">
            <span class="skill-key">W</span><span class="skill-icon">ğŸ›¡ï¸</span>
            <div class="cooldown-overlay"><span class="cooldown-text"></span></div>
          </div>
          <div class="skill-slot" id="skill-e" style="--color:#ffee00" onmouseenter="showSkillTooltip('e')" onmouseleave="hideTooltip()">
            <span class="skill-key">E</span><span class="skill-icon">âš¡</span>
            <div class="cooldown-overlay"><span class="cooldown-text"></span></div>
          </div>
          <div class="skill-slot" id="skill-r" style="--color:#ff0055" onmouseenter="showSkillTooltip('r')" onmouseleave="hideTooltip()">
            <span class="skill-key">R</span><span class="skill-icon">â˜¢ï¸</span>
            <div class="cooldown-overlay"><span class="cooldown-text"></span></div>
          </div>
        </div>
        
        <!-- è£…å¤‡æ  -->
        <div class="inventory-panel" id="inventory-display">
          <div class="item-slot empty" data-idx="0"></div>
          <div class="item-slot empty" data-idx="1"></div>
          <div class="item-slot empty" data-idx="2"></div>
          <div class="item-slot empty" data-idx="3"></div>
          <div class="item-slot empty" data-idx="4"></div>
          <div class="item-slot empty" data-idx="5"></div>
        </div>
        
        <div class="shop-hint" onclick="toggleShop()">SHOP [B]</div>
      </div>
    </div>
  </div>

  <!-- 1. è§„åˆ™/éš¾åº¦ç•Œé¢ -->
  <div id="screen-rules" class="modal">
    <div class="modal-content" style="justify-content:center;">
      <h1>MACRO DEFENDER 4.1</h1>
      <p class="subtitle">Global Economy Defense Initiative</p>

      <div class="rules-box">
        <h3>ğŸ”° ä»»åŠ¡ç®€æŠ¥ (Mission Briefing)</h3>
        <p>
          1. <strong>é€‰æ‹©é¢†è¢–</strong>ï¼šä»å¤®è¡Œã€æ”¿ç•Œã€åå°”è¡—æˆ–ç§‘æŠ€ç•Œé€‰æ‹©ä½ çš„è‹±é›„ã€‚<br>
          2. <strong>æ“ä½œæ–¹å¼</strong>ï¼š<span class="key-tag">é¼ æ ‡å³é”®</span> ç§»åŠ¨ï¼Œ<span class="key-tag">A</span> é”®æ™®æ”»ï¼Œ<span class="key-tag">QWER</span> é‡Šæ”¾æŠ€èƒ½ã€‚<br>
          3. <strong>é˜²å¾¡ç›®æ ‡</strong>ï¼šå‡»é€€é€šèƒ€æ¶é­”ä¸èµ„äº§æ³¡æ²«ï¼Œä¿æŠ¤å…¨çƒæµåŠ¨æ€§(HP)ã€‚<br>
          4. <strong>ç»æµç³»ç»Ÿ</strong>ï¼šå‡»æ€æ•Œäººè·å¾— GDPï¼ŒæŒ‰ <span class="key-tag">B</span> é”®è´­ä¹°å¼ºåŒ–è£…å¤‡ã€‚
        </p>
      </div>

      <p style="margin-bottom:10px; color:#fff;">SELECT DIFFICULTY</p>
      <div class="diff-select">
        <div class="diff-btn" onclick="setDifficulty(0.8, this)">EASY (ç®€å•)</div>
        <div class="diff-btn active" onclick="setDifficulty(1, this)">NORMAL (æ™®é€š)</div>
        <div class="diff-btn" onclick="setDifficulty(1.5, this)">HARD (å›°éš¾)</div>
      </div>

      <button class="btn" style="width:300px; margin-top:20px;" onclick="goToCharSelect()">NEXT: SELECT HERO</button>
    </div>
  </div>

  <!-- 2. é€‰äººç•Œé¢ -->
  <div id="screen-char" class="modal hidden">
    <div class="modal-content">
      <h1>SELECT YOUR HERO</h1>
      
      <!-- åˆ†ç±» Tab -->
      <div class="category-tabs" id="category-tabs">
        <div class="tab-btn active" onclick="filterChars('banker')">ğŸ›ï¸ å¤®è¡Œå½“å±€</div>
        <div class="tab-btn" onclick="filterChars('politician')">ğŸ¦… å›½å®¶é¢†è¢–</div>
        <div class="tab-btn" onclick="filterChars('investor')">ğŸ’¼ åå°”è¡—</div>
        <div class="tab-btn" onclick="filterChars('tech')">ğŸš€ ç§‘æŠ€å·¨å¤´</div>
        <div class="tab-btn" onclick="filterChars('org')">ğŸŒ å›½é™…ç»„ç»‡</div>
      </div>

      <div class="char-selection-area">
        <!-- å·¦ä¾§åˆ—è¡¨ -->
        <div class="char-list" id="char-list-container">
          <!-- JS ç”Ÿæˆ -->
        </div>

        <!-- å³ä¾§è¯¦æƒ… -->
        <div class="char-detail-panel">
          <img id="detail-avatar" class="detail-avatar" src="" alt="Avatar">
          <div id="detail-name" class="detail-name">Select a Hero</div>
          <div id="detail-title" class="detail-title">--</div>
          
          <div class="stats-grid" style="width:100%; font-size:0.8rem;">
            <div class="stat-row"><span class="stat-label">HP</span><div class="stat-track"><div class="stat-bar" id="bar-hp" style="width:0%"></div></div></div>
            <div class="stat-row"><span class="stat-label">ATK</span><div class="stat-track"><div class="stat-bar" id="bar-atk" style="width:0%"></div></div></div>
            <div class="stat-row"><span class="stat-label">SPD</span><div class="stat-track"><div class="stat-bar" id="bar-spd" style="width:0%"></div></div></div>
            <div class="stat-row"><span class="stat-label">RATE</span><div class="stat-track"><div class="stat-bar" id="bar-rate" style="width:0%"></div></div></div>
          </div>

          <div class="skill-list">
            <div class="skill-item">
              <strong><span class="key-badge">Q</span> <span id="skill-q-name">-</span></strong>
              <span id="skill-q-desc">-</span>
            </div>
            <div class="skill-item">
              <strong><span class="key-badge">W</span> <span id="skill-w-name">-</span></strong>
              <span id="skill-w-desc">-</span>
            </div>
            <div class="skill-item">
              <strong><span class="key-badge">R</span> <span id="skill-r-name">-</span></strong>
              <span id="skill-r-desc">-</span>
            </div>
          </div>

          <button class="start-btn" style="margin-top:auto" onclick="startGame()">DEPLOY</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 3. æš‚åœèœå• -->
  <div id="pause-menu" class="modal hidden">
    <h1>SYSTEM PAUSED</h1>
    <button class="btn" onclick="togglePause()">RESUME</button>
    <button class="btn btn-red" onclick="location.reload()">ABORT MISSION</button>
  </div>

  <!-- 4. å•†åº—ç•Œé¢ -->
  <div id="shop-menu" class="modal hidden">
    <div class="modal-content">
      <h1>GDP STORE</h1>
      <div class="shop-container">
        <div class="shop-tabs">
          <div class="shop-tab active" onclick="filterShop('attack')">âš”ï¸ è¿›æ”»</div>
          <div class="shop-tab" onclick="filterShop('defense')">ğŸ›¡ï¸ é˜²å¾¡</div>
          <div class="shop-tab" onclick="filterShop('utility')">âš¡ åŠŸèƒ½</div>
        </div>
        <div class="shop-items" id="shop-items-container">
          <!-- JS ç”Ÿæˆ -->
        </div>
      </div>
      <div class="shop-inventory">
        <div style="color:#fff">Your GDP: <span id="shop-current-gdp" style="color:#00ff9d">$0</span></div>
        <button class="btn btn-red" onclick="toggleShop()">CLOSE [B]</button>
      </div>
    </div>
  </div>

  <div id="game-over" class="modal hidden">
    <h1 style="color:#ff0055">MARKET CRASH</h1>
    <p>Liquidity Dried Up. Final GDP: <span id="final-score">0</span></p>
    <button class="btn" onclick="location.reload()">REBOOT</button>
  </div>

  <script>
    /* ====== æ•°æ®ä¸­å¿ƒ (40+ Chars) ====== */
    const CHARACTERS = {
      // 1. Bankers
      'powell': { cat: 'banker', name: 'Jerome Powell', title: 'Fed Chair', hp: 7, atk: 4, spd: 5, rate: 8, color: '#00f3ff', q:'Hawk Shot', w:'Rate Shield', r:'Infinite QE', qDesc:'é¹°æ´¾ä¸‰è¿å°„', wDesc:'åŠ æ¯æŠ¤ç›¾å‡»é€€', rDesc:'æ— é™å°é’å…¨å±æ¿€å…‰' },
      'yellen': { cat: 'banker', name: 'Janet Yellen', title: 'Treasury Secretary', hp: 6, atk: 5, spd: 5, rate: 7, color: '#0099ff', q:'Soft Landing', w:'Debt Ceiling', r:'Bailout', qDesc:'å‡é€Ÿå¼¹å¹•', wDesc:'å€ºåŠ¡ä¸Šé™é˜²å¾¡å¡”', rDesc:'å…¨å‘˜å›è¡€' },
      'bernanke': { cat: 'banker', name: 'Ben Bernanke', title: 'Ex-Fed Chair', hp: 6, atk: 3, spd: 4, rate: 9, color: '#00cc99', q:'Helicopter', w:'Stress Test', r:'QE1', qDesc:'ç›´å‡æœºæ’’é’±æ•£å°„', wDesc:'å‹åŠ›æµ‹è¯•æŠ¤ç›¾', rDesc:'é‡åŒ–å®½æ¾è½°ç‚¸' },
      'greenspan': { cat: 'banker', name: 'Alan Greenspan', title: 'The Maestro', hp: 5, atk: 6, spd: 3, rate: 6, color: '#aaaaaa', q:'Fed Put', w:'Irrational Exub', r:'Great Moderation', qDesc:'çœ‹è·ŒæœŸæƒæŠ¤ç›¾', wDesc:'éç†æ€§ç¹è£åŠ é€Ÿ', rDesc:'å¤§ç¼“å’Œå®šèº«' },
      'lagarde': { cat: 'banker', name: 'Christine Lagarde', title: 'ECB President', hp: 6, atk: 5, spd: 5, rate: 6, color: '#3366cc', q:'Euro Bond', w:'Fragmentation', r:'Whatever it takes', qDesc:'æ¬§å…ƒå›æ—‹é•–', wDesc:'ååˆ†è£‚ç«‹åœº', rDesc:'å¼ºåŠ›å…¨å±éœ‡è¡' },
      'draghi': { cat: 'banker', name: 'Mario Draghi', title: 'Super Mario', hp: 7, atk: 6, spd: 6, rate: 7, color: '#0055a4', q:'Bazooka', w:'Euro Shield', r:'Save the Euro', qDesc:'ç«ç®­ç­’é‡å‡»', wDesc:'æ¬§å…ƒç›¾', rDesc:'æ‹¯æ•‘æ¬§å…ƒå…¨å±æ¸…åœº' },
      'kuroda': { cat: 'banker', name: 'Haruhiko Kuroda', title: 'Ex-BOJ Gov', hp: 5, atk: 3, spd: 7, rate: 10, color: '#ff6600', q:'YCC Control', w:'Negative Rate', r:'Super Ease', qDesc:'YCCå®šèº«', wDesc:'è´Ÿåˆ©ç‡åŠ›åœº', rDesc:'è¶…çº§å®½æ¾å¼¹å¹•é›¨' },
      'ueda': { cat: 'banker', name: 'Kazuo Ueda', title: 'BOJ Gov', hp: 6, atk: 4, spd: 6, rate: 8, color: '#ff9933', q:'Rate Hike', w:'Review', r:'Normalization', qDesc:'åŠ æ¯å•ç‚¹', wDesc:'æ”¿ç­–æ£€è®¨å‡é€Ÿ', rDesc:'æ­£å¸¸åŒ–å…‰æŸ' },
      'carney': { cat: 'banker', name: 'Mark Carney', title: 'Ex-BOE Gov', hp: 6, atk: 5, spd: 5, rate: 7, color: '#6600cc', q:'Forward Guidance', w:'Climate Risk', r:'Horizon', qDesc:'å‰ç»æŒ‡å¼•', wDesc:'æ°”å€™é£é™©è¿·é›¾', rDesc:'åœ°å¹³çº¿å†²å‡»' },
      'bailey': { cat: 'banker', name: 'Andrew Bailey', title: 'BOE Gov', hp: 6, atk: 5, spd: 4, rate: 7, color: '#9933ff', q:'Gilt Market', w:'Intervention', r:'Stability', qDesc:'å›½å€ºå†²å‡»', wDesc:'å¹²é¢„æŠ¤ç›¾', rDesc:'é‡‘èç¨³å®š' },
      'yigang': { cat: 'banker', name: 'Yi Gang', title: 'Ex-PBOC Gov', hp: 7, atk: 5, spd: 5, rate: 7, color: '#cc0000', q:'Prudent Policy', w:'FX Reserve', r:'Structural', qDesc:'ç¨³å¥æ”¿ç­–', wDesc:'å¤–æ±‡å‚¨å¤‡ç›¾', rDesc:'ç»“æ„æ€§å·¥å…·' },
      'pan': { cat: 'banker', name: 'Pan Gongsheng', title: 'PBOC Gov', hp: 8, atk: 5, spd: 5, rate: 8, color: '#ff3333', q:'RRR Cut', w:'Swap Line', r:'Cross-Border', qDesc:'é™å‡†å†²å‡»æ³¢', wDesc:'äº’æ¢é€šæŠ¤ç›¾', rDesc:'è·¨å¢ƒæ”¯ä»˜æ´ªæµ' },

      // 2. Politicians
      'biden': { cat: 'politician', name: 'Joe Biden', title: 'US President', hp: 9, atk: 6, spd: 3, rate: 5, color: '#0000cc', q:'Inflation Act', w:'Alliance', r:'Chips Ban', qDesc:'é€šèƒ€æ³•æ¡ˆé‡å‡»', wDesc:'ç›Ÿå‹å¬å”¤', rDesc:'èŠ¯ç‰‡ç¦ä»¤å…¨å±å‡é€Ÿ' },
      'trump': { cat: 'politician', name: 'Donald Trump', title: 'Former President', hp: 8, atk: 9, spd: 5, rate: 6, color: '#ff0000', q:'Tariff Wall', w:'Twitter Storm', r:'Trade War', qDesc:'å…³ç¨å¢™é˜»æŒ¡', wDesc:'æ¨ç‰¹å£°æ³¢æ”»å‡»', rDesc:'è´¸æ˜“æˆ˜æ ¸å¼¹æ¸…å±' },
      'obama': { cat: 'politician', name: 'Barack Obama', title: 'Former President', hp: 8, atk: 5, spd: 6, rate: 7, color: '#0066cc', q:'Stimulus', w:'Obamacare', r:'Hope', qDesc:'åˆºæ¿€è®¡åˆ’', wDesc:'åŒ»ä¿å›è¡€', rDesc:'å¸Œæœ›ä¹‹å…‰' },
      'xi': { cat: 'politician', name: 'Xi Jinping', title: 'President of PRC', hp: 10, atk: 7, spd: 4, rate: 6, color: '#ffcc00', q:'Dual Circulation', w:'Common Prosperity', r:'Belt & Road', qDesc:'åŒå¾ªç¯ç¯ç»•å¼¹', wDesc:'å…±åŒå¯Œè£•å›è¡€', rDesc:'ä¸€å¸¦ä¸€è·¯å¼ºåŠ›å†²é”‹' },
      'liqiang': { cat: 'politician', name: 'Li Qiang', title: 'Premier', hp: 8, atk: 6, spd: 6, rate: 7, color: '#ff9900', q:'Open Up', w:'Service', r:'High Quality', qDesc:'å¼€æ”¾é—¨æˆ·', wDesc:'æœåŠ¡å‹é˜²å¾¡', rDesc:'é«˜è´¨é‡å‘å±•' },
      'putin': { cat: 'politician', name: 'Vladimir Putin', title: 'Russian President', hp: 9, atk: 9, spd: 3, rate: 4, color: '#ffffff', q:'Energy Cut', w:'Iron Curtain', r:'Special Op', qDesc:'èƒ½æºåˆ‡æ–­å†»ç»“', wDesc:'é“å¹•é˜²å¾¡', rDesc:'ç‰¹ç§è¡ŒåŠ¨é«˜çˆ†å¼¹' },
      'macron': { cat: 'politician', name: 'Emmanuel Macron', title: 'French President', hp: 7, atk: 6, spd: 6, rate: 7, color: '#0055a4', q:'Reform Strike', w:'Autonomy', r:'Euro Army', qDesc:'æ”¹é©ç©¿é€å¼¹', wDesc:'æˆ˜ç•¥è‡ªä¸»ç›¾', rDesc:'æ¬§æ´²å†›å›¢å¬å”¤' },
      'scholz': { cat: 'politician', name: 'Olaf Scholz', title: 'German Chancellor', hp: 8, atk: 5, spd: 4, rate: 6, color: '#000000', q:'Zeitenwende', w:'Industry', r:'Budget', qDesc:'æ—¶ä»£è½¬æŠ˜', wDesc:'å·¥ä¸šæŠ¤ç›¾', rDesc:'é¢„ç®—å¤§ç‚®' },
      'modi': { cat: 'politician', name: 'Narendra Modi', title: 'Indian PM', hp: 8, atk: 6, spd: 5, rate: 7, color: '#ff9933', q:'Made in India', w:'Yoga', r:'Digital India', qDesc:'å°åº¦åˆ¶é€ ', wDesc:'ç‘œä¼½å›è¡€', rDesc:'æ•°å­—å°åº¦æ¿€å…‰' },
      'kishida': { cat: 'politician', name: 'Fumio Kishida', title: 'Japanese PM', hp: 6, atk: 5, spd: 5, rate: 7, color: '#cc0033', q:'New Capitalism', w:'Defense', r:'Invest', qDesc:'æ–°èµ„æœ¬ä¸»ä¹‰', wDesc:'é˜²å«å¢ç¨', rDesc:'æŠ•èµ„æœªæ¥' },
      'trudeau': { cat: 'politician', name: 'Justin Trudeau', title: 'Canadian PM', hp: 7, atk: 5, spd: 6, rate: 7, color: '#ff0000', q:'Carbon Tax', w:'Multicultural', r:'Emergency', qDesc:'ç¢³ç¨æ‰“å‡»', wDesc:'å¤šå…ƒæ–‡åŒ–', rDesc:'ç´§æ€¥çŠ¶æ€' },
      'sunak': { cat: 'politician', name: 'Rishi Sunak', title: 'UK Ex-PM', hp: 6, atk: 6, spd: 6, rate: 7, color: '#0000ff', q:'Math', w:'Finance', r:'Windsor', qDesc:'æ•°å­¦è®¡ç®—', wDesc:'é‡‘èåŸæŠ¤ç›¾', rDesc:'æ¸©èæ¡†æ¶' },

      // 3. Investors
      'buffett': { cat: 'investor', name: 'Warren Buffett', title: 'Oracle of Omaha', hp: 6, atk: 10, spd: 2, rate: 4, color: '#339933', q:'Value Pick', w:'Moat', r:'Compound Interest', qDesc:'ä»·å€¼ç‹™å‡»(é«˜ä¼¤)', wDesc:'æŠ¤åŸæ²³(æ— æ•Œ)', rDesc:'å¤åˆ©æ»šé›ªçƒ(å…¨å±)' },
      'munger': { cat: 'investor', name: 'Charlie Munger', title: 'The Architect', hp: 5, atk: 10, spd: 1, rate: 3, color: '#555555', q:'Wisdom', w:'Patience', r:'Lollapalooza', qDesc:'æ™ºæ…§ç®´è¨€', wDesc:'è€å¿ƒç­‰å¾…', rDesc:'æ•ˆåº”å åŠ ' },
      'dalio': { cat: 'investor', name: 'Ray Dalio', title: 'Bridgewater', hp: 7, atk: 6, spd: 5, rate: 8, color: '#6600cc', q:'All Weather', w:'Deleveraging', r:'Big Cycle', qDesc:'å…¨å¤©å€™æ•£å°„', wDesc:'å»æ æ†æ¨æ¨ä¹', rDesc:'å¤§å‘¨æœŸé‡ç½®' },
      'marks': { cat: 'investor', name: 'Howard Marks', title: 'Oaktree', hp: 6, atk: 7, spd: 4, rate: 6, color: '#996633', q:'Cycle Memo', w:'Risk Control', r:'Distressed', qDesc:'å¤‡å¿˜å½•', wDesc:'é£æ§', rDesc:'å›°å¢ƒåè½¬' },
      'tepper': { cat: 'investor', name: 'David Tepper', title: 'Appaloosa', hp: 6, atk: 9, spd: 6, rate: 7, color: '#003366', q:'Bullish', w:'Fed Put', r:'Buy Everything', qDesc:'ç‰›å¸‚å†²å‡»', wDesc:'è”å‚¨çœ‹è·Œ', rDesc:'ä¹°å…¥ä¸€åˆ‡' },
      'griffin': { cat: 'investor', name: 'Ken Griffin', title: 'Citadel', hp: 8, atk: 8, spd: 8, rate: 9, color: '#000099', q:'HFT', w:'Market Maker', r:'Algo Dominance', qDesc:'é«˜é¢‘äº¤æ˜“', wDesc:'åšå¸‚å•†', rDesc:'ç®—æ³•ç»Ÿæ²»' },
      'ackman': { cat: 'investor', name: 'Bill Ackman', title: 'Pershing Square', hp: 6, atk: 8, spd: 7, rate: 7, color: '#999999', q:'Activist', w:'Hedge', r:'Big Short', qDesc:'æ¿€è¿›æŠ•èµ„', wDesc:'å¯¹å†²', rDesc:'å¤§ç©ºå¤´' },
      'soros': { cat: 'investor', name: 'George Soros', title: 'Quantum Fund', hp: 5, atk: 9, spd: 6, rate: 6, color: '#333333', q:'Short Sell', w:'Reflexivity', r:'Breaking Bank', qDesc:'åšç©ºæš´å‡»', wDesc:'åèº«æ€§é—ªé¿', rDesc:'å‡»ç©¿å¤®è¡Œ' },
      'druckenmiller': { cat: 'investor', name: 'Stanley Druckenmiller', title: 'Duquesne', hp: 6, atk: 9, spd: 7, rate: 7, color: '#000000', q:'Macro Bet', w:'Flexibility', r:'Top Down', qDesc:'å®è§‚æŠ¼æ³¨', wDesc:'çµæ´»é…ç½®', rDesc:'è‡ªä¸Šè€Œä¸‹' },
      'schwarzman': { cat: 'investor', name: 'Stephen Schwarzman', title: 'Blackstone', hp: 8, atk: 7, spd: 5, rate: 6, color: '#000000', q:'Private Equity', w:'Real Estate', r:'Capital', qDesc:'ç§å‹Ÿè‚¡æƒ', wDesc:'ä¸åŠ¨äº§', rDesc:'èµ„æœ¬æ´ªæµ' },
      'kravis': { cat: 'investor', name: 'Henry Kravis', title: 'KKR', hp: 7, atk: 8, spd: 5, rate: 6, color: '#cc0000', q:'LBO', w:'Management', r:'Buyout', qDesc:'æ æ†æ”¶è´­', wDesc:'ç®¡ç†ä¼˜åŒ–', rDesc:'æ”¶è´­å…¨åœº' },
      'simons': { cat: 'investor', name: 'Jim Simons', title: 'Renaissance', hp: 6, atk: 8, spd: 9, rate: 10, color: '#006600', q:'Quant Model', w:'Black Box', r:'Medallion', qDesc:'é‡åŒ–æ¨¡å‹', wDesc:'é»‘ç®±é˜²å¾¡', rDesc:'å¤§å¥–ç« æ”¶ç›Š' },

      // 4. Tech
      'musk': { cat: 'tech', name: 'Elon Musk', title: 'Technoking', hp: 6, atk: 8, spd: 9, rate: 9, color: '#999999', q:'Doge Meme', w:'Starship', r:'Mars Colony', qDesc:'ç‹—ç‹—å¸æ”»å‡»', wDesc:'æ˜Ÿèˆ°æŠ¤ç›¾', rDesc:'ç«æ˜Ÿæ®–æ°‘è½°ç‚¸' },
      'bezos': { cat: 'tech', name: 'Jeff Bezos', title: 'Amazon', hp: 7, atk: 7, spd: 6, rate: 8, color: '#ff9900', q:'Prime', w:'Cloud', r:'Logistic', qDesc:'Primeé£å¼¹', wDesc:'äº‘ç›¾', rDesc:'ç‰©æµç½‘ç»œ' },
      'cook': { cat: 'tech', name: 'Tim Cook', title: 'Apple', hp: 8, atk: 6, spd: 5, rate: 7, color: '#aaaaaa', q:'Supply Chain', w:'Privacy', r:'Ecosystem', qDesc:'ä¾›åº”é“¾', wDesc:'éšç§ç›¾', rDesc:'ç”Ÿæ€å›´å¢™' },
      'zuckerberg': { cat: 'tech', name: 'Mark Zuckerberg', title: 'Meta', hp: 6, atk: 7, spd: 7, rate: 8, color: '#0066ff', q:'Metaverse', w:'Connect', r:'VR World', qDesc:'å…ƒå®‡å®™æ³¢', wDesc:'è¿æ¥', rDesc:'è™šæ‹Ÿä¸–ç•Œ' },
      'nadella': { cat: 'tech', name: 'Satya Nadella', title: 'Microsoft', hp: 8, atk: 7, spd: 6, rate: 8, color: '#00a1f1', q:'Copilot', w:'Enterprise', r:'Cloud AI', qDesc:'å‰¯é©¾é©¶', wDesc:'ä¼ä¸šçº§', rDesc:'äº‘ç«¯AI' },
      'huang': { cat: 'tech', name: 'Jensen Huang', title: 'NVIDIA', hp: 5, atk: 10, spd: 8, rate: 10, color: '#76b900', q:'CUDA', w:'Ray Tracing', r:'Singularity', qDesc:'ç®—åŠ›å¼¹å¹•', wDesc:'å…‰è¿½åå°„', rDesc:'å¥‡ç‚¹çˆ†å‘' },
      'ponyma': { cat: 'tech', name: 'Pony Ma', title: 'Tencent', hp: 7, atk: 7, spd: 6, rate: 9, color: '#33ccff', q:'WeChat', w:'Social', r:'Game Empire', qDesc:'å¾®ä¿¡è¿æ¥', wDesc:'ç¤¾äº¤ç½‘ç»œ', rDesc:'æ¸¸æˆå¸å›½' },
      'jackma': { cat: 'tech', name: 'Jack Ma', title: 'Alibaba', hp: 6, atk: 8, spd: 7, rate: 8, color: '#ff6600', q:'E-Commerce', w:'Payment', r:'Data', qDesc:'ç”µå•†æ´ªæµ', wDesc:'æ”¯ä»˜ç›¾', rDesc:'æ•°æ®äº‘' },
      'robinli': { cat: 'tech', name: 'Robin Li', title: 'Baidu', hp: 6, atk: 6, spd: 6, rate: 7, color: '#0033cc', q:'Search', w:'Auto', r:'Ernie Bot', qDesc:'æœç´¢ç´¢å¼•', wDesc:'è‡ªåŠ¨é©¾é©¶', rDesc:'æ–‡å¿ƒä¸€è¨€' },

      // 5. Org
      'georgieva': { cat: 'org', name: 'Kristalina Georgieva', title: 'IMF', hp: 8, atk: 4, spd: 5, rate: 6, color: '#003399', q:'SDR', w:'Austerity', r:'Rescue', qDesc:'SDRæ”¯æ´', wDesc:'ç´§ç¼©', rDesc:'å…¨çƒæ•‘æ´' },
      'banga': { cat: 'org', name: 'Ajay Banga', title: 'World Bank', hp: 8, atk: 4, spd: 5, rate: 6, color: '#0099cc', q:'Development', w:'Poverty', r:'Infrastructure', qDesc:'å‘å±•æ´åŠ©', wDesc:'æ‰¶è´«', rDesc:'åŸºå»ºç‹‚é­”' },
      'okonjo': { cat: 'org', name: 'Ngozi Okonjo-Iweala', title: 'WTO', hp: 7, atk: 4, spd: 5, rate: 6, color: '#00cc00', q:'Trade Flow', w:'Dispute', r:'Global Market', qDesc:'è´¸æ˜“æµ', wDesc:'äº‰ç«¯è§£å†³', rDesc:'å…¨çƒå¸‚åœº' },
      'guterres': { cat: 'org', name: 'AntÃ³nio Guterres', title: 'UN SG', hp: 9, atk: 2, spd: 4, rate: 5, color: '#3399ff', q:'Resolution', w:'Peace', r:'Humanity', qDesc:'å†³è®®', wDesc:'ç»´å’Œ', rDesc:'äººç±»å‘½è¿' },
      'stoltenberg': { cat: 'org', name: 'Jens Stoltenberg', title: 'NATO SG', hp: 7, atk: 8, spd: 6, rate: 6, color: '#003366', q:'Article 5', w:'Defense', r:'Alliance', qDesc:'ç¬¬äº”æ¡æ¬¾', wDesc:'å…±åŒé˜²å¾¡', rDesc:'å†›äº‹è”ç›Ÿ' }
    };

    // è£…å¤‡æ•°æ®åº“
    const ITEMS = {
      'inf_sword': { type: 'attack', name: 'Infinity Ledger', cost: 1500, icon: 'âš”ï¸', stats: { dmg: 2, rate: 0.8 }, desc: 'æ”»å‡»åŠ›å¤§å¹…æå‡ï¼Œå°„é€ŸåŠ å¿«' },
      'hft_chip': { type: 'attack', name: 'HFT Chip', cost: 1200, icon: 'ğŸ’¾', stats: { rate: 0.6 }, desc: 'é«˜é¢‘äº¤æ˜“èŠ¯ç‰‡ï¼Œå°„é€Ÿç¿»å€' },
      'bull_horn': { type: 'attack', name: 'Bull Horn', cost: 2000, icon: 'ğŸ‚', stats: { dmg: 3 }, desc: 'ç‰›å¸‚ä¹‹è§’ï¼Œä¼¤å®³æé«˜' },
      'invisible_hand': { type: 'attack', name: 'Invisible Hand', cost: 2500, icon: 'ğŸ–ï¸', stats: { dmg: 1 }, passive: 'homing', desc: 'ã€è¢«åŠ¨ã€‘å­å¼¹è‡ªåŠ¨è¿½è¸ªæ•Œäºº' },
      'gold_armor': { type: 'defense', name: 'Gold Reserve', cost: 1000, icon: 'ğŸ¥‡', stats: { maxHp: 50 }, desc: 'å¢åŠ  50 ç‚¹ç”Ÿå‘½ä¸Šé™' },
      'fed_put': { type: 'defense', name: 'Fed Put', cost: 1800, icon: 'ğŸ“‰', stats: { hpRegen: 0.2 }, desc: 'ç¾è”å‚¨çœ‹è·ŒæœŸæƒï¼Œæ¯ç§’å›è¡€' },
      'bretton_shield': { type: 'defense', name: 'Bretton Shield', cost: 2200, icon: 'ğŸ›¡ï¸', stats: { maxHp: 30 }, passive: 'shield', desc: 'ã€è¢«åŠ¨ã€‘æ¯10ç§’ç”Ÿæˆä¸€ä¸ªæŠµæŒ¡ä¼¤å®³çš„æŠ¤ç›¾' },
      'rocket_boots': { type: 'utility', name: 'Liquidity Boots', cost: 800, icon: 'ğŸ‘¢', stats: { spd: 2 }, desc: 'å¢åŠ ç§»åŠ¨é€Ÿåº¦' },
      'comp_interest': { type: 'utility', name: 'Compound Int.', cost: 1500, icon: 'ğŸ“ˆ', stats: {}, passive: 'income', desc: 'ã€è¢«åŠ¨ã€‘æ¯ç§’è·å¾— 5 GDP' },
      'helicopter': { type: 'utility', name: 'Helicopter', cost: 3000, icon: 'ğŸš', stats: { spd: 3 }, passive: 'trail', desc: 'ã€è¢«åŠ¨ã€‘ç§»åŠ¨æ—¶ç•™ä¸‹ä¼¤å®³è·¯å¾„' }
    };

    /* ====== æ ¸å¿ƒå˜é‡ ====== */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    
    let state = {
      screen: 'menu', // menu -> char -> playing ...
      score: 1000, 
      frame: 0,
      player: null,
      bullets: [],
      enemies: [],
      particles: [],
      texts: [],
      inventory: [], 
      selectedChar: 'powell'
    };

    /* ====== å¼•æ“åˆå§‹åŒ– ====== */
    function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize);
    resize();

    function gameLoop() {
      requestAnimationFrame(gameLoop);
      if (state.screen === 'playing') {
        update();
        render();
        state.frame++;
      } else if (state.screen === 'shop') {
        render(); 
      }
    }

    /* ====== é€»è¾‘æ›´æ–° ====== */
    function update() {
      const p = state.player;
      if(!p) return;

      // å±æ€§è®¡ç®— (Base + Items)
      let totalSpd = p.baseSpd;
      let totalDmg = p.baseDmg;
      let totalRate = p.baseRate;
      let totalHpMax = p.baseMaxHp;
      let passiveEffects = [];

      state.inventory.forEach(itemId => {
        const item = ITEMS[itemId];
        if(item.stats.spd) totalSpd += item.stats.spd;
        if(item.stats.dmg) totalDmg += item.stats.dmg;
        if(item.stats.rate) totalRate *= item.stats.rate;
        if(item.stats.maxHp) totalHpMax += item.stats.maxHp;
        if(item.passive) passiveEffects.push(item.passive);
      });
      
      p.maxHp = totalHpMax; 

      // Passives Logic
      if(state.frame % 60 === 0 && passiveEffects.includes('income')) {
        state.score += 5; 
        spawnFloatingText(p.x, p.y - 20, "+5 GDP", "#ffee00");
      }
      if(state.frame % 60 === 0 && passiveEffects.includes('hpRegen')) {
        p.hp = Math.min(p.hp + 1, p.maxHp);
      }
      if(state.frame % 600 === 0 && passiveEffects.includes('shield')) {
        p.shield = true; 
        spawnFloatingText(p.x, p.y, "SHIELD UP", "#00ff9d");
      }
      
      // Movement
      if (p.moving) {
        let dx = p.targetX - p.x;
        let dy = p.targetY - p.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < totalSpd) { p.x = p.targetX; p.y = p.targetY; p.moving = false; } 
        else { p.x += (dx/dist) * totalSpd; p.y += (dy/dist) * totalSpd; }
        
        if(passiveEffects.includes('trail') && state.frame % 10 === 0) {
           createParticles(p.x, p.y, '#ff9900', 3);
        }
      }
      // Bounds
      p.x = Math.max(20, Math.min(width-20, p.x));
      p.y = Math.max(20, Math.min(height-20, p.y));

      // Aim
      p.angle = Math.atan2(input.mouse.y - p.y, input.mouse.x - p.x);

      // Cooldowns
      for(let k in p.cd) if(p.cd[k]>0) p.cd[k]--;
      updateHUD();

      // Attack
      if(input.mouseDown && state.frame % Math.ceil(totalRate) === 0) {
        shootBullet(p, totalDmg, passiveEffects.includes('homing'));
      }

      // Bullets
      for(let i=state.bullets.length-1; i>=0; i--) {
        let b = state.bullets[i];
        // Homing logic
        if(b.homing && state.enemies.length > 0) {
           let nearest = state.enemies[0];
           let minD = 9999;
           state.enemies.forEach(e => {
             let d = Math.hypot(e.x - b.x, e.y - b.y);
             if(d < minD) { minD = d; nearest = e; }
           });
           let angle = Math.atan2(nearest.y - b.y, nearest.x - b.x);
           b.vx = b.vx * 0.9 + Math.cos(angle) * 2; 
           b.vy = b.vy * 0.9 + Math.sin(angle) * 2;
        }

        b.x += b.vx; b.y += b.vy; b.life--;
        if(b.life <= 0) state.bullets.splice(i,1);
      }

      // Enemies
      if(state.frame % 60 === 0) spawnEnemy();
      
      for(let i=state.enemies.length-1; i>=0; i--) {
        let e = state.enemies[i];
        let angle = Math.atan2(p.y - e.y, p.x - e.x);
        e.x += Math.cos(angle) * e.speed; e.y += Math.sin(angle) * e.speed;

        // Hit Player
        if(Math.hypot(p.x-e.x, p.y-e.y) < p.r + e.r) {
          if(p.shield) {
             p.shield = false;
             spawnFloatingText(p.x, p.y, "BLOCKED", "#fff");
             e.x -= Math.cos(angle)*50; e.y -= Math.sin(angle)*50;
          } else {
             p.hp -= 10;
             createParticles(p.x, p.y, '#ff0000', 10);
             if(p.hp <= 0) gameOver();
          }
          state.enemies.splice(i,1);
          continue;
        }

        // Hit by Bullet
        for(let j=state.bullets.length-1; j>=0; j--) {
          let b = state.bullets[j];
          if(Math.hypot(b.x-e.x, b.y-e.y) < e.r + 5) {
             e.hp -= b.dmg;
             state.bullets.splice(j,1);
             createParticles(e.x, e.y, '#fff', 2);
             if(e.hp <= 0) {
               state.score += e.val;
               spawnFloatingText(e.x, e.y, `+$${e.val}`, "#00ff9d");
               state.enemies.splice(i,1);
               createParticles(e.x, e.y, e.color, 8);
               break;
             }
          }
        }
      }
      
      updateParticles();
    }

    function render() {
      ctx.fillStyle = 'rgba(5,5,10,0.3)'; ctx.fillRect(0,0,width,height);
      
      const p = state.player;
      if(!p) return;

      if(p.moving) {
        ctx.strokeStyle = '#00ff00'; ctx.beginPath(); 
        ctx.moveTo(p.targetX-5, p.targetY-5); ctx.lineTo(p.targetX+5, p.targetY+5);
        ctx.moveTo(p.targetX+5, p.targetY-5); ctx.lineTo(p.targetX-5, p.targetY+5);
        ctx.stroke();
      }

      ctx.save(); ctx.translate(p.x, p.y);
      if(p.shield) { ctx.strokeStyle = '#fff'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0,25,0,Math.PI*2); ctx.stroke(); }
      if(p.img && p.img.complete) {
        ctx.save(); ctx.beginPath(); ctx.arc(0,0,20,0,Math.PI*2); ctx.clip();
        ctx.drawImage(p.img, -20, -20, 40, 40); ctx.restore();
        ctx.strokeStyle = p.color; ctx.lineWidth = 2; ctx.stroke();
      } else {
        ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(0,0,20,0,Math.PI*2); ctx.fill();
      }
      ctx.fillStyle = "red"; ctx.fillRect(-20, 25, 40, 4);
      ctx.fillStyle = "#00ff00"; ctx.fillRect(-20, 25, 40 * (Math.max(0,p.hp)/p.maxHp), 4);
      ctx.restore();

      state.enemies.forEach(e => { ctx.fillStyle = e.color; ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.fill(); });
      state.bullets.forEach(b => { ctx.fillStyle = b.color; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); });
      state.particles.forEach(pt => { ctx.fillStyle = pt.color; ctx.globalAlpha = pt.life/30; ctx.beginPath(); ctx.arc(pt.x, pt.y, pt.size, 0, Math.PI*2); ctx.fill(); });
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#fff"; ctx.font = "bold 14px monospace";
      state.texts.forEach(t => ctx.fillText(t.text, t.x, t.y));
    }

    /* ====== è¾…åŠ©å‡½æ•° ====== */
    const input = { keys: {}, mouse: {x:0,y:0}, mouseDown: false };
    window.onkeydown = e => {
      if(e.key.toLowerCase() === 'a') input.mouseDown = true;
      if(state.screen === 'playing') {
         if('qwer'.includes(e.key.toLowerCase())) useSkill(e.key.toLowerCase());
         if(e.key.toLowerCase() === 'b') toggleShop();
         if(e.key === 'Escape' || e.key.toLowerCase() === 'p') togglePause();
      } else if(state.screen === 'shop' && e.key.toLowerCase() === 'b') toggleShop();
      else if(state.screen === 'paused' && (e.key === 'Escape' || e.key.toLowerCase() === 'p')) togglePause();
    };
    window.onkeyup = e => { if(e.key.toLowerCase() === 'a') input.mouseDown = false; };
    window.onmousemove = e => { input.mouse.x = e.clientX; input.mouse.y = e.clientY; };
    window.onmousedown = e => { if(e.button===0) input.mouseDown = true; if(e.button===2 && state.player) {
      state.player.moving = true; state.player.targetX = e.clientX; state.player.targetY = e.clientY;
    }};
    window.onmouseup = () => input.mouseDown = false;
    window.oncontextmenu = e => e.preventDefault();

    function setDifficulty(val, el) {
      difficultyMultiplier = val; // Not really used in this stripped down logic but structure is here
      document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
      el.classList.add('active');
    }

    function goToCharSelect() {
      document.getElementById('screen-rules').classList.add('hidden');
      document.getElementById('screen-char').classList.remove('hidden');
      filterChars('banker'); 
      updateCharDetail('powell');
    }

    function startGame() {
      const charData = CHARACTERS[state.selectedChar];
      state.player = {
        x: width/2, y: height/2,
        baseHp: charData.hp * 20, hp: charData.hp * 20, maxHp: charData.hp * 20,
        baseSpd: charData.spd * 0.8 + 2,
        baseDmg: charData.atk * 0.8 + 1,
        baseRate: Math.max(4, 40 - (charData.rate * 3)),
        color: charData.color,
        r: 20, angle: 0, moving: false, targetX: 0, targetY: 0,
        cd: {q:0, w:0, e:0, r:0},
        img: new Image()
      };
      state.player.img.src = `https://api.dicebear.com/9.x/avataaars/svg?seed=${charData.name.replace(/ /g,'')}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
      
      state.bullets = []; state.enemies = []; state.particles = []; state.texts = [];
      state.screen = 'playing';
      state.score = 1000; 
      
      document.getElementById('screen-char').classList.add('hidden');
      document.getElementById('ui-layer').classList.remove('hidden');
      gameLoop();
    }

    function shootBullet(p, dmg, homing) {
      state.bullets.push({
        x: p.x, y: p.y,
        vx: Math.cos(p.angle) * 15, vy: Math.sin(p.angle) * 15,
        life: 60, color: p.color, dmg: dmg, homing: homing
      });
    }

    function spawnEnemy() {
      let angle = Math.random() * Math.PI * 2;
      let r = Math.max(width, height) / 2 + 50;
      state.enemies.push({
        x: width/2 + Math.cos(angle)*r, y: height/2 + Math.sin(angle)*r,
        hp: 10, speed: 1.5 + Math.random(), r: 15, color: '#ff0055', val: 50
      });
    }

    function useSkill(key) {
      const p = state.player;
      if(p.cd[key] > 0) return;
      p.cd[key] = key==='q'?100:key==='w'?300:key==='e'?120:900; // Simple CD

      if(key === 'e') { // Dash
        p.x += Math.cos(p.angle)*200; p.y += Math.sin(p.angle)*200;
        p.targetX = p.x;
        createParticles(p.x, p.y, '#fff', 10);
      } else if(key === 'q') { // Burst
        for(let i=-0.5; i<=0.5; i+=0.2) shootBullet({...p, angle: p.angle+i}, p.baseDmg*1.5, false);
      } else if(key === 'w') { // Shield/AoE
        state.enemies.forEach(e => { if(Math.hypot(p.x-e.x, p.y-e.y)<200) { e.x -= Math.cos(Math.atan2(p.y-e.y, p.x-e.x))*150; } });
        createParticles(p.x, p.y, '#00f3ff', 20);
      } else if(key === 'r') { // Ult
        state.enemies = [];
        spawnFloatingText(width/2, height/2, "ULTIMATE!", "#ffee00");
      }
    }

    /* ====== UI Functions ====== */
    function filterChars(cat) {
      // Update visual tabs
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');

      const container = document.getElementById('char-list-container');
      container.innerHTML = '';
      for (const [id, data] of Object.entries(CHARACTERS)) {
        if (data.cat === cat) {
          const div = document.createElement('div');
          div.className = `char-mini-card ${id === state.selectedChar ? 'selected' : ''}`;
          div.onclick = () => { 
            state.selectedChar = id; 
            filterChars(cat); 
            updateCharDetail(id); 
          };
          div.innerHTML = `<img src="https://api.dicebear.com/9.x/avataaars/svg?seed=${data.name.replace(/ /g,'')}&backgroundColor=b6e3f4,c0aede,d1d4f9" class="mini-avatar"><div class="mini-name">${data.name}</div>`;
          container.appendChild(div);
        }
      }
    }
    
    function updateCharDetail(id) {
      const data = CHARACTERS[id];
      document.getElementById('detail-name').innerText = data.name;
      document.getElementById('detail-title').innerText = data.title;
      document.getElementById('detail-avatar').src = `https://api.dicebear.com/9.x/avataaars/svg?seed=${data.name.replace(/ /g,'')}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
      
      document.getElementById('bar-hp').style.width = (data.hp * 10) + '%';
      document.getElementById('bar-atk').style.width = (data.atk * 10) + '%';
      document.getElementById('bar-spd').style.width = (data.spd * 10) + '%';
      document.getElementById('bar-rate').style.width = (data.rate * 8) + '%';
      
      document.getElementById('skill-q-name').innerText = data.q; document.getElementById('skill-q-desc').innerText = data.qDesc;
      document.getElementById('skill-w-name').innerText = data.w; document.getElementById('skill-w-desc').innerText = data.wDesc;
      document.getElementById('skill-r-name').innerText = data.r; document.getElementById('skill-r-desc').innerText = data.rDesc;
    }

    function updateHUD() {
      const p = state.player;
      document.getElementById('score-val').innerText = Math.floor(state.score);
      document.getElementById('health-val').innerText = Math.floor(p.hp);
      ['q','w','e','r'].forEach(k => {
         let cd = p.cd[k];
         let el = document.querySelector(`#skill-${k} .cooldown-overlay`);
         let txt = el.querySelector('.cooldown-text');
         if(cd > 0) { el.style.height = "100%"; txt.innerText = Math.ceil(cd/60); }
         else { el.style.height = "0%"; txt.innerText = ""; }
      });
      
      // Inventory
      const slots = document.querySelectorAll('.item-slot');
      state.inventory.forEach((itemId, idx) => {
        if(slots[idx].classList.contains('empty')) {
           const item = ITEMS[itemId];
           slots[idx].innerText = item.icon;
           slots[idx].classList.remove('empty');
           slots[idx].onmouseenter = () => showItemTooltip(itemId);
           slots[idx].onmouseleave = hideTooltip;
        }
      });
    }

    function toggleShop() {
      if(state.screen === 'playing') {
        state.screen = 'shop';
        document.getElementById('shop-menu').classList.remove('hidden');
        document.getElementById('shop-current-gdp').innerText = '$' + state.score;
        filterShop('attack');
      } else {
        state.screen = 'playing';
        document.getElementById('shop-menu').classList.add('hidden');
      }
    }

    function filterShop(type) {
      const container = document.getElementById('shop-items-container');
      container.innerHTML = '';
      document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      for (const [id, item] of Object.entries(ITEMS)) {
        if(item.type === type) {
          const div = document.createElement('div');
          div.className = 'shop-item-card';
          div.onclick = () => buyItem(id);
          div.innerHTML = `
            <div class="shop-item-icon">${item.icon}</div>
            <div class="shop-item-name">${item.name}</div>
            <div class="shop-item-cost">$${item.cost}</div>
            <div class="shop-item-desc">${item.desc}</div>
            <div class="shop-buy-btn btn">BUY</div>
          `;
          container.appendChild(div);
        }
      }
    }

    function buyItem(id) {
      const item = ITEMS[id];
      if(state.score >= item.cost) {
        if(state.inventory.length < 6) {
          state.score -= item.cost;
          state.inventory.push(id);
          document.getElementById('shop-current-gdp').innerText = '$' + state.score;
          spawnFloatingText(width/2, height/2, "PURCHASED!", "#00ff9d");
        } else { alert("Inventory Full!"); }
      } else { alert("Not enough GDP!"); }
    }

    function showSkillTooltip(key) {
      const tt = document.getElementById('tooltip');
      const char = CHARACTERS[state.selectedChar];
      // ... simplified skill stats
      document.getElementById('tt-title').innerText = key.toUpperCase() + " SKILL";
      document.getElementById('tt-desc').innerText = "Special Ability";
      tt.style.display = 'block';
    }
    
    function showItemTooltip(id) {
      const tt = document.getElementById('tooltip');
      const item = ITEMS[id];
      document.getElementById('tt-title').innerText = item.name;
      document.getElementById('tt-desc').innerText = item.desc;
      tt.style.display = 'block';
    }
    function hideTooltip() { document.getElementById('tooltip').style.display = 'none'; }
    
    function createParticles(x,y,c,n) { for(let i=0;i<n;i++) state.particles.push({x,y,vx:(Math.random()-.5)*10,vy:(Math.random()-.5)*10,life:30,color:c,size:Math.random()*3}); }
    function spawnFloatingText(x,y,t,c='#fff') { state.texts.push({x,y,text:t,color:c,life:60}); }
    function updateParticles() { 
      for(let i=state.particles.length-1;i>=0;i--){ let p=state.particles[i]; p.x+=p.vx; p.y+=p.vy; p.life--; if(p.life<=0) state.particles.splice(i,1); }
      for(let i=state.texts.length-1;i>=0;i--){ let t=state.texts[i]; t.y--; t.life--; if(t.life<=0) state.texts.splice(i,1); }
    }
    function togglePause() {
      if(state.screen === 'playing') { state.screen = 'paused'; document.getElementById('pause-menu').classList.remove('hidden'); }
      else if(state.screen === 'paused') { state.screen = 'playing'; document.getElementById('pause-menu').classList.add('hidden'); loop(); }
    }
    function gameOver() {
      state.screen = 'over';
      document.getElementById('game-over').classList.remove('hidden');
      document.getElementById('final-score').innerText = state.score;
    }
    
    // Initial Render
    // Wait for DOM
    window.onload = () => {
       // Already handled by inline scripts mostly, but good practice to check
    };
  </script>
</body>
</html>
