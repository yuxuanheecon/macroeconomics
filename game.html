<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alpha Trader 2077 | Earth Macro</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <style>
    /* ====== å…¨å±€å˜é‡ & åŸºç¡€æ ·å¼ ====== */
    :root {
      --bg-color: #050505;
      --panel-bg: rgba(16, 20, 24, 0.95);
      --neon-green: #00ff9d;
      --neon-red: #ff0055;
      --neon-blue: #00f3ff;
      --neon-yellow: #ffee00;
      --text-dim: #666;
      --grid-color: rgba(0, 243, 255, 0.05);
    }

    * { box-sizing: border-box; user-select: none; }
    
    body {
      margin: 0; padding: 0;
      background-color: var(--bg-color);
      color: white;
      font-family: 'JetBrains Mono', monospace;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* CRT æ‰«æçº¿æ»¤é•œ */
    body::after {
      content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
      z-index: 100; background-size: 100% 2px, 3px 100%; pointer-events: none;
    }

    /* é¡¶éƒ¨ HUD */
    .hud {
      display: flex; flex-direction: column;
      padding: 10px 20px;
      border-bottom: 1px solid var(--neon-blue);
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
      z-index: 50;
      height: auto;
    }
    
    .hud-top { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 8px; }
    
    .logo { font-family: 'Share Tech Mono'; font-size: 1.4rem; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); display: flex; align-items: center; gap: 10px; }
    
    /* æ¸¸æˆæ§åˆ¶æŒ‰é’®ç»„ */
    .game-controls { display: flex; gap: 10px; }
    .ctrl-btn {
      background: transparent; border: 1px solid var(--text-dim); color: var(--text-dim);
      padding: 5px 10px; font-family: 'JetBrains Mono'; font-size: 0.8rem; cursor: pointer;
      transition: all 0.2s; text-transform: uppercase;
    }
    .ctrl-btn:hover { border-color: var(--neon-blue); color: var(--neon-blue); }
    .ctrl-btn.active { background: var(--neon-yellow); color: black; border-color: var(--neon-yellow); font-weight: bold; }

    .stats { display: flex; gap: 20px; font-size: 0.9rem; align-items: center; }
    .stat-box { text-align: right; }
    .stat-box span { display: block; font-size: 0.65rem; color: var(--text-dim); letter-spacing: 1px; }
    .stat-value { font-weight: bold; font-size: 1rem; font-family: 'Share Tech Mono'; }
    
    /* è¿›åº¦æ¡ */
    .progress-container {
      width: 100%; height: 4px; background: #333; position: relative; overflow: hidden;
    }
    .progress-bar {
      height: 100%; background: linear-gradient(90deg, var(--neon-blue), var(--neon-green));
      width: 0%; transition: width 0.5s; box-shadow: 0 0 10px var(--neon-green);
    }
    .progress-marker {
      position: absolute; top: 0; bottom: 0; width: 2px; background: var(--neon-red); z-index: 2;
    }

    /* ä¸»å¸ƒå±€ */
    .main-container {
      flex: 1;
      display: grid;
      grid-template-columns: 3fr 1fr;
      height: calc(100vh - 80px);
      position: relative;
    }

    /* æš‚åœé®ç½©å±‚ */
    #pause-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
      z-index: 40; display: none;
      justify-content: center; align-items: center;
      font-size: 3rem; font-family: 'Share Tech Mono'; color: var(--neon-yellow); letter-spacing: 5px;
      text-shadow: 0 0 20px var(--neon-yellow);
    }

    /* å›¾è¡¨åŒº */
    .chart-area {
      position: relative;
      border-right: 1px solid #333;
      background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
      background-size: 40px 40px;
      overflow: hidden;
    }
    #market-chart { width: 100%; height: 100%; }

    .cycle-indicator {
      position: absolute; top: 20px; left: 20px;
      background: rgba(0,0,0,0.7); border: 1px solid var(--neon-yellow);
      padding: 10px 20px; border-radius: 4px;
      box-shadow: 0 0 20px rgba(255, 238, 0, 0.2);
    }
    .cycle-label { font-size: 0.8rem; color: var(--neon-yellow); margin-bottom: 5px; }
    .cycle-value { font-size: 1.5rem; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; }

    .news-ticker {
      position: absolute; bottom: 0; left: 0; width: 100%;
      background: var(--neon-blue); color: black; font-weight: bold; padding: 5px 0;
      overflow: hidden; white-space: nowrap; z-index: 5;
    }
    .ticker-content { display: inline-block; animation: ticker 20s linear infinite; padding-left: 100%; }
    @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

    /* äº¤æ˜“é¢æ¿ */
    .trade-panel {
      background: var(--panel-bg); padding: 15px;
      display: flex; flex-direction: column; gap: 10px;
      overflow-y: auto; border-left: 1px solid var(--neon-blue);
    }
    .panel-header {
      font-family: 'Share Tech Mono'; color: var(--text-dim); 
      border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 0.8rem; margin-bottom: 5px;
    }

    .asset-card {
      background: rgba(255,255,255,0.03); border: 1px solid #333;
      border-radius: 4px; padding: 10px; cursor: pointer; transition: all 0.2s;
      position: relative; overflow: hidden;
    }
    .asset-card:hover { background: rgba(255,255,255,0.08); }
    .asset-card.active {
      border-color: var(--neon-green); background: rgba(0, 255, 157, 0.05);
      box-shadow: inset 0 0 15px rgba(0, 255, 157, 0.1);
    }
    .position-bar {
      position: absolute; bottom: 0; left: 0; height: 2px; 
      background: var(--neon-green); width: 0%; transition: width 0.5s;
    }
    .asset-info { display: flex; justify-content: space-between; align-items: center; }
    .asset-name { font-weight: bold; color: white; font-size: 0.85rem; }
    .asset-price { font-family: 'Share Tech Mono'; font-size: 0.9rem; }
    
    /* äº¤æ˜“æ§åˆ¶åŒº */
    .trade-controls {
      margin-top: auto; background: rgba(0,0,0,0.4); padding: 15px;
      border-radius: 8px; border: 1px solid #333;
    }
    
    /* æ æ†é€‰æ‹©å™¨ */
    .leverage-selector {
      display: flex; justify-content: space-between; margin-bottom: 15px; gap: 5px;
    }
    .lev-btn {
      flex: 1; background: transparent; border: 1px solid #444; color: #666;
      font-size: 0.7rem; padding: 5px 0; cursor: pointer; transition: all 0.2s;
      font-family: 'JetBrains Mono';
    }
    .lev-btn:hover { border-color: #888; color: #aaa; }
    .lev-btn.active { background: var(--neon-blue); color: black; border-color: var(--neon-blue); font-weight: bold; box-shadow: 0 0 10px var(--neon-blue); }
    /* çº¢è‰²é«˜æ æ†è­¦ç¤º */
    .lev-btn[data-val="50"].active, .lev-btn[data-val="100"].active {
      background: var(--neon-red); border-color: var(--neon-red); box-shadow: 0 0 10px var(--neon-red); color: white;
    }

    .slider-container { margin-bottom: 15px; }
    .slider-label { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-dim); margin-bottom: 5px; }
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 16px; width: 8px; background: var(--neon-blue); cursor: pointer; margin-top: -6px; box-shadow: 0 0 8px var(--neon-blue);
    }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #333; border-radius: 2px; }
    
    .control-pad { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn {
      border: none; padding: 12px; border-radius: 2px; font-weight: bold; cursor: pointer;
      font-family: 'JetBrains Mono'; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;
      transition: all 0.1s; position: relative; overflow: hidden;
    }
    .btn:active { transform: scale(0.98); }
    .btn-buy { background: rgba(0, 255, 157, 0.15); color: var(--neon-green); border: 1px solid var(--neon-green); }
    .btn-buy:hover { background: var(--neon-green); color: black; box-shadow: 0 0 20px var(--neon-green); }
    .btn-sell { background: rgba(255, 0, 85, 0.15); color: var(--neon-red); border: 1px solid var(--neon-red); }
    .btn-sell:hover { background: var(--neon-red); color: white; box-shadow: 0 0 20px var(--neon-red); }
    
    .holding-display { text-align: center; font-size: 0.75rem; color: var(--text-dim); margin-bottom: 10px; }

    /* Start/End Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.95); z-index: 200;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .modal-panel {
      width: 600px; max-width: 90%; border: 2px solid var(--neon-blue); padding: 40px; 
      box-shadow: 0 0 50px rgba(0, 243, 255, 0.2); background: rgba(10,10,10,0.95); text-align: center;
    }
    .modal-title { font-size: 2.5rem; color: var(--neon-blue); margin-bottom: 10px; font-family: 'Share Tech Mono'; }
    .modal-subtitle { color: var(--text-dim); margin-bottom: 30px; font-size: 0.9rem; }
    .rules-box { text-align: left; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 4px; margin-bottom: 30px; font-size: 0.9rem; line-height: 1.6; border-left: 3px solid var(--neon-yellow); }
    .rules-box h4 { margin: 0 0 10px 0; color: var(--neon-yellow); }
    .difficulty-select { display: flex; gap: 10px; justify-content: center; margin-bottom: 30px; }
    .diff-btn {
      flex: 1; padding: 15px; background: transparent; border: 1px solid #555; color: #555;
      cursor: pointer; font-family: 'JetBrains Mono'; transition: all 0.2s;
    }
    .diff-btn:hover { border-color: white; color: white; }
    .diff-btn.selected { border-color: var(--neon-green); color: var(--neon-green); background: rgba(0,255,157,0.1); box-shadow: 0 0 15px rgba(0,255,157,0.2); }
    .start-btn {
      width: 100%; padding: 15px; background: var(--neon-blue); color: black; font-weight: bold;
      border: none; font-size: 1.2rem; cursor: pointer; font-family: 'Share Tech Mono';
      box-shadow: 0 0 20px var(--neon-blue); transition: transform 0.2s;
    }
    .start-btn:hover { transform: scale(1.02); }

    @media (max-width: 768px) {
      .main-container { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
      .hud { height: auto; padding: 10px; }
      .stats { gap: 10px; font-size: 0.7rem; flex-wrap: wrap; }
      .stat-box { text-align: left; }
      .game-controls { margin-top: 10px; width: 100%; justify-content: space-between; }
    }
  </style>
</head>
<body>

  <!-- Start Screen -->
  <div class="modal-overlay" id="start-screen">
    <div class="modal-panel">
      <div class="modal-title">ALPHA TRADER 2077</div>
      <div class="modal-subtitle">// QUANTUM MACRO HEDGE FUND SIMULATOR //</div>
      
      <div class="rules-box">
        <h4>ğŸ¯ MISSION CONTROL:</h4>
        <p>1. <strong>ç›®æ ‡</strong>ï¼šåœ¨ 10 å¹´å†…æ ¹æ®å®è§‚å‘¨æœŸè½®åŠ¨èµ„äº§ï¼Œè¾¾æˆå‡€å€¼ç›®æ ‡ã€‚</p>
        <p>2. <strong>æ æ†</strong>ï¼šä½¿ç”¨é«˜æ æ†å¯ä»¥å¿«é€Ÿè‡´å¯Œï¼Œä½†æ³¢åŠ¨ä¹Ÿä¼šæˆå€æ”¾å¤§ã€‚å½“å‡€å€¼ä½äºæ¸…ç›˜çº¿æ—¶ï¼Œæ¸¸æˆç»“æŸã€‚</p>
        <p>3. <strong>æ“ä½œ</strong>ï¼šå¯éšæ—¶æš‚åœæ¸¸æˆæ€è€ƒç­–ç•¥ã€‚</p>
      </div>

      <div style="margin-bottom:10px; color:#fff;">SELECT DIFFICULTY LEVEL</div>
      <div class="difficulty-select">
        <button class="diff-btn" onclick="selectDifficulty('easy')" id="btn-easy">
          ROOKIE<br><span style="font-size:0.7em">$200k Start<br>Target: $5M</span>
        </button>
        <button class="diff-btn selected" onclick="selectDifficulty('normal')" id="btn-normal">
          VETERAN<br><span style="font-size:0.7em">$100k Start<br>Target: $10M</span>
        </button>
        <button class="diff-btn" onclick="selectDifficulty('hard')" id="btn-hard">
          LEGEND<br><span style="font-size:0.7em">$50k Start<br>Target: $20M</span>
        </button>
      </div>

      <button class="start-btn" onclick="startGame()">INITIALIZE SYSTEM</button>
    </div>
  </div>

  <!-- Game Over Modal -->
  <div class="modal-overlay" id="game-over-modal" style="display:none;">
    <div class="modal-panel" style="border-color: var(--neon-red);">
      <div class="modal-title" id="end-title" style="color: var(--neon-red);">LIQUIDATED</div>
      <div class="modal-score" id="end-score" style="font-size:1.5rem; margin-bottom:20px;"></div>
      <p id="end-reason" style="color:#999; margin-bottom:30px;"></p>
      <button class="start-btn" style="background:var(--neon-red); box-shadow:0 0 20px var(--neon-red);" onclick="location.reload()">RESTART</button>
    </div>
  </div>

  <!-- Pause Overlay -->
  <div id="pause-overlay">SYSTEM PAUSED</div>

  <!-- Main Game UI -->
  <div class="hud">
    <div class="hud-top">
      <div class="logo">ALPHA TRADER</div>
      
      <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
      <div class="game-controls">
        <button class="ctrl-btn" onclick="togglePause()" id="pause-btn">PAUSE [P]</button>
        <button class="ctrl-btn" onclick="location.reload()">RESTART</button>
      </div>

      <div class="stats">
        <div class="stat-box">
          <span>TIME REMAINING</span>
          <div class="stat-value" id="time-display" style="color:var(--neon-yellow)">Y1 / Q1</div>
        </div>
        <div class="stat-box">
          <span>NET WORTH</span>
          <div class="stat-value" id="net-worth">---</div>
        </div>
        <div class="stat-box">
          <span>DEBT</span>
          <div class="stat-value" id="debt-val" style="color:var(--neon-red)">$0</div>
        </div>
      </div>
    </div>
    
    <div class="progress-container">
      <div class="progress-marker" id="fail-marker" style="left: 0;"></div>
      <div class="progress-bar" id="goal-bar"></div>
    </div>
  </div>

  <div class="main-container">
    <div class="chart-area">
      <canvas id="market-chart"></canvas>
      <div class="cycle-indicator">
        <div class="cycle-label">MACRO REGIME</div>
        <div class="cycle-value" id="cycle-name">---</div>
      </div>
      <div class="news-ticker">
        <div class="ticker-content" id="news-content">
          SYSTEM STANDBY... AWAITING USER INPUT...
        </div>
      </div>
    </div>

    <div class="trade-panel">
      <div class="panel-header">// MARKET WATCH</div>
      <div id="asset-list"></div>

      <div class="trade-controls">
        <div class="panel-header">// ORDER ENTRY</div>
        
        <!-- æ æ†é€‰æ‹©å™¨ -->
        <div style="margin-bottom:10px;">
          <div class="slider-label"><span>LEVERAGE (x)</span></div>
          <div class="leverage-selector" id="leverage-group">
            <button class="lev-btn active" onclick="setLeverage(1)" data-val="1">1x</button>
            <button class="lev-btn" onclick="setLeverage(2)" data-val="2">2x</button>
            <button class="lev-btn" onclick="setLeverage(5)" data-val="5">5x</button>
            <button class="lev-btn" onclick="setLeverage(10)" data-val="10">10x</button>
            <button class="lev-btn" onclick="setLeverage(50)" data-val="50">50x</button>
            <button class="lev-btn" onclick="setLeverage(100)" data-val="100">100x</button>
          </div>
        </div>

        <div class="slider-container">
          <div class="slider-label">
            <span>CAPITAL ALLOCATION</span>
            <span id="slider-val" style="color:var(--neon-blue)">50%</span>
          </div>
          <input type="range" min="1" max="100" value="50" class="slider" id="trade-slider" oninput="updateSliderVal(this.value)">
        </div>

        <div class="holding-display">
          CURRENT HOLDING: <span id="current-hold-val" style="color:white; font-weight:bold;">0</span>
        </div>

        <div class="control-pad">
          <button class="btn btn-sell" onclick="trade('sell')">SELL</button>
          <button class="btn btn-buy" onclick="trade('buy')">BUY</button>
        </div>
        
        <a href="index.html" style="display:block; text-align:center; margin-top:15px; color:#555; text-decoration:none; font-size:0.7rem;">â† DISCONNECT</a>
      </div>
    </div>
  </div>

  <script>
    const GAME_SPEED = 100; 
    const CYCLE_DURATION = 200;
    const MAX_YEARS = 10;

    const difficultySettings = {
      'easy': { cash: 200000, fail: 1000, win: 5000000, label: 'ROOKIE' },
      'normal': { cash: 100000, fail: 5000, win: 10000000, label: 'VETERAN' },
      'hard': { cash: 50000, fail: 10000, win: 20000000, label: 'LEGEND' }
    };

    const assets = [
      { id: 'bond', name: 'US 10Y BOND', price: 100, volatility: 0.005, color: '#00f3ff', holdings: 0, history: [] },
      { id: 'stock', name: 'NASDAQ 100', price: 15000, volatility: 0.015, color: '#bd34fe', holdings: 0, history: [] },
      { id: 'gold', name: 'GOLD (XAU)', price: 2000, volatility: 0.008, color: '#ffee00', holdings: 0, history: [] },
      { id: 'crypto', name: 'BITCOIN', price: 60000, volatility: 0.04, color: '#ff0055', holdings: 0, history: [] }
    ];

    const cycles = {
      'RECOVERY': { multipliers: { bond: 1.001, stock: 1.005, gold: 0.999, crypto: 1.008 }, news: "GDP Growth UP. Risk-on." },
      'OVERHEAT': { multipliers: { bond: 0.998, stock: 1.001, gold: 1.005, crypto: 1.002 }, news: "Inflation High. Fed Hikes." },
      'STAGFLATION': { multipliers: { bond: 0.995, stock: 0.992, gold: 1.008, crypto: 0.990 }, news: "Growth Slow, Prices High." },
      'RECESSION': { multipliers: { bond: 1.005, stock: 0.990, gold: 1.003, crypto: 0.985 }, news: "Market Crash. Rate Cuts." }
    };

    let state = {
      cash: 0,
      debt: 0, // æ–°å¢å€ºåŠ¡è®°å½•
      leverage: 1, // å½“å‰é€‰æ‹©çš„æ æ†å€æ•°
      difficulty: 'normal',
      cycle: 'RECOVERY',
      cycleTimer: 0,
      tick: 0,
      year: 1,
      quarter: 1,
      selectedAssetId: 'stock',
      gameStarted: false,
      isGameOver: false,
      isPaused: false
    };

    // ====== UI Interaction ======
    
    function selectDifficulty(level) {
      state.difficulty = level;
      document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById(`btn-${level}`).classList.add('selected');
    }

    function setLeverage(lev) {
      state.leverage = lev;
      document.querySelectorAll('.lev-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.lev-btn[data-val="${lev}"]`).classList.add('active');
    }

    function togglePause() {
      if (!state.gameStarted || state.isGameOver) return;
      state.isPaused = !state.isPaused;
      const overlay = document.getElementById('pause-overlay');
      const btn = document.getElementById('pause-btn');
      
      if(state.isPaused) {
        overlay.style.display = 'flex';
        btn.innerText = "RESUME [P]";
        btn.classList.add('active');
      } else {
        overlay.style.display = 'none';
        btn.innerText = "PAUSE [P]";
        btn.classList.remove('active');
      }
    }
    
    // Keyboard shortcut for pause
    document.addEventListener('keydown', (e) => {
      if(e.key === 'p' || e.key === 'P') togglePause();
    });

    function startGame() {
      const settings = difficultySettings[state.difficulty];
      state.cash = settings.cash;
      state.debt = 0;
      state.gameStarted = true;
      document.getElementById('start-screen').style.display = 'none';
      
      initGameEngine();
    }

    function updateSliderVal(val) {
      document.getElementById('slider-val').innerText = val + '%';
    }

    // ====== Game Engine ======

    function initGameEngine() {
      renderAssetList();
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      setInterval(gameLoop, GAME_SPEED);
      drawLoop();
    }

    function gameLoop() {
      if (!state.gameStarted || state.isGameOver || state.isPaused) return;

      // Time
      state.tick++;
      if(state.tick % 50 === 0) { 
        state.quarter++;
        if(state.quarter > 4) {
          state.quarter = 1;
          state.year++;
        }
      }

      // Cycle
      state.cycleTimer++;
      if (state.cycleTimer > CYCLE_DURATION) {
        switchCycle();
        state.cycleTimer = 0;
      }

      // Price Update
      const currentParams = cycles[state.cycle];
      assets.forEach(asset => {
        const bias = currentParams.multipliers[asset.id];
        const randomNoise = 1 + (Math.random() - 0.5) * asset.volatility;
        asset.price = asset.price * bias * randomNoise;
        asset.history.push(asset.price);
        if (asset.history.length > 150) asset.history.shift();
      });

      checkGameStatus();
      updateUI();
    }

    function switchCycle() {
      const keys = Object.keys(cycles);
      const next = keys[Math.floor(Math.random() * keys.length)];
      state.cycle = next;
      
      const el = document.querySelector('.cycle-indicator');
      el.style.borderColor = 'white';
      setTimeout(() => el.style.borderColor = 'var(--neon-yellow)', 300);
      
      const newsText = cycles[next].news + " /// " + cycles[next].news;
      document.getElementById('news-content').innerText = newsText;
    }

    // ====== Trade System (With Leverage) ======

    function trade(type) {
      if (!state.gameStarted || state.isGameOver || state.isPaused) return;
      
      const asset = assets.find(a => a.id === state.selectedAssetId);
      const percent = parseInt(document.getElementById('trade-slider').value) / 100;

      if (type === 'buy') {
        // 1. è®¡ç®—æœ¬é‡‘
        const principal = state.cash * percent;
        if (principal < 10) return;
        
        // 2. è®¡ç®—æ æ†åæ€»é‡‘é¢
        const totalBuyAmount = principal * state.leverage;
        
        // 3. è®¡ç®—å€Ÿæ¬¾é‡‘é¢
        const loan = totalBuyAmount - principal;
        
        // 4. æ‰§è¡Œäº¤æ˜“
        const units = totalBuyAmount / asset.price;
        asset.holdings += units;
        state.cash -= principal;
        state.debt += loan;
        
      } else {
        // å–å‡ºé€»è¾‘ï¼šç®€å•åŒ–å¤„ç†ï¼Œå–å‡ºå›ç¬¼èµ„é‡‘ï¼Œå€ºåŠ¡ä¿ç•™
        // ä¸ºäº†ç®€åŒ–è¡—æœºä½“éªŒï¼Œæˆ‘ä»¬ä¸å¼ºåˆ¶æŒ‰æ¯”ä¾‹è¿˜å€ºï¼Œè€Œæ˜¯çœ‹æ€»å‡€å€¼
        const unitsToSell = asset.holdings * percent;
        if (unitsToSell <= 0) return;
        
        const cashBack = unitsToSell * asset.price;
        state.cash += cashBack;
        asset.holdings -= unitsToSell;
        
        // è‡ªåŠ¨è¿˜å€ºé€»è¾‘ (Optional: å¦‚æœç°é‡‘å¾ˆå¤šï¼Œè‡ªåŠ¨è¿˜ä¸€éƒ¨åˆ†å€ºï¼Œæˆ–è€…æ‰‹åŠ¨è¿˜ï¼Ÿ)
        // è¿™é‡Œä¸ºäº†æ¸¸æˆæµç•…ï¼Œå¦‚æœæœ‰ç°é‡‘ä¸”æœ‰å€ºåŠ¡ï¼Œè‡ªåŠ¨ä¼˜å…ˆè¿˜å€º
        if (state.debt > 0) {
            if (state.cash >= state.debt) {
                state.cash -= state.debt;
                state.debt = 0;
            } else {
                state.debt -= state.cash;
                state.cash = 0;
            }
        }
      }
    }

    function selectAsset(id) {
      state.selectedAssetId = id;
      document.querySelectorAll('.asset-card').forEach(el => el.classList.remove('active'));
      document.getElementById(`card-${id}`).classList.add('active');
    }

    function getNetWorth() {
      let assetsVal = 0;
      assets.forEach(a => assetsVal += a.holdings * a.price);
      return state.cash + assetsVal - state.debt;
    }

    function checkGameStatus() {
      const netWorth = getNetWorth();
      const settings = difficultySettings[state.difficulty];
      
      if (netWorth < settings.fail) {
        endGame(false, "LIQUIDATED", "è´¦æˆ·å‡€å€¼å½’é›¶ã€‚é«˜æ æ†æ˜¯æŠŠåŒåˆƒå‰‘ã€‚");
      } else if (netWorth > settings.win) {
        endGame(true, "MISSION ACCOMPLISHED", `åœ¨ ${state.year} å¹´å†…è¾¾æˆç›®æ ‡ã€‚ä¼ å¥‡è¯ç”Ÿã€‚`);
      } else if (state.year > MAX_YEARS) {
        endGame(false, "TIME'S UP", "åå¹´æœŸé™å·²åˆ°ï¼Œä¸šç»©æœªè¾¾æ ‡ã€‚");
      }
    }

    function endGame(win, titleText, reason) {
      state.isGameOver = true;
      const modal = document.getElementById('game-over-modal');
      const title = document.getElementById('end-title');
      const btn = modal.querySelector('.start-btn');
      const panel = modal.querySelector('.modal-panel');
      
      modal.style.display = 'flex';
      title.innerText = titleText;
      document.getElementById('end-score').innerText = "FINAL PnL: " + ((getNetWorth() - difficultySettings[state.difficulty].cash)/difficultySettings[state.difficulty].cash * 100).toFixed(2) + "%";
      document.getElementById('end-reason').innerText = reason;
      
      if(win) {
        title.style.color = "var(--neon-green)";
        panel.style.borderColor = "var(--neon-green)";
        btn.style.background = "var(--neon-green)";
        btn.style.boxShadow = "0 0 20px var(--neon-green)";
      } else {
        title.style.color = "var(--neon-red)";
        panel.style.borderColor = "var(--neon-red)";
        btn.style.background = "var(--neon-red)";
        btn.style.boxShadow = "0 0 20px var(--neon-red)";
      }
    }

    function updateUI() {
      const netWorth = getNetWorth();
      const settings = difficultySettings[state.difficulty];
      
      document.getElementById('net-worth').innerText = '$' + Math.floor(netWorth).toLocaleString();
      document.getElementById('cash-balance').innerText = '$' + Math.floor(state.cash).toLocaleString();
      document.getElementById('debt-val').innerText = state.debt > 0 ? '-$' + Math.floor(state.debt).toLocaleString() : '$0';
      document.getElementById('time-display').innerText = `YEAR ${state.year} / Q${state.quarter}`;
      
      // Cycle
      const cycleEl = document.getElementById('cycle-name');
      cycleEl.innerText = state.cycle;
      if(state.cycle === 'RECESSION') cycleEl.style.color = '#ff0055';
      else if(state.cycle === 'RECOVERY') cycleEl.style.color = '#00ff9d';
      else cycleEl.style.color = '#ffee00';

      // Progress Bar
      let progressPct = ((netWorth - settings.fail) / (settings.win - settings.fail)) * 100;
      if(progressPct < 0) progressPct = 0;
      if(progressPct > 100) progressPct = 100;
      document.getElementById('goal-bar').style.width = progressPct + '%';
      
      // Update Assets List
      const totalAssetsVal = assets.reduce((acc, a) => acc + a.holdings * a.price, 0);
      assets.forEach(asset => {
        document.getElementById(`price-${asset.id}`).innerText = '$' + asset.price.toFixed(2);
        const val = asset.holdings * asset.price;
        // è¿›åº¦æ¡æ˜¾ç¤ºè¯¥èµ„äº§å æ€»èµ„äº§ï¼ˆè€Œéæ€»å‡€å€¼ï¼‰çš„æ¯”ä¾‹
        const pct = totalAssetsVal > 0 ? (val / totalAssetsVal) * 100 : 0;
        document.getElementById(`bar-${asset.id}`).style.width = pct + '%';
      });

      const current = assets.find(a => a.id === state.selectedAssetId);
      document.getElementById('current-hold-val').innerText = current.holdings.toFixed(2);
    }

    function renderAssetList() {
      const container = document.getElementById('asset-list');
      container.innerHTML = '';
      assets.forEach(asset => {
        const div = document.createElement('div');
        div.className = `asset-card ${asset.id === state.selectedAssetId ? 'active' : ''}`;
        div.id = `card-${asset.id}`;
        div.onclick = () => selectAsset(asset.id);
        div.innerHTML = `
          <div class="asset-info">
            <span class="asset-name" style="color:${asset.color}">${asset.name}</span>
            <span class="asset-price" id="price-${asset.id}">$0.00</span>
          </div>
          <div class="position-bar" id="bar-${asset.id}"></div>
        `;
        container.appendChild(div);
      });
    }

    const canvas = document.getElementById('market-chart');
    const ctx = canvas.getContext('2d');
    function resizeCanvas() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; }
    function drawLoop() {
      requestAnimationFrame(drawLoop);
      const w = canvas.width; const h = canvas.height;
      ctx.fillStyle = 'rgba(5,5,5,0.2)'; ctx.fillRect(0,0,w,h);
      ctx.strokeStyle = 'rgba(0,243,255,0.05)'; ctx.lineWidth = 1; ctx.beginPath();
      for(let i=0; i<w; i+=50) { ctx.moveTo(i,0); ctx.lineTo(i,h); }
      for(let i=0; i<h; i+=50) { ctx.moveTo(0,i); ctx.lineTo(w,i); }
      ctx.stroke();
      assets.forEach(asset => {
        if(asset.history.length < 2) return;
        ctx.beginPath(); ctx.strokeStyle = asset.color; ctx.lineWidth = 2;
        let min = Math.min(...asset.history); let max = Math.max(...asset.history);
        let range = max - min || 1;
        for(let i=0; i<asset.history.length; i++) {
          const x = (i / 150) * w;
          const y = h - ((asset.history[i] - min) / range) * (h * 0.8) - h*0.1;
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
      });
    }
  </script>
</body>
</html>
