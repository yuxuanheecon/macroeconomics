<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Macro Defender 3.0 | Earth Macro</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    /* ====== åŸºç¡€æ ·å¼ ====== */
    body {
      margin: 0; overflow: hidden; background: #050505; color: white; font-family: 'JetBrains Mono', monospace;
      user-select: none; cursor: crosshair; /* ç„å‡†å‡†æ˜Ÿ */
    }
    
    /* æ‰«æçº¿ç‰¹æ•ˆ */
    .scanlines {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 50;
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
      background-size: 100% 4px;
    }

    /* ====== UI å±‚ ====== */
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
      display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box;
      z-index: 10;
    }

    /* é¡¶éƒ¨ HUD */
    .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .stat-box { text-shadow: 0 0 10px currentColor; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 4px; border: 1px solid #333; }
    .label { font-size: 0.7rem; color: #888; display: block; letter-spacing: 1px; margin-bottom: 2px; }
    .value { font-family: 'Share Tech Mono'; font-size: 1.5rem; font-weight: bold; }
    
    #score-val { color: #00ff9d; }
    #health-val { color: #00f3ff; }
    #cycle-val { color: #ffee00; }

    /* åº•éƒ¨æŠ€èƒ½æ  HUD */
    .hud-bottom { display: flex; justify-content: center; align-items: flex-end; gap: 20px; position: relative; pointer-events: auto; }
    
    .skill-bar { display: flex; gap: 15px; }
    .skill-slot {
      width: 70px; height: 70px; border: 2px solid #444; background: rgba(0,0,0,0.7);
      position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center;
      border-radius: 8px; transition: all 0.1s; overflow: hidden; cursor: help;
    }
    .skill-slot.ready { border-color: var(--color); box-shadow: 0 0 15px var(--color); }
    .skill-slot.cooldown { border-color: #333; opacity: 0.7; cursor: not-allowed; }
    
    .skill-key { position: absolute; top: 2px; left: 2px; background: #000; border: 1px solid #555; color: #fff; font-size: 0.6rem; padding: 1px 4px; border-radius: 2px; }
    .skill-icon { font-size: 1.5rem; margin-bottom: 5px; }
    .skill-name { font-size: 0.6rem; color: #aaa; text-transform: uppercase; }
    
    .cooldown-overlay {
      position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8);
      height: 0%; transition: height 0.1s linear;
      display: flex; justify-content: center; align-items: center;
    }
    .cooldown-text {
      color: white; font-weight: bold; font-size: 1.2rem; font-family: 'Share Tech Mono';
    }

    /* æŠ€èƒ½æç¤ºæ¡† (Tooltip) */
    .tooltip {
      position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%);
      background: rgba(10, 15, 20, 0.95); border: 1px solid var(--neon-blue);
      padding: 15px; border-radius: 8px; width: 300px; pointer-events: none;
      display: none; text-align: left; box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .tooltip h4 { margin: 0 0 5px 0; color: #fff; font-size: 1rem; }
    .tooltip p { margin: 0; color: #aaa; font-size: 0.8rem; line-height: 1.4; }
    .tooltip .cost { margin-top: 8px; font-size: 0.7rem; color: #ff0055; font-weight: bold; }

    /* ====== æ¨¡æ€çª—å£ ====== */
    .modal {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(5,5,10,0.95); display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 100; pointer-events: auto;
    }
    .hidden { display: none !important; }

    h1 { font-family: 'Share Tech Mono'; font-size: 3rem; color: #00f3ff; text-shadow: 0 0 30px #00f3ff; margin: 0 0 20px 0; }
    h2 { font-size: 1.5rem; color: #ccc; margin-bottom: 20px; }
    p { color: #888; margin-bottom: 20px; font-size: 1rem; max-width: 800px; line-height: 1.6; text-align: center; }

    .btn {
      background: transparent; border: 2px solid #00ff9d; color: #00ff9d;
      padding: 12px 30px; font-size: 1.2rem; font-family: 'Share Tech Mono';
      cursor: pointer; box-shadow: 0 0 20px rgba(0,255,157,0.2); transition: all 0.2s;
      margin: 10px;
    }
    .btn:hover { background: #00ff9d; color: black; box-shadow: 0 0 50px rgba(0,255,157,0.6); transform: scale(1.05); }
    .btn-red { border-color: #ff0055; color: #ff0055; box-shadow: 0 0 20px rgba(255,0,85,0.2); }
    .btn-red:hover { background: #ff0055; color: white; box-shadow: 0 0 50px rgba(255,0,85,0.6); }

    /* é€‰äººç•Œé¢ */
    .char-container { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; justify-content: center; }
    .char-card {
      border: 1px solid #444; padding: 15px; width: 200px; background: rgba(255,255,255,0.05);
      cursor: pointer; transition: all 0.3s; text-align: left; position: relative; overflow: hidden;
    }
    .char-card:hover, .char-card.selected { border-color: #ffee00; background: rgba(255,238,0,0.1); box-shadow: 0 0 30px rgba(255,238,0,0.2); transform: translateY(-5px); }
    .char-card.selected::after { content:"SELECTED"; position:absolute; top:5px; right:5px; font-size:0.6rem; color:#ffee00; font-weight:bold; }
    
    .char-name { font-size: 1.1rem; color: #fff; margin-bottom: 5px; font-weight: bold; }
    .char-title { color: #888; font-size: 0.7rem; margin-bottom: 10px; font-style: italic; height: 2.5em; }
    .char-stats { font-size: 0.75rem; color: #aaa; line-height: 1.6; }
    .stat-bar { height: 4px; background: #333; margin-top: 2px; width: 100%; position: relative; }
    .stat-fill { height: 100%; background: #00f3ff; }

    /* éš¾åº¦é€‰æ‹© */
    .diff-select { display: flex; gap: 10px; margin-bottom: 30px; }
    .diff-btn { padding: 8px 20px; border: 1px solid #555; color: #555; cursor: pointer; font-family: 'JetBrains Mono'; }
    .diff-btn:hover { border-color: #fff; color: #fff; }
    .diff-btn.active { border-color: #00f3ff; color: #00f3ff; box-shadow: 0 0 10px #00f3ff; background: rgba(0, 243, 255, 0.1); font-weight: bold; }

    /* å•†åº—ç•Œé¢ */
    #shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 600px; width: 100%; }
    .shop-item { border: 1px solid #333; padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5); }
    .shop-info b { display: block; color: #00f3ff; margin-bottom: 5px; font-size: 0.9rem; }
    .shop-info span { font-size: 0.7rem; color: #888; }
    .shop-btn { font-size: 0.8rem; padding: 5px 15px; margin: 0; }
    
    /* æµ®åŠ¨ä¼¤å®³æ•°å­— */
    .floating-text { position: absolute; font-weight: bold; pointer-events: none; animation: floatUp 1s ease-out forwards; }
    @keyframes floatUp { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-50px); opacity: 0; } }

  </style>
</head>
<body>

  <canvas id="gameCanvas"></canvas>
  <div class="scanlines"></div>

  <!-- HUD -->
  <div id="ui-layer">
    <div class="hud-top">
      <div class="stat-box">
        <span class="label">GDP (SCORE)</span>
        <div class="value" id="score-val">0</div>
      </div>
      <div class="stat-box">
        <span class="label">MACRO CYCLE</span>
        <div class="value" id="cycle-val">LOADING...</div>
      </div>
      <div class="stat-box">
        <span class="label">LIQUIDITY (HP)</span>
        <div class="value" id="health-val">100%</div>
      </div>
    </div>

    <div class="hud-bottom">
      <!-- Tooltip Container -->
      <div id="skill-tooltip" class="tooltip">
        <h4 id="tt-title">Skill Name</h4>
        <p id="tt-desc">Description goes here.</p>
        <div id="tt-cost" class="cost">Cooldown: 10s</div>
      </div>

      <div class="skill-bar">
        <!-- A / Click -->
        <div class="skill-slot" style="--color: #fff; border-color:#fff;" onmouseenter="showTooltip('a')" onmouseleave="hideTooltip()">
          <span class="skill-key">A</span>
          <span class="skill-icon">ğŸ”«</span>
          <span class="skill-name">Attack</span>
        </div>
        <!-- Q -->
        <div class="skill-slot" id="skill-q" style="--color: #00f3ff" onmouseenter="showTooltip('q')" onmouseleave="hideTooltip()">
          <span class="skill-key">Q</span>
          <span class="skill-icon">ğŸ’ </span>
          <span class="skill-name" id="name-q">Tactical</span>
          <div class="cooldown-overlay"><span class="cooldown-text"></span></div>
        </div>
        <!-- W -->
        <div class="skill-slot" id="skill-w" style="--color: #00ff9d" onmouseenter="showTooltip('w')" onmouseleave="hideTooltip()">
          <span class="skill-key">W</span>
          <span class="skill-icon">ğŸ›¡ï¸</span>
          <span class="skill-name">Defense</span>
          <div class="cooldown-overlay"><span class="cooldown-text"></span></div>
        </div>
        <!-- E -->
        <div class="skill-slot" id="skill-e" style="--color: #ffee00" onmouseenter="showTooltip('e')" onmouseleave="hideTooltip()">
          <span class="skill-key">E</span>
          <span class="skill-icon">âš¡</span>
          <span class="skill-name">Dash</span>
          <div class="cooldown-overlay"><span class="cooldown-text"></span></div>
        </div>
        <!-- R -->
        <div class="skill-slot" id="skill-r" style="--color: #ff0055" onmouseenter="showTooltip('r')" onmouseleave="hideTooltip()">
          <span class="skill-key">R</span>
          <span class="skill-icon">â˜¢ï¸</span>
          <span class="skill-name" id="name-r">Ultimate</span>
          <div class="cooldown-overlay"><span class="cooldown-text"></span></div>
        </div>
      </div>
      <div class="shop-hint">SHOP [B] | PAUSE [P]</div>
    </div>
  </div>

  <!-- 1. å¼€å§‹/é€‰äººç•Œé¢ -->
  <div id="start-screen" class="modal">
    <h1>MACRO DEFENDER 3.0</h1>
    <p>
      <strong>MOBA é£æ ¼æ“ä½œï¼š</strong><br>
      [é¼ æ ‡å³é”®] ç§»åŠ¨è§’è‰² | [é¼ æ ‡ä½ç½®] ç„å‡†æ–¹å‘<br>
      [A / å·¦é”®] æ™®æ”» | [Q W E R] é‡Šæ”¾æŠ€èƒ½
    </p>

    <div class="diff-select">
      <div class="diff-btn" onclick="setDifficulty(0.8, this)">EASY (ç®€å•)</div>
      <div class="diff-btn active" onclick="setDifficulty(1, this)">NORMAL (æ™®é€š)</div>
      <div class="diff-btn" onclick="setDifficulty(1.5, this)">HARD (å›°éš¾)</div>
    </div>

    <div class="char-container">
      <!-- Powell -->
      <div class="char-card selected" onclick="selectChar('powell', this)">
        <div class="char-name">é²å¨å°” (Powell)</div>
        <div class="char-title">"Data Dependent"</div>
        <div class="char-stats">
          <div>HP: <span style="color:#00f3ff">â– â– â– â– â– </span></div>
          <div>ATK: <span style="color:#00f3ff">â– â– â– â–¡â–¡</span></div>
          <div style="margin-top:5px; font-size:0.7rem; color:#888;">Q: é¹°æ´¾ä¸‰è¿å°„<br>R: æ— é™å°é’ (å…¨å±æ¿€å…‰)</div>
        </div>
      </div>
      <!-- Trump -->
      <div class="char-card" onclick="selectChar('trump', this)">
        <div class="char-name">ç‰¹æœ—æ™® (Trump)</div>
        <div class="char-title">"Make Market Great"</div>
        <div class="char-stats">
          <div>HP: <span style="color:#ff0055">â– â– â–¡â–¡â–¡</span></div>
          <div>ATK: <span style="color:#ff0055">â– â– â– â– â– </span></div>
          <div style="margin-top:5px; font-size:0.7rem; color:#888;">Q: æ¨ç‰¹é£æš´ (æ•£å°„)<br>R: è´¸æ˜“æˆ˜ (æ¸…å±æ ¸å¼¹)</div>
        </div>
      </div>
      <!-- Xi -->
      <div class="char-card" onclick="selectChar('xi', this)">
        <div class="char-name">æŒèˆµäºº (Big Boss)</div>
        <div class="char-title">"Steady Growth"</div>
        <div class="char-stats">
          <div>HP: <span style="color:#ffee00">â– â– â– â– â– +</span></div>
          <div>ATK: <span style="color:#ffee00">â– â– â– â–¡â–¡</span></div>
          <div style="margin-top:5px; font-size:0.7rem; color:#888;">Q: é€†å‘¨æœŸè°ƒèŠ‚ (éœ‡è¡æ³¢)<br>R: å…±åŒå¯Œè£• (å›è¡€+ä¼¤å®³)</div>
        </div>
      </div>
      <!-- Takaichi -->
      <div class="char-card" onclick="selectChar('takaichi', this)">
        <div class="char-name">é«˜å¸‚æ—©è‹— (Takaichi)</div>
        <div class="char-title">"Sanaenomics"</div>
        <div class="char-stats">
          <div>HP: <span style="color:#bd34fe">â– â– â–¡â–¡â–¡</span></div>
          <div>ATK: <span style="color:#bd34fe">â– â– â–¡â–¡â–¡ (é«˜å°„é€Ÿ)</span></div>
          <div style="margin-top:5px; font-size:0.7rem; color:#888;">Q: è´¢æ”¿åˆºæ¿€ (æ”»é€Ÿçˆ†å‘)<br>R: æ—¥å…ƒæµ·å•¸ (å¼¹å¹•é›¨)</div>
        </div>
      </div>
      <!-- Macron -->
      <div class="char-card" onclick="selectChar('macron', this)">
        <div class="char-name">é©¬å…‹é¾™ (Macron)</div>
        <div class="char-title">"European Autonomy"</div>
        <div class="char-stats">
          <div>HP: <span style="color:#00ff9d">â– â– â– â–¡â–¡</span></div>
          <div>ATK: <span style="color:#00ff9d">â– â– â– â–¡â–¡</span></div>
          <div style="margin-top:5px; font-size:0.7rem; color:#888;">Q: æ”¹é©é‡æ‹³ (ç©¿é€)<br>R: æˆ˜ç•¥è‡ªä¸» (æ— æ•Œå…‰ç¯)</div>
        </div>
      </div>
    </div>
    
    <button class="btn" onclick="gameInit()">START MISSION</button>
  </div>

  <!-- 2. æš‚åœèœå• -->
  <div id="pause-menu" class="modal hidden">
    <h1>SYSTEM PAUSED</h1>
    <button class="btn" onclick="togglePause()">RESUME</button>
    <button class="btn btn-red" onclick="location.reload()">ABORT</button>
  </div>

  <!-- 3. å•†åº—ç•Œé¢ -->
  <div id="shop-menu" class="modal hidden">
    <h1>GDP STORE</h1>
    <p>Invest your GDP to boost economy stats.</p>
    <p>Current GDP: <span id="shop-gdp" style="color:#00ff9d; font-size:1.5rem;">$0</span></p>
    
    <div id="shop-grid">
      <div class="shop-item">
        <div class="shop-info"><b>Monetary Power (DMG)</b><span>å¢åŠ  20% ä¼¤å®³</span></div>
        <button class="btn shop-btn" onclick="buyUpgrade('damage')">$1000</button>
      </div>
      <div class="shop-item">
        <div class="shop-info"><b>Velocity (SPD)</b><span>å¢åŠ  10% ç§»é€Ÿ</span></div>
        <button class="btn shop-btn" onclick="buyUpgrade('speed')">$800</button>
      </div>
      <div class="shop-item">
        <div class="shop-info"><b>Printing Speed (RATE)</b><span>å¢åŠ  15% å°„é€Ÿ</span></div>
        <button class="btn shop-btn" onclick="buyUpgrade('rate')">$1500</button>
      </div>
      <div class="shop-item">
        <div class="shop-info"><b>Reserves Injection (HP)</b><span>å›å¤ 50% ç”Ÿå‘½å€¼</span></div>
        <button class="btn shop-btn" onclick="buyUpgrade('heal')">$500</button>
      </div>
    </div>

    <button class="btn" style="margin-top:30px" onclick="toggleShop()">CLOSE SHOP [B]</button>
  </div>

  <!-- 4. æ¸¸æˆç»“æŸ -->
  <div id="game-over" class="modal hidden">
    <h1 style="color:#ff0055">MARKET CRASH</h1>
    <p>Liquidity Dried Up. Final GDP: <span id="final-score" style="color:white; font-weight:bold;">0</span></p>
    <button class="btn" onclick="location.reload()">REBOOT ECONOMY</button>
  </div>

  <script>
    /* ====== æ ¸å¿ƒå¼•æ“ ====== */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    
    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // æ¸¸æˆçŠ¶æ€
    const STATE = { menu: 0, playing: 1, paused: 2, shop: 3, over: 4 };
    let currentState = STATE.menu;
    
    // ç©å®¶é…ç½®
    let difficultyMultiplier = 1; 
    let selectedChar = 'powell';
    let score = 0; 
    let frame = 0;
    
    // è§’è‰²å±æ€§å®šä¹‰ (CD æ—¶é—´å¤§å¹…å¢åŠ )
    // 60 frames = 1s. e.g., 300 = 5s.
    const CHAR_STATS = {
      'powell': { hp: 150, speed: 4, dmg: 4, rate: 15, color: '#00f3ff', qCd: 180, wCd: 480, eCd: 240, rCd: 1800, qName:'é¹°æ´¾å°„å‡»', wName:'åŠ æ¯æŠ¤ç›¾', eName:'æ”¿ç­–è½¬å‘', rName:'æ— é™å°é’' },
      'trump':  { hp: 80, speed: 6, dmg: 6, rate: 20, color: '#ff0055', qCd: 150, wCd: 600, eCd: 200, rCd: 2400, qName:'æ¨ç‰¹é£æš´', wName:'è´¸æ˜“å£å’', eName:'å¿«é€Ÿååº”', rName:'å…¨é¢å…³ç¨' },
      'xi':     { hp: 250, speed: 3, dmg: 5, rate: 25, color: '#ffee00', qCd: 240, wCd: 900, eCd: 300, rCd: 3000, qName:'é€†å‘¨æœŸè°ƒèŠ‚', wName:'å®šåŠ›', eName:'ç¨³å¥æ­¥ä¼', rName:'å…±åŒå¯Œè£•' },
      'takaichi':{ hp: 100, speed: 5, dmg: 2, rate: 5, color: '#bd34fe', qCd: 400, wCd: 480, eCd: 240, rCd: 1800, qName:'è´¢æ”¿åˆºæ¿€', wName:'å¤®è¡Œå¹²é¢„', eName:'æ—¥å…ƒè´¬å€¼', rName:'è´§å¸æµ·å•¸' }, 
      'macron': { hp: 120, speed: 5, dmg: 3, rate: 12, color: '#00ff9d', qCd: 180, wCd: 360, eCd: 240, rCd: 1800, qName:'æ”¹é©é‡æ‹³', wName:'æ¬§æ´²ç›¾ç‰Œ', eName:'å¤–äº¤æ–¡æ—‹', rName:'æˆ˜ç•¥è‡ªä¸»' }
    };
    
    // æŠ€èƒ½æè¿°
    const SKILL_DESC = {
      'a': { title: "æ™®é€šæ”»å‡» (A/Click)", desc: "å‘é¼ æ ‡æ–¹å‘å‘å°„åŸºç¡€å¼¹å¹•ã€‚ä¸æ¶ˆè€—æ³•åŠ›ã€‚" },
      'q': { title: "æˆ˜æœ¯æŠ€èƒ½ (Q)", desc: "çŸ­CDçš„ç‰¹æ®Šæ”»å‡»æ–¹å¼ï¼Œç”¨äºæ¸…å…µæˆ–çˆ†å‘ã€‚" },
      'w': { title: "é˜²å¾¡æŠ€èƒ½ (W)", desc: "æä¾›æŠ¤ç›¾ã€å›å¤æˆ–å‡»é€€æ•Œäººï¼Œå¢åŠ ç”Ÿå­˜èƒ½åŠ›ã€‚" },
      'e': { title: "ä½ç§»æŠ€èƒ½ (E)", desc: "å¿«é€Ÿç§»åŠ¨ä¸€æ®µè·ç¦»ï¼Œèº²é¿è‡´å‘½ä¼¤å®³ã€‚" },
      'r': { title: "ç»ˆææŠ€èƒ½ (R)", desc: "æ¶ˆè€—æé•¿CDï¼Œé€ æˆå…¨å±æ¯ç­æ€§æ‰“å‡»æˆ–å¼ºåŠ›å¢ç›Šã€‚" }
    };

    // å®ä½“æ± 
    let player = { x:0, y:0, targetX:0, targetY:0, moving: false, r:15, hp:100, maxHp:100, speed:5, dmg:1, rate:10, angle:0, cd:{q:0, w:0, e:0, r:0} };
    let bullets = [];
    let enemies = [];
    let particles = [];
    let texts = [];

    const CYCLES = ['RECOVERY', 'OVERHEAT', 'STAGFLATION', 'RECESSION'];
    let cycleIdx = 0;
    let cycleTimer = 0;

    /* ====== è¾“å…¥å¤„ç† (RTS/MOBA é£æ ¼) ====== */
    let keys = {};
    let mouse = { x: width/2, y: height/2 };
    let mouseDown = false;

    // ç¦ç”¨å³é”®èœå•
    window.addEventListener('contextmenu', e => {
      e.preventDefault();
      if (currentState === STATE.playing) {
        // å³é”®ç§»åŠ¨
        player.targetX = e.clientX;
        player.targetY = e.clientY;
        player.moving = true;
        // åˆ›å»ºç‚¹å‡»ç‰¹æ•ˆ
        createParticles(e.clientX, e.clientY, '#00ff00', 3); 
      }
    });

    window.addEventListener('keydown', e => {
      keys[e.key] = true;
      if (currentState === STATE.playing) {
        if(e.key.toLowerCase() === 'a') mouseDown = true; // Aé”®æ”»å‡»
        if(e.key.toLowerCase() === 'q') useSkill('q');
        if(e.key.toLowerCase() === 'w') useSkill('w');
        if(e.key.toLowerCase() === 'e') useSkill('e');
        if(e.key.toLowerCase() === 'r') useSkill('r');
        if(e.key.toLowerCase() === 'b') toggleShop();
        if(e.key === 'Escape' || e.key.toLowerCase() === 'p') togglePause();
      } else if (currentState === STATE.shop && e.key.toLowerCase() === 'b') {
        toggleShop();
      }
    });

    window.addEventListener('keyup', e => {
      keys[e.key] = false;
      if(e.key.toLowerCase() === 'a') mouseDown = false;
    });

    window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
    window.addEventListener('mousedown', e => { if(e.button === 0) mouseDown = true; }); // å·¦é”®æ”»å‡»
    window.addEventListener('mouseup', e => { if(e.button === 0) mouseDown = false; });

    /* ====== é€»è¾‘æ§åˆ¶ ====== */
    function setDifficulty(val, el) {
      difficultyMultiplier = val;
      document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
      el.classList.add('active');
    }
    function selectChar(char, el) {
      selectedChar = char;
      document.querySelectorAll('.char-card').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
    }

    function gameInit() {
      const s = CHAR_STATS[selectedChar];
      player.maxHp = s.hp; player.hp = s.hp;
      player.speed = s.speed; player.dmg = s.dmg; player.rate = s.rate;
      player.color = s.color;
      player.x = width/2; player.y = height/2;
      player.targetX = player.x; player.targetY = player.y; player.moving = false;
      player.cd = { q:0, w:0, e:0, r:0 };
      
      // æ›´æ–°æŠ€èƒ½å UI
      document.getElementById('name-q').innerText = s.qName;
      document.getElementById('name-r').innerText = s.rName;

      score = 500;
      bullets = []; enemies = []; particles = []; texts = [];

      document.getElementById('start-screen').classList.add('hidden');
      currentState = STATE.playing;
      loop();
    }

    function togglePause() {
      if(currentState === STATE.playing) {
        currentState = STATE.paused;
        document.getElementById('pause-menu').classList.remove('hidden');
      } else if(currentState === STATE.paused) {
        currentState = STATE.playing;
        document.getElementById('pause-menu').classList.add('hidden');
        loop();
      }
    }

    function toggleShop() {
      if(currentState === STATE.playing) {
        currentState = STATE.shop;
        document.getElementById('shop-gdp').innerText = '$' + Math.floor(score);
        document.getElementById('shop-menu').classList.remove('hidden');
      } else if(currentState === STATE.shop) {
        currentState = STATE.playing;
        document.getElementById('shop-menu').classList.add('hidden');
        loop();
      }
    }

    function buyUpgrade(type) {
      let cost = 0;
      if(type === 'damage') { cost = 1000; if(score >= cost) { score-=cost; player.dmg *= 1.2; spawnFloatingText(width/2, height/2, "DMG UP!", "#00ff9d"); } }
      if(type === 'speed') { cost = 800; if(score >= cost) { score-=cost; player.speed *= 1.1; spawnFloatingText(width/2, height/2, "SPD UP!", "#00ff9d"); } }
      if(type === 'rate') { cost = 1500; if(score >= cost) { score-=cost; player.rate = Math.max(2, player.rate * 0.85); spawnFloatingText(width/2, height/2, "RATE UP!", "#00ff9d"); } }
      if(type === 'heal') { cost = 500; if(score >= cost) { score-=cost; player.hp = Math.min(player.maxHp, player.hp + player.maxHp*0.5); spawnFloatingText(width/2, height/2, "HEALED!", "#00f3ff"); } }
      document.getElementById('shop-gdp').innerText = '$' + Math.floor(score);
      document.getElementById('score-val').innerText = Math.floor(score);
    }

    /* ====== æç¤ºæ¡†é€»è¾‘ ====== */
    function showTooltip(key) {
      const tt = document.getElementById('skill-tooltip');
      const title = document.getElementById('tt-title');
      const desc = document.getElementById('tt-desc');
      const cost = document.getElementById('tt-cost');
      
      const info = SKILL_DESC[key];
      const stats = CHAR_STATS[selectedChar];
      
      let name = info.title;
      if(key==='q') name += ` - ${stats.qName}`;
      if(key==='w') name += ` - ${stats.wName}`;
      if(key==='e') name += ` - ${stats.eName}`;
      if(key==='r') name += ` - ${stats.rName}`;
      
      let cdTime = 0;
      if(key==='q') cdTime = stats.qCd/60;
      if(key==='w') cdTime = stats.wCd/60;
      if(key==='e') cdTime = stats.eCd/60;
      if(key==='r') cdTime = stats.rCd/60;

      title.innerText = name;
      desc.innerText = info.desc;
      cost.innerText = key === 'a' ? "No Cooldown" : `Cooldown: ${cdTime.toFixed(1)}s`;
      
      tt.style.display = 'block';
    }
    function hideTooltip() {
      document.getElementById('skill-tooltip').style.display = 'none';
    }

    /* ====== LOOP ====== */
    function loop() {
      if(currentState !== STATE.playing) return;
      requestAnimationFrame(loop);
      update();
      render();
      frame++;
    }

    function update() {
      // 1. Cycle
      cycleTimer++;
      if(cycleTimer > 600) {
        cycleTimer = 0;
        cycleIdx = (cycleIdx + 1) % CYCLES.length;
        document.getElementById('cycle-val').innerText = CYCLES[cycleIdx];
      }

      // 2. Player Move (RTS Logic) & Aim
      player.angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);

      if (player.moving) {
        let dx = player.targetX - player.x;
        let dy = player.targetY - player.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        
        if (dist < player.speed) {
          player.x = player.targetX;
          player.y = player.targetY;
          player.moving = false;
        } else {
          player.x += (dx/dist) * player.speed;
          player.y += (dy/dist) * player.speed;
        }
      }
      
      // Bounds
      if(player.x < 10) player.x = 10; if(player.x > width-10) player.x = width-10;
      if(player.y < 10) player.y = 10; if(player.y > height-10) player.y = height-10;

      // 3. Cooldowns
      for(let k in player.cd) { if(player.cd[k] > 0) player.cd[k]--; }
      updateSkillUI();

      // 4. Auto Fire (A or Left Click)
      if(mouseDown && frame % Math.floor(player.rate) === 0) {
         shootBullet(player.angle, 0, player.dmg, player.color, 5);
      }

      // 5. Bullets
      for(let i=bullets.length-1; i>=0; i--) {
        let b = bullets[i];
        b.x += b.vx; b.y += b.vy; b.life--;
        if(b.life <= 0) bullets.splice(i, 1);
      }

      // 6. Enemy Spawn (Slower Pace)
      let spawnRate = 120 / difficultyMultiplier; // å‡æ…¢åˆ·æ€ªé¢‘ç‡
      if(CYCLES[cycleIdx] === 'OVERHEAT') spawnRate /= 1.5;
      if(frame % Math.floor(spawnRate) === 0) spawnEnemy();

      // 7. Collision
      for(let i=enemies.length-1; i>=0; i--) {
        let e = enemies[i];
        // Move to player
        let angle = Math.atan2(player.y - e.y, player.x - e.x);
        e.x += Math.cos(angle) * e.speed;
        e.y += Math.sin(angle) * e.speed;

        // Hit Player
        let dist = Math.hypot(player.x - e.x, player.y - e.y);
        if(dist < player.r + e.r) {
          let dmg = 10 * difficultyMultiplier;
          player.hp -= dmg;
          enemies.splice(i, 1);
          createParticles(e.x, e.y, '#ff0000', 10);
          spawnFloatingText(player.x, player.y, `-${Math.floor(dmg)}`, "#ff0000");
          checkGameOver();
          continue;
        }

        // Hit by Bullet
        for(let j=bullets.length-1; j>=0; j--) {
          let b = bullets[j];
          let bDist = Math.hypot(b.x - e.x, b.y - e.y);
          if(bDist < e.r + 10) { // Hitbox
            if(!b.penetrate) bullets.splice(j, 1);
            e.hp -= b.dmg;
            createParticles(e.x, e.y, '#fff', 1);
            
            if(e.hp <= 0) {
              score += e.value;
              enemies.splice(i, 1);
              createParticles(e.x, e.y, e.color, 8);
              spawnFloatingText(e.x, e.y, `+$${e.value}`, "#00ff9d");
              break;
            }
          }
        }
      }

      updateParticles();
      
      // HUD Update
      document.getElementById('score-val').innerText = Math.floor(score);
      let hpPct = Math.max(0, Math.floor((player.hp / player.maxHp)*100));
      document.getElementById('health-val').innerText = hpPct + "%";
    }

    function shootBullet(angle, spread, dmg, color, size, speed=15, penetrate=false) {
      bullets.push({
        x: player.x, y: player.y,
        vx: Math.cos(angle + spread) * speed,
        vy: Math.sin(angle + spread) * speed,
        life: 60, color: color, dmg: dmg, r: size, penetrate: penetrate
      });
    }

    /* ====== æŠ€èƒ½é€»è¾‘ (QWER) ====== */
    function useSkill(key) {
      if(player.cd[key] > 0) return;
      
      const s = CHAR_STATS[selectedChar];
      
      // --- Q Skill ---
      if(key === 'q') {
        player.cd.q = s.qCd;
        if(selectedChar === 'powell') { 
           for(let i=0; i<3; i++) setTimeout(() => shootBullet(player.angle, 0, player.dmg*2, '#00f3ff', 8), i*100);
        } else if(selectedChar === 'trump') {
           for(let i=-2; i<=2; i++) shootBullet(player.angle, i*0.15, player.dmg, '#ffaa00', 6);
        } else if(selectedChar === 'xi') { 
           for(let i=0; i<12; i++) shootBullet(i * (Math.PI/6), 0, player.dmg*1.5, '#ffee00', 6, 10);
        } else if(selectedChar === 'takaichi') { 
           let oldRate = player.rate; player.rate = 2;
           setTimeout(() => player.rate = oldRate, 3000);
           spawnFloatingText(player.x, player.y, "RATE BOOST!", "#bd34fe");
        } else if(selectedChar === 'macron') { 
           shootBullet(player.angle, 0, player.dmg*3, '#00ff9d', 10, 20, true);
        }
      }

      // --- W Skill ---
      if(key === 'w') {
        player.cd.w = s.wCd;
        enemies.forEach(e => {
           if(Math.hypot(player.x - e.x, player.y - e.y) < 250) {
             let a = Math.atan2(e.y - player.y, e.x - player.x);
             e.x += Math.cos(a) * 150; e.y += Math.sin(a) * 150;
           }
        });
        if(selectedChar === 'trump') { 
           enemies.forEach(e => { if(Math.hypot(player.x-e.x, player.y-e.y)<300) e.hp -= 20; });
           createShockwave(player.x, player.y, '#ff0055', 300);
        } else {
           createShockwave(player.x, player.y, '#00f3ff', 200);
        }
      }

      // --- E Skill (Dash toward Mouse) ---
      if(key === 'e') {
        player.cd.e = s.eCd;
        let dashDist = 200;
        player.x += Math.cos(player.angle) * dashDist;
        player.y += Math.sin(player.angle) * dashDist;
        player.targetX = player.x; // Stop moving after dash
        player.targetY = player.y;
        createParticles(player.x, player.y, '#fff', 10);
      }

      // --- R Skill ---
      if(key === 'r') {
        player.cd.r = s.rCd;
        spawnFloatingText(player.x, player.y, "ULTIMATE!!!", player.color);
        if(selectedChar === 'powell') { 
          enemies.forEach(e => { e.hp -= 50; createParticles(e.x, e.y, '#00f3ff', 3); });
          ctx.fillStyle = 'rgba(0, 243, 255, 0.3)'; ctx.fillRect(0,0,width,height);
        } else if(selectedChar === 'trump') { 
          enemies = []; 
          createShockwave(width/2, height/2, '#ff0055', 1000);
        } else if(selectedChar === 'xi') { 
          player.hp = player.maxHp; enemies.forEach(e => e.hp -= 30);
        } else if(selectedChar === 'takaichi') { 
          for(let i=0; i<36; i++) shootBullet(i*0.2, 0, 10, '#bd34fe', 5, 8);
        } else if(selectedChar === 'macron') { 
          enemies.forEach(e => { e.x = e.x < width/2 ? -100 : width+100; });
        }
      }
    }

    function updateSkillUI() {
      ['q','w','e','r'].forEach(k => {
        const slot = document.getElementById(`skill-${k}`);
        const cd = player.cd[k];
        const overlay = slot.querySelector('.cooldown-overlay');
        const text = slot.querySelector('.cooldown-text');
        const stats = CHAR_STATS[selectedChar];
        const maxCd = k==='q'?stats.qCd : k==='w'?stats.wCd : k==='e'?stats.eCd : stats.rCd;

        if(cd > 0) {
          slot.classList.remove('ready'); slot.classList.add('cooldown');
          let pct = (cd/maxCd)*100;
          overlay.style.height = pct + '%';
          // Display remaining seconds
          text.innerText = Math.ceil(cd / 60);
        } else {
          slot.classList.add('ready'); slot.classList.remove('cooldown');
          overlay.style.height = '0%';
          text.innerText = "";
        }
      });
    }

    /* ====== ç²’å­ä¸è¾…åŠ© ====== */
    function spawnEnemy() {
      let side = Math.floor(Math.random()*4);
      let x, y;
      if(side===0) { x=Math.random()*width; y=-50; }
      else if(side===1) { x=width+50; y=Math.random()*height; }
      else if(side===2) { x=Math.random()*width; y=height+50; }
      else { x=-50; y=Math.random()*height; }

      let type = Math.random();
      // æ€ªç‰©å‡é€Ÿ 50%
      let e = { x, y, r:15, hp:3*difficultyMultiplier, speed:1*difficultyMultiplier, color:'#ff0055', value:50 };
      
      if(type > 0.7) e = { x, y, r:25, hp:10*difficultyMultiplier, speed:0.5*difficultyMultiplier, color:'#00ff9d', value:150 };
      if(type > 0.9) e = { x, y, r:35, hp:30*difficultyMultiplier, speed:0.25*difficultyMultiplier, color:'#bd34fe', value:500 };

      enemies.push(e);
    }

    function createParticles(x, y, color, count) {
      for(let i=0; i<count; i++) {
        particles.push({ x, y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, life:30, color, size:Math.random()*3 });
      }
    }
    function createShockwave(x, y, color, maxR=200) {
      particles.push({ x, y, r:10, maxR, color, life:20, type:'wave' });
    }
    function spawnFloatingText(x, y, text, color) {
      texts.push({ x, y, text, color, life:60 });
    }

    function updateParticles() {
      for(let i=particles.length-1; i>=0; i--) {
        let p = particles[i];
        if(p.type === 'wave') { p.r += (p.maxR - p.r) * 0.1; p.life--; } 
        else { p.x += p.vx; p.y += p.vy; p.life--; }
        if(p.life <= 0) particles.splice(i, 1);
      }
      for(let i=texts.length-1; i>=0; i--) {
        let t = texts[i]; t.y -= 1; t.life--;
        if(t.life <= 0) texts.splice(i, 1);
      }
    }

    function render() {
      ctx.fillStyle = 'rgba(5,5,10,0.3)'; ctx.fillRect(0,0,width,height); 

      // Grid
      ctx.strokeStyle = 'rgba(0,255,255,0.05)'; ctx.lineWidth = 1; ctx.beginPath();
      for(let i=0; i<width; i+=100) { ctx.moveTo(i,0); ctx.lineTo(i,height); }
      for(let i=0; i<height; i+=100) { ctx.moveTo(0,i); ctx.lineTo(width,i); }
      ctx.stroke();

      // Draw Move Marker
      if(player.moving) {
        ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(player.targetX-5, player.targetY-5); ctx.lineTo(player.targetX+5, player.targetY+5);
        ctx.moveTo(player.targetX+5, player.targetY-5); ctx.lineTo(player.targetX-5, player.targetY+5);
        ctx.stroke();
      }

      // Player
      ctx.save(); ctx.translate(player.x, player.y); ctx.rotate(player.angle);
      ctx.fillStyle = 'black'; ctx.strokeStyle = player.color; ctx.lineWidth = 2;
      ctx.shadowBlur = 15; ctx.shadowColor = player.color;
      ctx.beginPath(); ctx.moveTo(20,0); ctx.lineTo(-15,12); ctx.lineTo(-10,0); ctx.lineTo(-15,-12); ctx.closePath();
      ctx.fill(); ctx.stroke(); ctx.restore();

      enemies.forEach(e => {
        ctx.save(); ctx.translate(e.x, e.y);
        ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.strokeStyle = e.color; ctx.lineWidth = 2;
        ctx.shadowBlur = 10; ctx.shadowColor = e.color;
        ctx.beginPath();
        if(e.r === 15) { ctx.moveTo(15,0); ctx.lineTo(-10,10); ctx.lineTo(-10,-10); ctx.closePath(); } 
        else if(e.r === 25) { ctx.arc(0,0,e.r,0,Math.PI*2); } 
        else { ctx.rect(-20,-20,40,40); } 
        ctx.fill(); ctx.stroke(); ctx.restore();
      });

      bullets.forEach(b => {
        ctx.fillStyle = b.color; ctx.shadowBlur = 5; ctx.shadowColor = b.color;
        ctx.beginPath(); ctx.arc(b.x, b.y, b.r||4, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
      });

      particles.forEach(p => {
        if(p.type === 'wave') {
          ctx.strokeStyle = p.color; ctx.lineWidth = 5; ctx.globalAlpha = p.life/20;
          ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.stroke();
        } else {
          ctx.fillStyle = p.color; ctx.globalAlpha = p.life/30;
          ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
        }
        ctx.globalAlpha = 1;
      });

      ctx.font = "bold 20px 'Share Tech Mono'";
      texts.forEach(t => {
        ctx.fillStyle = t.color; ctx.fillText(t.text, t.x, t.y);
      });
    }

    function checkGameOver() {
      if(player.hp <= 0) {
        currentState = STATE.over;
        document.getElementById('final-score').innerText = '$' + Math.floor(score);
        document.getElementById('game-over').classList.remove('hidden');
      }
    }

  </script>
</body>
</html>
